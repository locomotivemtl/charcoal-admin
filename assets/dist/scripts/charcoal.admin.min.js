/*! @locomotivemtl/charcoal-admin 14-02-2019 */

$.fn.enable=function(){return this.each(function(){$(this).removeAttr("disabled").prop("disabled",!1)}),this},$.fn.disable=function(){return this.each(function(){$(this).attr("disabled",!0).prop("disabled",!0)}),this},$.fn.exists=function(){return $(this).length>0},RegExp.escape||(RegExp.escape=function(t){return t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(null==this)throw new TypeError('"this" is null or not defined');if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e=Object(this),i=e.length>>>0,o=arguments[1],r=0;r<i;){var n=e[r];if(t.call(o,n,r,e))return n;r++}}}),String.prototype.replacePairs||Object.defineProperty(String.prototype,"replaceMap",{value:function(t){var e=[];for(var i in t)i instanceof RegExp?this.replace(i,t[i]):e.push(RegExp.escape(i));return 0===e.length?this:(e=new RegExp(e.join("|"),"g"),this.replace(e,function(e){var i=t[e];if("function"==typeof i){var o=Array.prototype.slice.call(arguments,-2);return i(e,o[0],o[1])}return i}))}});var Charcoal=Charcoal||{};Charcoal.Admin=function(){"use strict";function t(){}var e,i,o,r,n,a,s,c,l=document.documentElement.getAttribute("locale"),p=document.documentElement.lang;return s={},e={base_url:null,admin_path:null},t.debug=function(t){if(arguments.length){if("boolean"!=typeof t)throw new TypeError("Must be a boolean, received "+typeof t);c=t}return c||!1},t.devMode=function(e){return t.debug(e)},t.locale=function(){return l},t.lang=function(t){return"string"==typeof t?p===t:p||"en"},t.defaultLang=function(t){return"string"==typeof t?"en"===t:"en"},t.setLang=function(t){if(null===t)p=document.documentElement.lang||"en";else{if("string"!=typeof t)throw new TypeError("Must be a language code, received "+typeof mode);p=t||document.documentElement.lang||"en"}return p},t.set_lang=t.setLang,t.set_data=function(t){e=$.extend(!0,e,t)},t.admin_url=function(t){return e.base_url+e.admin_path+"/"+("string"==typeof t?t:"")},t.base_url=function(){return e.base_url},t.manager=function(){return void 0===i&&(i=new Charcoal.Admin.ComponentManager),i},t.action=function(){return void 0===o&&(o=new Charcoal.Admin.ActionManager),o},t.queryParams=function(){var t={};return location.search.slice(1).split("&").forEach(function(e){(e=e.split("="))[1]&&(t[e[0]]=decodeURIComponent(e[1]||""))}),JSON.parse(JSON.stringify(t))},t.feedback=function(){return void 0===r&&(r=new Charcoal.Admin.Feedback),arguments.length&&r.push.apply(r,arguments),r},t.recaptcha=function(){return void 0===n&&(n=new Charcoal.Admin.ReCaptcha),n},t.get_object_name=function(t){var e=t.split("/");return(e=e.splice(2,e.length)).forEach(function(t,e,i){var o=t.split("-");o.length>1&&(o.forEach(function(t,e){o[e]=t.charAt(0).toUpperCase()+t.slice(1)}),t=o.join("_")),i[e]=t.charAt(0).toUpperCase()+t.slice(1)}),t=e.join("_")},t.parseNumber=function(t){return/^(\-|\+)?([0-9]+(\.[0-9]+)?|Infinity)$/.test(t)?Number(t):t},t.loadScript=function(t,e){this.store(t,function(e){$.ajax({url:t,dataType:"script",success:e.resolve,error:e.reject})}).then(e)},t.store=function(t,e,i){return s[t]||"function"==typeof e&&(s[t]=$.Deferred(function(t){e(t)}).promise()),"function"==typeof s[t]?s[t].done(i):s[t]},t.cache=function(){return void 0===a&&(a=new Charcoal.Admin.Cache),arguments.length&&a.purge.apply(a,arguments),a},t.parseJqXhrArgs=function(){var t={failed:!0,jqXHR:null,textStatus:"",errorThrown:"",response:null};return arguments[2]&&"string"===$.type(arguments[2])?(t.jqXHR=arguments[0]||null,t.textStatus=arguments[1]||null,t.errorThrown=arguments[2]||null,t.response=arguments[3]||t.jqXHR.responseJSON||null,"object"===$.type(t.response)?t.failed=!t.response.success:t.failed=!0):(t.response=arguments[0]||null,t.textStatus=arguments[1]||null,t.jqXHR=arguments[2]||null,t.errorThrown=null,null===t.response&&(t.response=t.jqXHR.responseJSON),"object"===$.type(t.response)?t.failed=!t.response.success:t.failed=!1),t},t.parseJqXhrResponse=function(t,e,i){var o={success:!1,feedbacks:[]};return t.responseJSON&&$.extend(o,t.responseJSON),0===o.feedbacks.length&&(o.message?o.feedbacks=Array.isArray(o.message)?o.message:[{msg:o.message}]:o.feedbacks=Array.isArray(i)?i:[{msg:i}]),o},t.resolveJqXhrFalsePositive=function(t,e,i){return t&&t.success&&!t.error?$.Deferred().resolve(t,e,i):t.message?$.Deferred().reject(i,"error",t.message):t.feedbacks?$.Deferred().reject(i,"error",t.feedbacks):$.Deferred().reject(i,"error","")},t.resolveSimpleJsonXhr=function(t,e,i,o){return t=t.then(this.resolveJqXhrFalsePositive),"function"==typeof e&&t.done(function(t,i,o){t=$.extend({success:!0,feedbacks:[]},t),e.call(o,t)}),"function"==typeof i&&t.fail(function(t,e,o){var r={success:!1,feedbacks:[]};t.responseJSON&&$.extend(r,t.responseJSON),0===r.feedbacks.length&&(r.message?r.feedbacks=Array.isArray(r.message)?r.message:[{msg:r.message}]:r.feedbacks=Array.isArray(o)?o:[{msg:o}]),r=$.extend({success:!1,feedbacks:[]},r),i.call(t,r)}),"function"==typeof o&&t.always(function(){o.call(t)}),t},t}(),function(t,e,i,o){"use strict";var r=t(i),n=".charcoal.cache",a={FLUSH:"flush"+n,FLUSHED:"flushed"+n,CLICK:"click"+n},s='[data-clear="cache"]',c='[data-purge="cache"]',l="clear",p="purge",d=null,h=null,u=null,_=null,m=!1,f=!1,y=function(){return t(this.init.bind(this)),this};y.prototype.init=function(){r.off(a.CLICK).on(a.CLICK,s,this.onClear.bind(this)).on(a.CLICK,c,this.onPurge.bind(this))},y.prototype.isFlushing=function(){return f},y.prototype.lastAction=function(){return h},y.prototype.lastCacheType=function(){return u},y.prototype.lastTarget=function(){return _},y.prototype.lastXhr=function(){return d},y.prototype.resolveType=function(t){return t.data("cacheType")||null},y.prototype.resolveKey=function(t){return t.data("cacheKey")||null},y.prototype.onClear=function(e){e.preventDefault();var i,o,r;m=!0,_=e.currentTarget,i=t(e.currentTarget),o=e.cacheType||this.resolveType(i),r=e.cacheKey||this.resolveKey(i),o&&this.clear(o,r),m=!1},y.prototype.onPurge=function(e){e.preventDefault();var i,o,r;m=!0,_=e.currentTarget,i=t(e.currentTarget),o=e.cacheType||this.resolveType(i),r=e.cacheKey||this.resolveKey(i),o&&this.purge(o,r),m=!1},y.prototype.clear=function(t,e){this.flush(l,t,e)},y.prototype.purge=function(t,e){this.flush(p,t,e)},y.prototype.flush=function(i,o,n){if(!0!==f){i!==l&&i!==p&&(i=p);var s,c,y;f=!0,h=i,u=o,d=null,!1===m&&(_=null),s=t.Event(a.FLUSH,{cacheManager:this,cacheAction:i,cacheType:u,relatedTarget:_}),r.trigger(s),s.isDefaultPrevented()||(y={},o&&(y.cache_type=o),n&&(y.cache_key=n),c={url:e.admin_url()+"system/cache/"+i,data:y,dataType:"json",context:this},d=t.post(c).then(g).done(b).fail(v).always(C))}};var g=function(e,i,o){if(!e||!e.success){var r={};return e.feedbacks&&t.isArray(e.feedbacks)&&(r=A(e).message),t.Deferred().rejectWith(this,[o,i,r])}return t.Deferred().resolveWith(this,[e,i,o])},b=function(t){window.console.debug(t);var e=A(t).message;BootstrapDialog.show({title:cacheL10n.title,message:e||cacheL10n.cleared,type:BootstrapDialog.TYPE_SUCCESS})},v=function(t,i,o){var r=t.responseJSON,n=A(r).message;!1===e.debug()&&(o=cacheL10n.failed),BootstrapDialog.show({title:cacheL10n.title,message:n||o||cacheL10n.failed,type:BootstrapDialog.TYPE_DANGER})},C=function(){f=!1;var e=t.Event(a.FLUSH,{cacheManager:this,cacheAction:h,cacheType:u,relatedTarget:_});r.trigger(e)},A=function(t){var e;return t&&t.feedbacks&&t.feedbacks.length&&(e=t.feedbacks.shift()),e||{}};e.Cache=y,e.cache()}(jQuery,Charcoal.Admin,document),function(t,e,i){"use strict";var o=t(e),r=t.Deferred(),n=1,a=function(){this.isReady=!1,this.components={};var i=this;t(e).ready(function(){i.render()})};a.prototype.add_property_input=function(t){this.add_component("property_inputs",t)},a.prototype.add_widget=function(t){this.add_component("widgets",t)},a.prototype.add_template=function(t){this.add_component("templates",t)},a.prototype.add_component=function(t,e){var i=Charcoal.Admin.get_object_name(e.type);"function"==typeof Charcoal.Admin[i]?(e.ident=i,this.components[t]=this.components[t]||[],this.components[t].push(e)):console.error("Was not able to store "+i+" in "+t+" sub-array")},a.prototype.get_property_input=function(t){return this.get_component("property_inputs",t)},a.prototype.get_widget=function(t){return this.get_component("widgets",t)},a.prototype.get_template=function(t){return this.get_component("templates",t)},a.prototype.get_component=function(t,e){if(!this.isReady)throw new Error("Components must be rendered.");if(t in this.components)return this.components[t].find(function(t){return t._id===e})},a.prototype.remove_component=function(t,e){if(!this.isReady)throw new Error("Components must be rendered.");t in this.components&&(this.components[t]=this.components[t].filter(function(t){return t._id!==e}))},a.prototype.ready=function(t){return r.promise().done(t),this},a.prototype.render=function(){var e=t.Event("render.charcoal.components",{relatedTarget:this});if(o.trigger(e),!e.isDefaultPrevented()){for(var i in this.components){var a=Charcoal;switch(i){case"widgets":a=Charcoal.Admin.Widget;break;case"property_inputs":a=Charcoal.Admin.Property;break;case"templates":a=Charcoal.Admin.Template}for(var s=0,c=this.components[i].length;s<c;s++){var l=this.components[i][s];if(l instanceof a)"function"==typeof l.destroy&&(l.destroy(),l.init());else try{var p=new Charcoal.Admin[l.ident](l);switch(this.components[i][s]=p,i){case"widgets":Charcoal.Admin.Widget.call(p,l),p.init()}}catch(t){console.error("Was not able to instanciate "+l.ident),console.error(t)}}}if(this.isReady)return this;if(this.isReady=!0,!(--n>0)){r.resolveWith(this);var d=t.Event("rendered.charcoal.components",{relatedTarget:this});return o.trigger(d),this}}},a.prototype.prepare_submit=function(){return this.prepare_inputs(),this.prepare_widgets(),!0},a.prototype.prepare_inputs=function(){var t=void 0!==this.components.property_inputs?this.components.property_inputs:[];if(!t.length)return!0;for(var e,i=t.length,o=0;o<i;o++)"function"==typeof(e=t[o]).validate&&e.validate();for(var r=0;r<i;r++)"function"==typeof(e=t[r]).save&&e.save();return!0},a.prototype.prepare_widgets=function(){var t=void 0!==this.components.widgets?this.components.widgets:[];if(!t.length)return!0;for(var e,i=t.length,o=0;o<i;o++)"function"==typeof(e=t[o]).validate&&e.validate();for(var r=0;r<i;r++)"function"==typeof(e=t[r]).save&&e.save();return!0},Charcoal.Admin.ComponentManager=a}(jQuery,document),function(t,e,i){"use strict";var o=t(e),r=function(){t(o).on("click",".js-action-button",function(t){this.handle_action(t)}.bind(this))};r.prototype.handle_action=function(e){e.preventDefault();var i=t(e.target).attr("href");this.xhr=t.ajax({type:"GET",url:i,processData:!1,contentType:!1}),this.xhr.then(t.proxy(this.request_done,this)).done(t.proxy(this.request_success,this)).fail(t.proxy(this.request_failed,this)).always(t.proxy(this.request_complete,this))},r.prototype.request_done=function(e,i,o){return e&&e.success||!e.feedbacks?t.Deferred().resolve(e,i,o):t.Deferred().reject(o,i,e.feedbacks)},r.prototype.request_success=function(t){t.feedbacks&&Charcoal.Admin.feedback(t.feedbacks)},r.prototype.request_failed=function(t,e,i){if(t.responseJSON&&t.responseJSON.feedbacks)Charcoal.Admin.feedback(t.responseJSON.feedbacks);else{var o=i||commonL10n.errorOccurred;Charcoal.Admin.feedback([{message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":"There was an error. Sorry for the inconvenience.","[[ errorThrown ]]":o}),level:"error"}])}},r.prototype.request_complete=function(){Charcoal.Admin.feedback().dispatch()},Charcoal.Admin.ActionManager=r,new Charcoal.Admin.ActionManager}(jQuery,document),function(t,e,i,o){"use strict";var r,n,a,s=[],c=function(){r=l.supported.slice(),n=t.extend({},l.definitions),a=t.extend({},l.aliases)},l={supported:["success","info","notice","warning","error","danger"],definitions:{success:{title:commonL10n.success,display:"notification",type:BootstrapDialog.TYPE_SUCCESS},notice:{title:commonL10n.notice,display:"notification",type:BootstrapDialog.TYPE_INFO,alias:["info"]},warning:{title:commonL10n.warning,display:"dialog",type:BootstrapDialog.TYPE_WARNING},error:{title:commonL10n.errorOccurred,display:"dialog",type:BootstrapDialog.TYPE_DANGER,alias:["danger"]}},aliases:{info:"notice",danger:"error"}},p=function(){return this.empty(),arguments.length&&this.push.apply(this,arguments),this};p.prototype.validContext=function(e){return"string"===t.type(e)},p.prototype.parseContext=function(e){if("undefined"===t.type(e))e="global";else{var i=t.type(e);if("string"!==i)throw new TypeError("Storage key must be a string, received "+i)}if(e in this.storage)return e;throw new TypeError("Invalid key, received "+e)},p.prototype.resolveAliases=function(e){if(-1===t.inArray(e,r))throw new TypeError('Unsupported feedback level, received "'+e+'". Must be one of: '+r.join(", "));for(var i,o=e,s=(e=n[e]).alias.length-1;s>=0;s--)i=e.alias[s],a[i]=o;return this},p.prototype.push=function(){var e=arguments[0],i=arguments;this.validContext(e)?i=s.slice.call(arguments,1):e="global";for(var o,r=0;r<i.length;r++)o=i[r],"array"!==t.type(o)?("object"!==t.type(o)||o instanceof d||(o=d.createFromObject(o)),o instanceof d&&this.storage.push(o)):this.push.apply(this,[e].concat(o));return this},p.prototype.getMessages=function(){return this.storage},p.prototype.countMessages=function(){return this.storage.length},p.prototype.hasMessages=function(){return this.countMessages()>0},p.prototype.getMessagesMap=function(){if(!this.hasMessages())return{};for(var t,e,i=this.getMessages(),o={},r=0;r<i.length;r++)(t=(e=i[r]).level())in o||(o[t]=[]),o[t].push(e);return o},p.prototype.availableLevels=function(){return r},p.prototype.levels=function(){return n},p.prototype.level=function(t){return n[t]||null},p.prototype.setLevels=function(e){var i=t.type(e);if("object"!==i)throw new TypeError("Level(s) must be an associative array, received "+i);for(var o in e)t.inArray(o,r)||r.push(o),"aliases"in e[o]&&(e[o].alias=e[o].aliases,delete e[o].aliases),n[o]=t.extend({},l.definitions[o]||{},e[o]),e[o].alias&&this.resolveAliases(o);return this},p.prototype.mergeLevels=function(e){var i=t.type(e);if("object"!==i)throw new TypeError("Level(s) must be an associative array, received "+i);for(var o in e)t.inArray(o,r)||r.push(o),"aliases"in e[o]&&(e[o].alias=e[o].aliases,delete e[o].aliases),n[o]=t.extend({},l.definitions[o]||{},n[o]||{},e[o]),e[o].alias&&this.resolveAliases(o);return this},p.prototype.add_action=function(t){this.actions.push(t)},p.prototype.dispatch=function(){if(!this.hasMessages())return this;var t,e,i,o=this.getMessagesMap();for(t in o){if(e=this.level(t),i=[],this.actions.length)for(var r,n=0;n<this.actions.length;n++)r=this.actions[n],i.push({label:r.label,action:r.callback});var a={title:e.title,message:'<p class="mb-0">'+o[t].join('</p><p class="mb-0 mt-3">')+"</p>",level:t,type:e.type,buttons:i};switch(e.display){case"notification":a.dismissible=0===i.length,new h(a);break;case"dialog":default:BootstrapDialog.show(a)}}return this.empty(),this},p.prototype.empty=function(){c(),this.actions=[],this.storage=[]};var d=function(t,i){if(e.feedback(),!this.validLevel(t))throw new TypeError("Feedback level required. Must be one of: "+r.join(", "));return this.setLevel(t),this.validMessage(i)&&this.setMessage(i),this};d.createFromObject=function(t){var e=t.level||null,i=t.message||null;return e||i?new d(e,i):null},d.prototype={toString:function(){return this.message()},level:function(){return this._level||null},setLevel:function(e){var i=t.type(e);if("string"!==i)throw new TypeError("Feedback level must be a string, received "+i);if(-1===t.inArray(e,r))throw new TypeError('Unsupported feedback level, received "'+e+'". Must be one of: '+r.join(", "));return e in a&&(e=a[e]),this._level=e,this},validLevel:function(e){return"string"===t.type(e)&&t.inArray(e,r)>-1},message:function(){return this._message||null},setMessage:function(e){var i=t.type(e);if("string"!==i)throw new TypeError("Feedback message must be a string, received "+i);return this._message=e,this},validMessage:function(e){return"string"===t.type(e)}};var h=function(e){var i=t.type(e);if("object"!==i)throw new TypeError("Notification config must be an associative array, received "+i);if(this.validMessage(e.message)&&this.setMessage(e.message),this.config=t.extend({},{id:BootstrapDialog.newGuid(),delay:3200},e),this.$elem=t('<article class="c-notifications_item alert fade show" role="alert"></article>'),this.$elem.prop("id",this.config.id),this.$elem.addClass("alert-"+this.config.type.replace("type-","")),this.config.dismissible){this.$elem.addClass("alert-dismissible");var o=t('<button type="button" class="close" data-dismiss="alert" aria-label="'+commonL10n.close+'"></button>');o.append('<span aria-hidden="true">&times;</span>'),this.$elem.append(o)}if(this.config.message){var r=t('<div class="alert-body"></div>');r.html("").append(this.config.message),this.$elem.append(r)}return this.$elem.appendTo(".c-notifications").addClass("show"),this.$elem.on("mouseover.charcoal.feedback",{notification:this},function(t){window.clearTimeout(t.data.notification.closeTimer)}),this.$elem.on("mouseout.charcoal.feedback",{notification:this},function(t){var e=t.data.notification;e.closeTimer=window.setTimeout(function(){e.$elem.alert("close")},e.config.delay)}),this.$elem.on("closed.bs.alert",{notification:this},function(t){t.data.notification.$elem.off(".charcoal.feedback"),window.clearTimeout(t.data.notification.closeTimer)}),this.closeTimer=window.setTimeout(t.proxy(function(){this.$elem.alert("close")},this),this.config.delay),this};h.prototype=Object.create(d.prototype),h.prototype.constructor=h,h.prototype.parent=d.prototype,c(),e.Feedback=p,e.FeedbackEntry=d}(jQuery,Charcoal.Admin,document),function(t,e,i,o){"use strict";var r=function(){return this};r.prototype.getApi=function(){return i.grecaptcha||null},r.prototype.hasApi=function(){return void 0!==i.grecaptcha},r.prototype.hasWidget=function(e,i){if(!1===this.hasApi())return!1;i=i||".g-recaptcha";var o=t(e);return o.is(i)||o.find(i).exists()},r.prototype.hasInvisibleWidget=function(e,i){if(!1===this.hasApi())return!1;i=i||".g-recaptcha";var o=t(e),r=o.is(i)?o:o.find(i);return r.exists()&&"invisible"===r.data("size")},e.ReCaptcha=r}(jQuery,Charcoal.Admin,window),Charcoal.Admin.Widget=function(t){return this._element=void 0,this._id=void 0,this._type=void 0,this._opts=void 0,t?("string"==typeof t.id&&(this.set_element($("#"+t.id)),this.set_id(t.id),this.widget_id=t.widget_id||t.id),"string"==typeof t.type&&(this.set_type(t.type),this.widget_type=t.widget_type||t.type),this.set_opts(t),this):this},Charcoal.Admin.Widget.prototype.set_opts=function(t){return this._opts=t,this},Charcoal.Admin.Widget.prototype.add_opts=function(t,e){return"string"==typeof t&&(this._opts[t]=e),this},Charcoal.Admin.Widget.prototype.opts=function(t){return"string"==typeof t?void 0!==this._opts[t]&&this._opts[t]:this._opts},Charcoal.Admin.Widget.prototype.init=function(){return this},Charcoal.Admin.Widget.prototype.set_id=function(t){this._id=t},Charcoal.Admin.Widget.prototype.id=function(){return this._id},Charcoal.Admin.Widget.prototype.set_type=function(t){this._type=t},Charcoal.Admin.Widget.prototype.type=function(){return this._type},Charcoal.Admin.Widget.prototype.set_element=function(t){return this._element=t,this},Charcoal.Admin.Widget.prototype.element=function(){return this._element},Charcoal.Admin.Widget.prototype.widget_options=function(){return this.opts()},Charcoal.Admin.Widget.prototype.widget_type=function(){return this.type()},Charcoal.Admin.Widget.prototype.save=function(){return!0},Charcoal.Admin.Widget.prototype.anim_out=function(t){return"function"!=typeof t&&(t=function(){}),this.element().fadeOut(400,t),this},Charcoal.Admin.Widget.prototype.reload=function(t,e){var i=this,o=Charcoal.Admin.admin_url()+"widget/load",r={widget_type:i.widget_type||i.type(),widget_options:i.widget_options(),with_data:e};this.reloadXHR&&this.reloadXHR.abort(),this.reloadXHR=$.ajax({type:"POST",url:o,data:JSON.stringify(r),dataType:"json",contentType:"application/json",success:function(o){if("string"==typeof o.widget_id){var r=o.widget_id;i.set_id(r),i.add_opts("id",r),i.add_opts("widget_id",r),e&&i.add_opts("data",o.widget_data),i.widget_id=r,i.anim_out(function(){i.element().replaceWith(o.widget_html),i.set_element($("#"+i.id())),i.element().hide().fadeIn(),i.init(),"function"==typeof t&&t.call(i,o)})}}})},Charcoal.Admin.Widget.prototype.dialog=function(t,e){var i=t.title||"",o=t.type||BootstrapDialog.TYPE_DEFAULT,r=t.size||BootstrapDialog.SIZE_NORMAL,n=t.cssClass||"",a=t.showHeader||!0,s=t.showFooter||!0,c=t.dialog_options||{};delete t.title,delete t.type,delete t.size,delete t.cssClass,delete t.dialog_options;var l={title:i,type:o,size:r,cssClass:n,nl2br:!1,showHeader:a,showFooter:s},p=$.extend({},l,c),d='<div class="alert alert-{type}" role="alert">{text}</div>';return p.onshown=function(i){var o=Charcoal.Admin.admin_url()+"widget/load",r=t;$.ajax({method:"POST",url:o,data:r,dataType:"json"}).then(function(t,e,i){return t&&t.success?$.Deferred().resolve(t,e,i):t.feedbacks?$.Deferred().reject(i,e,t.feedbacks):$.Deferred().reject(i,e,widgetL10n.loadingFailed)}).done(function(t){i.setMessage(t.widget_html),"function"==typeof e&&e(t),$('[data-toggle="tooltip"]',i.getModalBody()).tooltip()}).fail(function(t,e,o){i.setType(BootstrapDialog.TYPE_DANGER),i.setMessage(widgetL10n.loadingFailed);var r="";"string"===$.type(o)&&t.responseJSON&&t.responseJSON.feedbacks&&(o=t.responseJSON.feedbacks),$.isArray(o)?$.each(o,function(t,e){e.message&&("error"===e.level&&(e.level="danger"),r+=d.replaceMap({"{type}":e.level,"{text}":e.message}))}):"string"===$.type(o)&&(r=d.replaceMap({"{type}":"danger","{text}":o})),r&&i.setMessage(r),$('[data-toggle="tooltip"]',i.getModalBody()).tooltip()}),Charcoal.Admin.manager().render()},p.message=function(t){var e=$(d.replaceMap({"{type}":"warning","{text}":widgetL10n.loading}));return a||t.getModalHeader().addClass("d-none"),s||t.getModalFooter().addClass("d-none"),t.getModalBody().on("click.charcoal.bs.dialog",'[data-dismiss="dialog"]',{dialog:t},function(t){t.data.dialog.close()}),e},new BootstrapDialog.show(p)},Charcoal.Admin.Widget.prototype.confirm=function(t,e,i){var o={type:BootstrapDialog.TYPE_DANGER,callback:function(t){t?"function"==typeof e&&e():"function"==typeof i&&i()}},r=$.extend(o,t);BootstrapDialog.confirm(r)};var globalXHR={};Charcoal.Admin.Widget_Attachment=function(){this.glyphs={embed:"glyphicon-blackboard",video:"glyphicon-film",image:"glyphicon-picture",file:"glyphicon-file",link:"glyphicon-link",text:"glyphicon-font",gallery:"glyphicon-duplicate",container:"glyphicon-list",accordion:"glyphicon-list"};var t=this;return $(document).on("switch_language.charcoal",function(){var e=t.opts();e.widget_options.lang=Charcoal.Admin.lang(),t.set_opts(e),t.reload()}),this.dirty=!1,this},Charcoal.Admin.Widget_Attachment.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Attachment.prototype.constructor=Charcoal.Admin.Widget_Attachment,Charcoal.Admin.Widget_Attachment.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Attachment.prototype.init=function(){var t=this.element().find(".js-attachment-sortable > .js-grid-container");return t.length&&(this.element().on("hidden.bs.collapse",'[data-toggle="collapse"]',function(){t.sortable("refreshPositions")}),t.sortable({handle:'[draggable="true"]',placeholder:"card c-attachments_row -placeholder",start:function(t,e){e.item.children(".card-header").find('[data-toggle="collapse"]').hasClass("collapsed")||e.item.children(".collapse").collapse("hide")}}).disableSelection()),this.listeners(),this},Charcoal.Admin.Widget_Attachment.prototype.is_dirty=function(){return this.dirty},Charcoal.Admin.Widget_Attachment.prototype.set_dirty_state=function(t){return this.dirty=t,this},Charcoal.Admin.Widget_Attachment.prototype.listeners=function(){var t=this,e=this.element().find(".c-attachments_container > .js-grid-container");this.element().off("click").on("click.charcoal.attachments",".js-attachments-collapse",function(){var t=e.children(".js-attachment");e.hasClass("js-attachment-preview-only")&&t.find(".card-header.sr-only").removeClass("sr-only").addClass("sr-only-off"),t.find(".collapse.show").collapse("hide")}).on("click.charcoal.attachments",".js-attachments-expand",function(){var t=e.children(".js-attachment");e.hasClass("js-attachment-preview-only")&&t.find(".card-header.sr-only-off").removeClass("sr-only-off").addClass("sr-only"),t.find(".collapse:not(.show)").collapse("show")}).on("click.charcoal.attachments",".js-add-attachment",function(e){e.preventDefault();t.opts();var i=$(this),o=i.data("type");if(!o)return!1;var r=i.data("id");if(r)t.add({id:r,type:o}),t.join(function(){t.reload()});else{var n={title:i.data("title")||attachmentWidgetL10n.editObject,formIdent:i.data("form-ident"),skipForm:i.data("skip-form")};t.create_attachment(o,0,null,n,function(e){e.success&&(e.obj.id=e.obj_id,t.add(e.obj),t.opts(),t.join(function(){t.reload()}))})}}).on("click.charcoal.attachments",".js-attachment-actions a",function(e){var i=$(this);if(i.data("action")){e.preventDefault();switch(i.data("action")){case"edit":var o=i.data("type"),r=i.data("id");if(!o||!r)break;var n={title:i.data("title")||attachmentWidgetL10n.editObject,formIdent:i.data("form-ident")};t.create_attachment(o,r,null,n,function(e){e.success&&t.reload()});break;case"delete":if(!i.data("id"))break;t.confirm({title:attachmentWidgetL10n.confirmRemoval,message:commonL10n.confirmAction,btnOKLabel:commonL10n.removeObject,callback:function(e){e&&t.remove_join(i.data("id"),function(){t.reload()})}});break;case"add-object":var a=i.data("title"),s=i.data("attachment"),c=i.data("type"),l={id:i.data("id"),type:c,group:i.data("group")};n={title:a,formIdent:i.data("form-ident"),skipForm:i.data("skip-form")},t.create_attachment(s,0,l,n,function(e){e.success&&t.add_object_to_container({id:e.obj_id,type:e.obj.type},l)})}}})},Charcoal.Admin.Widget_Attachment.prototype.select_attachment=function(t){if(!t.data("id")||!t.data("type"))return this},Charcoal.Admin.Widget_Attachment.prototype.create_attachment=function(t,e,i,o,r){e||(e=0),o||(o={});if(!i){var n=this.opts();i={obj_type:n.data.obj_type,obj_id:n.data.obj_id,group:n.data.group}}if(o.skipForm)return this.xhr=$.ajax({type:"POST",url:"object/save",data:{obj_type:t,obj_id:e,pivot:i}}),this.xhr.done(function(t){t.feedbacks&&Charcoal.Admin.feedback(t.feedbacks).dispatch(),r(t)}),void Charcoal.Admin.manager().render();var a={size:BootstrapDialog.SIZE_WIDE,cssClass:"-quick-form",widget_type:"charcoal/admin/widget/quick-form",widget_options:{obj_type:t,obj_id:e,form_ident:o.formIdent||null,form_data:{pivot:i}}},s=$.extend({},a,o,{}),c=this.dialog(s,function(i){if(i.success){if(!i.widget_id)return!1;Charcoal.Admin.manager().add_widget({id:i.widget_id,type:"charcoal/admin/widget/quick-form",data:{obj_type:t},obj_id:e,save_callback:function(t){r(t),c.close()}}),Charcoal.Admin.manager().render()}})},Charcoal.Admin.Widget_Attachment.prototype.add_object_to_container=function(t,e,i){var o=this,r={obj_type:e.type,obj_id:e.id,attachments:[{attachment_id:t.id,attachment_type:t.type,position:0}],group:i||e.group||""};$.post("add-join",r,function(){o.reload()},"json")},Charcoal.Admin.Widget_Attachment.prototype.add=function(t){if(!t)return!1;this.set_dirty_state(!0);var e=this.element().find(".js-attachment-template").clone();return e.find(".js-attachment").data("id",t.id).data("type",t.type),this.element().find(".c-attachments_container > .js-grid-container").append(e),this},Charcoal.Admin.Widget_Attachment.prototype.save=function(){if(this.is_dirty())return!1;this.join()},Charcoal.Admin.Widget_Attachment.prototype.join=function(t){if($("#"+this.element().attr("id")).length){var e=this,i=e.opts(),o={obj_type:i.data.obj_type,obj_id:i.data.obj_id,attachments:[],group:i.data.group};this.element().find(".c-attachments_container").find(".js-attachment").each(function(t){var e=$(this),i=e.data("id"),r=e.data("type");o.attachments.push({attachment_id:i,attachment_type:r,position:t})}),void 0!==globalXHR[i.data.group]&&globalXHR[i.data.group].abort(),globalXHR[i.data.group]=$.post("join",o,function(){"function"==typeof t&&t(),e.set_dirty_state(!1),delete globalXHR[i.data.group]},"json")}},Charcoal.Admin.Widget_Attachment.prototype.remove_join=function(t,e){if(!t)return!1;var i=this,o=i.opts(),r={obj_type:o.data.obj_type,obj_id:o.data.obj_id,attachment_id:t,group:o.data.group};$.post("remove-join",r,function(){"function"==typeof e&&e(),i.set_dirty_state(!1)},"json")},Charcoal.Admin.Widget_Attachment.prototype.widget_options=function(){return this.opts("widget_options")},Charcoal.Admin.Widget_Card_Collection=function(){this.obj_type=null,this.widget_id=null,this.table_selector=null,this.filters={},this.orders={},this.pagination={page:1,num_per_page:50},this.list_actions={},this.object_actions={},this.template=this.properties=this.properties_options=void 0},Charcoal.Admin.Widget_Card_Collection.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Card_Collection.prototype.constructor=Charcoal.Admin.Widget_Card_Collection,Charcoal.Admin.Widget_Card_Collection.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Card_Collection.prototype.init=function(){this.set_properties().bind_events()},Charcoal.Admin.Widget_Card_Collection.prototype.set_properties=function(){var t=this.opts();switch(this.obj_type=t.data.obj_type||this.obj_type,this.widget_id=t.id||this.widget_id,this.table_selector="#"+this.widget_id,this.template=t.data.template||this.template,this.properties=t.data.properties||this.properties,this.properties_options=t.data.properties_options||this.properties_options,this.filters=t.data.filters||this.filters,this.orders=t.data.orders||this.orders,this.pagination=t.data.pagination||this.pagination,this.list_actions=t.data.list_actions||this.list_actions,this.object_actions=t.data.object_actions||this.object_actions,this.card_template=t.data.card_template||this.card_template,this.num_columns=t.data.num_columns||this.num_columns,this.collection_ident=t.data.collection_ident||"default",t.lang){case"fr":moment.locale("fr-ca");break;case"en":moment.locale("en-ca");break;default:moment.locale(t.lang)}return $(".js-last-time",this.table_selector).each(function(){$(this).html(moment.unix($(this).attr("data-time")).fromNow())}),this},Charcoal.Admin.Widget_Card_Collection.prototype.bind_events=function(){var t=this,e=$(".js-sortable",t.table_selector);e.length>0&&new window.Sortable.default(e.get(),{draggable:".js-sortable-item",handle:".js-sortable-handle",mirror:{constrainDimensions:!0}}).on("mirror:create",function(t){var e=t.originalSource.querySelectorAll(":scope .js-sortable-item"),i=t.source.querySelectorAll(":scope .js-sortable-item");e.forEach(function(t,e){i[e].style.width=t.offsetWidth+"px"})}).on("sortable:stop",function(e){if(e.oldIndex!==e.newIndex){var i=Array.from(e.newContainer.querySelectorAll(":scope > .js-sortable-item")).map(function(t){return t.classList.contains("draggable-mirror")||t.classList.contains("draggable--original")?"":t.getAttribute("data-id")}).filter(function(t){return""!==t});$.ajax({method:"POST",url:Charcoal.Admin.admin_url()+"object/reorder",data:{obj_type:t.obj_type,obj_orders:i,starting_order:1},dataType:"json"}).done(function(t){console.debug(t),t.feedbacks&&Charcoal.Admin.feedback(t.feedbacks).dispatch()})}}),$(".js-jump-page-form",t.table_selector).on("submit",function(e){e.preventDefault();var i=$(this),o=parseInt(i.find("input").val());o&&(t.pagination.page=o,t.reload())}),$(".js-page-switch",t.table_selector).on("click",function(e){e.preventDefault();var i=$(this).data("page-num");console.log(i),t.pagination.page=i,t.reload()})},Charcoal.Admin.Widget_Card_Collection.prototype.add_filter=function(t){var e=this.get_filters();return null===e&&(e={}),e=$.extend(e,t),this.set_filters(e),this},Charcoal.Admin.Widget_Card_Collection.prototype.set_filters=function(t){this.filters=t},Charcoal.Admin.Widget_Card_Collection.prototype.get_filters=function(){return this.filters},Charcoal.Admin.Widget_Card_Collection.prototype.widget_options=function(){return{obj_type:this.obj_type,template:this.template,collection_ident:this.collection_ident,card_template:this.card_template,num_columns:this.num_columns,collection_config:{properties:this.properties,properties_options:this.properties_options,filters:this.filters,orders:this.orders,pagination:this.pagination,list_actions:this.list_actions,object_actions:this.object_actions}}},Charcoal.Admin.Widget_Card_Collection.prototype.reload=function(t){return Charcoal.Admin.Widget.prototype.reload.call(this,t),this},Charcoal.Admin.Widget_Form=function(t){this.widget_type="charcoal/admin/widget/form",this.widget_id=null,this.obj_type=null,this.obj_id=null,this.save_action="object/save",this.update_action="object/update",this.form_selector=null,this.form_working=!1,this.submitted_via=null,this.suppress_feedback=!1,this.is_new_object=!1,this.xhr=null,this.update_tab_ident();var e=$("[data-lang]:not(.d-none)").data("lang");e&&Charcoal.Admin.setLang(e),this.set_properties(t).bind_events()},Charcoal.Admin.Widget_Form.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Form.prototype.constructor=Charcoal.Admin.Widget_Form,Charcoal.Admin.Widget_Form.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Form.prototype.set_properties=function(t){return this.widget_id=t.id||this.widget_id,this.obj_type=t.data.obj_type||this.obj_type,this.obj_id=Charcoal.Admin.parseNumber(t.data.obj_id||this.obj_id),this.form_selector=t.data.form_selector||this.form_selector,this.isTab=t.data.tab,this.group_conditions=t.data.group_conditions,this.$form=$(this.form_selector),this},Charcoal.Admin.Widget_Form.prototype.init=function(){},Charcoal.Admin.Widget_Form.prototype.widget_options=function(){var t=this.parent.widget_options.call(this);return $.extend({},t,this.opts("data"))},Charcoal.Admin.Widget_Form.prototype.bind_events=function(){var t=this,e=$(".js-sidebar-widget",this.form_selector);$(t.form_selector).on("submit.charcoal.form",function(e){e.preventDefault(),t.submit_form(this)}).find(":submit").on("click.charcoal.form",function(){t.submitted_via=this}),$(".js-obj-delete",e).on("click.charcoal.form",function(e){e.preventDefault(),t.delete_object(this)}),$(".js-reset-form",e).on("click.charcoal.form",function(e){e.preventDefault(),$(t.form_selector)[0].reset()}),$(".js-obj-revision",e).on("click.charcoal.form",function(e){e.preventDefault(),t.view_revision(this)}),$(".js-obj-list",e).on("click.charcoal.form",function(e){e.preventDefault(),t.back_to_list(this)}),$(".js-lang-switch button",e).on("click.charcoal.form",function(e){e.preventDefault();var i=$(this).attr("data-lang-switch");t.switch_language(i)}),window.onpopstate=function(){t.update_tab_ident()},this.parse_group_conditions(),t.isTab&&$(this.form_selector).on("shown.bs.tab",".js-group-tabs",function(t){var e=$(t.target),i=[],o=Charcoal.Admin.queryParams();if(void 0===o.tab_ident||e.data("tab-ident")!==o.tab_ident){o.tab_ident=e.data("tab-ident");for(var r in o)i.push(r+"="+o[r]);history.pushState("","",window.location.pathname+"?"+i.join("&"))}})},Charcoal.Admin.Widget_Form.prototype.parse_group_conditions=function(){var t=this;$.each(this.group_conditions,function(e,i){var o=t.validate_group_conditions(e);o||t.toggle_conditional_group(e,o,!1),$.each(i,function(i,o){$(t.form_selector).on("change.charcoal.form","#"+o.input_id,{condition_target:e},function(e){var i=t.validate_group_conditions(e.data.condition_target);t.toggle_conditional_group(e.data.condition_target,i)})})})},Charcoal.Admin.Widget_Form.prototype.validate_group_conditions=function(t){var e=this.group_conditions[t],i=this,o=!0;return $.each(e,function(t,e){var r=i.$form.find("#"+e.input_id),n=i.get_input_value(r);switch(JSON.stringify(e.operator)){case'"!=="':case'"!="':case'"!"':case'"not"':if(n===e.value)return void(o=!1);break;default:case'"==="':case'"=="':case'"="':case'"is"':if(n!==e.value)return void(o=!1)}}),o},Charcoal.Admin.Widget_Form.prototype.toggle_conditional_group=function(t,e,i){var o=this.$form.find("#form_group_"+t),r=o.find("select, input, textarea");i=i||!0;var n=function(){r.each(function(){$(this).attr("disabled",!e)})};e?i?o.slideDown({easing:"easeInOutQuad",start:n}):o.show(0,n):i?o.slideUp({easing:"easeInOutQuad",complete:n}):o.hide(0,n)},Charcoal.Admin.Widget_Form.prototype.get_input_value=function(t){if("disabled"===t.attr("disabled"))return null;var e;switch(t.attr("type")){case"select":e=t.find(":selected").val();break;case"checkbox":e=t.is(":checked");break;default:e=t.val()}return e},Charcoal.Admin.Widget_Form.prototype.update_tab_ident=function(){var t=Charcoal.Admin.queryParams();"tab_ident"in t&&$('.js-group-tabs[data-tab-ident="'+t.tab_ident+'"]').tab("show")},Charcoal.Admin.Widget_Form.prototype.submit_form=function(t){if(!this.form_working){this.form_working=!0,this.is_new_object=!this.obj_id;var e,i,o;if(i=$(t),(e=i.find('[type="submit"]')).prop("disabled"))return!1;Charcoal.Admin.manager().prepare_submit(),o=new FormData(t),this.submitted_via&&this.submitted_via.name&&o.append(this.submitted_via.name,this.submitted_via.value||!0),this.disable_form(i,e),this.xhr=$.ajax({type:"POST",url:this.request_url(),data:o,dataType:"json",processData:!1,contentType:!1}),this.xhr.then($.proxy(this.request_done,this,i,e)).done($.proxy(this.request_success,this,i,e)).fail($.proxy(this.request_failed,this,i,e)).always($.proxy(this.request_complete,this,i,e))}},Charcoal.Admin.Widget_Form.prototype.request_done=function(t,e,i,o,r){return i&&i.success?$.Deferred().resolve(i,o,r):i.feedbacks?$.Deferred().reject(r,o,i.feedbacks):$.Deferred().reject(r,o,commonL10n.errorOccurred)},Charcoal.Admin.Widget_Form.prototype.request_success=function(t,e,i){if(i.feedbacks&&Charcoal.Admin.feedback(i.feedbacks),i.next_url&&Charcoal.Admin.feedback().add_action({label:commonL10n.continue,callback:function(){window.location.href=Charcoal.Admin.admin_url()+i.next_url}}),this.is_new_object)if(this.suppress_feedback=!0,i.next_url)window.location.href=Charcoal.Admin.admin_url()+i.next_url;else{var o=new URLSearchParams(window.location.search);window.location.href=Charcoal.Admin.admin_url()+"object/edit?"+(o.has("main_menu")?"main_menu="+o.get("main_menu")+"&":"")+(o.has("secondary_menu")?"secondary_menu="+o.get("secondary_menu")+"&":"")+"obj_type="+this.obj_type+"&obj_id="+i.obj_id}},Charcoal.Admin.Widget_Form.prototype.request_failed=function(t,e,i,o,r){if(i.responseJSON&&i.responseJSON.feedbacks)Charcoal.Admin.feedback(i.responseJSON.feedbacks);else{var n=this.is_new_object?formWidgetL10n.createFailed:formWidgetL10n.updateFailed,a=r||commonL10n.errorOccurred;Charcoal.Admin.feedback([{message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":n,"[[ errorThrown ]]":a}),level:"error"}])}},Charcoal.Admin.Widget_Form.prototype.request_complete=function(t,e){this.suppress_feedback||(Charcoal.Admin.feedback().dispatch(),this.enable_form(t,e)),this.submitted_via=null,this.form_working=this.is_new_object=this.suppress_feedback=!1},Charcoal.Admin.Widget_Form.prototype.disable_form=function(t,e){return t&&t.prop("disabled",!0),e&&e.prop("disabled",!0),this.submitted_via&&this.disable_button(this.submitted_via),this},Charcoal.Admin.Widget_Form.prototype.enable_form=function(t,e){return t&&t.prop("disabled",!1),e&&e.prop("disabled",!1),this.submitted_via&&this.enable_button(this.submitted_via),this},Charcoal.Admin.Widget_Form.prototype.disable_button=function(t){return t instanceof jQuery||(t=$(t)),t.prop("disabled",!0).children(".fa").removeClass("d-none").next(".btn-label").addClass("sr-only"),this},Charcoal.Admin.Widget_Form.prototype.enable_button=function(t){return t instanceof jQuery||(t=$(t)),t.prop("disabled",!1).children(".fa").addClass("d-none").next(".btn-label").removeClass("sr-only"),this},Charcoal.Admin.Widget_Form.prototype.request_url=function(){return this.is_new_object?Charcoal.Admin.admin_url()+this.save_action:Charcoal.Admin.admin_url()+this.update_action},Charcoal.Admin.Widget_Form.prototype.view_revision=function(){var t=this.obj_type,e=this.obj_id,i={size:BootstrapDialog.SIZE_WIDE,title:formWidgetL10n.revisions,widget_type:"charcoal/admin/widget/object-revisions",widget_options:{obj_type:t,obj_id:e}},o=$.extend({},i);this.dialog(o,function(i){if(i.success){if(!i.widget_id)return!1;Charcoal.Admin.manager().add_widget({id:i.widget_id,type:"charcoal/admin/widget/object-revisions",obj_type:t,obj_id:e}),Charcoal.Admin.manager().render()}})},Charcoal.Admin.Widget_Form.prototype.back_to_list=function(){window.location.href="object/collection?obj_type="+this.obj_type},Charcoal.Admin.Widget_Form.prototype.delete_object=function(){var t=this,e=new URLSearchParams(window.location.search),i=Charcoal.Admin.admin_url()+"object/collection?"+(e.has("main_menu")?"main_menu="+e.get("main_menu")+"&":"")+(e.has("secondary_menu")?"secondary_menu="+e.get("secondary_menu")+"&":"")+"obj_type="+this.obj_type;BootstrapDialog.confirm({title:formWidgetL10n.confirmDeletion,type:BootstrapDialog.TYPE_DANGER,message:$("<p>"+commonL10n.confirmAction+'</p><p class="mb-0">'+commonL10n.cantUndo+"</p>"),btnOKLabel:commonL10n.delete,callback:function(e){if(e){var o=Charcoal.Admin.admin_url()+"object/delete",r={obj_type:t.obj_type,obj_id:t.obj_id};$.ajax({method:"POST",url:o,data:r,dataType:"json"}).done(function(t){t.success?window.location.href=i:window.alert(formWidgetL10n.deleteFailed)})}}})},Charcoal.Admin.Widget_Form.prototype.reload=function(t){return Charcoal.Admin.Widget.prototype.reload.call(this,function(e,i){"function"==typeof t&&t.call(e,i),Charcoal.Admin.manager().render()},!0),this},Charcoal.Admin.Widget_Form.prototype.switch_language=function(t){Charcoal.Admin.lang()!==t&&(Charcoal.Admin.setLang(t),$("[data-lang][data-lang!="+t+"]").addClass("d-none"),$("[data-lang][data-lang="+t+"]").removeClass("d-none"),$("[data-lang-switch][data-lang-switch!="+t+"]").removeClass("btn-primary").addClass("btn-outline-primary"),$("[data-lang-switch][data-lang-switch="+t+"]").removeClass("btn-outline-primary").addClass("btn-primary"),$(document).triggerHandler({type:"switch_language.charcoal"}))},Charcoal.Admin.Widget_Map=function(){return this._controller=void 0,this.widget_type="charcoal/admin/widget/map",this},Charcoal.Admin.Widget_Map.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Map.prototype.constructor=Charcoal.Admin.Widget_Map,Charcoal.Admin.Widget_Map.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Map.prototype.init=function(){var t=this;return"undefined"==typeof google?(window._tmp_google_onload_function=function(){t.activate_map()},$.getScript("https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&language=fr&callback=_tmp_google_onload_function",function(){})):t.activate_map(),this},Charcoal.Admin.Widget_Map.prototype.activate_map=function(){var t={default_styles:{strokeColor:"#000000",strokeOpacity:.8,strokeWeight:3,fillColor:"#ffffff",fillOpacity:.35,hover:{strokeColor:"#000000",strokeOpacity:1,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.5},focused:{fillOpacity:.8}},use_clusterer:!1,map:{center:{x:this.opts("coords")[0],y:this.opts("coords")[1]},zoom:14,mapType:"roadmap",coordsType:"inpage",map_mode:"default"},places:{first:{type:"marker",coords:this.coords()}}};this._controller=new window.BB.gmap.controller(this.element().find(".js-map-maker-map").get(0),t),this.controller().set_styles([{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]}]),this.controller().remove_focus(),this.controller().init()},Charcoal.Admin.Widget_Map.prototype.controller=function(){return this._controller},Charcoal.Admin.Widget_Map.prototype.coords=function(){return this.opts("coords")},Charcoal.Admin.Widget_Object_Revisions=function(t){return this.widget_type="charcoal/admin/widget/object-revisions",this.extra_form_data=t.extra_form_data||{},this.xhr=null,this.obj_id=Charcoal.Admin.parseNumber(t.obj_id)||0,this.obj_type=t.obj_type,this},Charcoal.Admin.Widget_Object_Revisions.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Object_Revisions.prototype.constructor=Charcoal.Admin.Widget_Object_Revisions,Charcoal.Admin.Widget_Object_Revisions.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Object_Revisions.prototype.init=function(){this.bind_events()},Charcoal.Admin.Widget_Object_Revisions.prototype.bind_events=function(){var t=this;$("#"+this.id()).on("click.object.revisions",".js-obj-revert",this.revert.bind(this)),$("#"+this.id()).on("click.charcoal.bs.dialog",'[data-dismiss="dialog"]',function(e){$.isFunction(t.cancel_callback)&&t.cancel_callback(e)})},Charcoal.Admin.Widget_Object_Revisions.prototype.revert=function(t){t.preventDefault();var e=Charcoal.Admin.admin_url()+"object/revert-revision",i={obj_type:this.obj_type,obj_id:this.obj_id,rev_num:$(t.currentTarget).attr("data-rev-num")};BootstrapDialog.show({title:objectRevisionsWidgetL10n.title,message:objectRevisionsWidgetL10n.message,buttons:[{id:"ok-btn",label:objectRevisionsWidgetL10n.restore,action:function(){$.ajax({url:e,type:"POST",data:i,success:function(t){t.success?window.location.reload():(Charcoal.Admin.feedback().push([{msg:objectRevisionsWidgetL10n.restoreError,level:"error"}]),Charcoal.Admin.feedback().dispatch())},error:function(){Charcoal.Admin.feedback().push([{msg:objectRevisionsWidgetL10n.restoreError,level:"error"}]),Charcoal.Admin.feedback().dispatch()}})}}]})},Charcoal.Admin.Widget_Object_Revisions.prototype.disable_form=Charcoal.Admin.Widget_Form.prototype.disable_form,Charcoal.Admin.Widget_Object_Revisions.prototype.enable_form=Charcoal.Admin.Widget_Form.prototype.enable_form,Charcoal.Admin.Widget_Object_Revisions.prototype.request_url=Charcoal.Admin.Widget_Form.prototype.request_url,Charcoal.Admin.Widget_Object_Revisions.prototype.request_done=Charcoal.Admin.Widget_Form.prototype.request_done,Charcoal.Admin.Widget_Object_Revisions.prototype.request_failed=Charcoal.Admin.Widget_Form.prototype.request_failed,Charcoal.Admin.Widget_Object_Revisions.prototype.request_complete=Charcoal.Admin.Widget_Form.prototype.request_complete,Charcoal.Admin.Widget_Object_Revisions.prototype.request_success=function(t,e,i){i.feedbacks&&!this.suppress_feedback&&Charcoal.Admin.feedback(i.feedbacks),i.next_url&&Charcoal.Admin.feedback().add_action({label:commonL10n.continue,callback:function(){window.location.href=Charcoal.Admin.admin_url()+i.next_url}})},Charcoal.Admin.Widget_Quick_Form=function(t){return this.widget_type="charcoal/admin/widget/quick-form",this.save_callback=t.save_callback||"",this.cancel_callback=t.cancel_callback||"",this.save_action=t.save_action||"object/save",this.update_action=t.update_action||"object/update",this.extra_form_data=t.extra_form_data||{},this.form_working=!1,this.suppress_feedback=t.suppress_feedback||!1,this.is_new_object=!1,this.xhr=null,this.obj_id=Charcoal.Admin.parseNumber(t.obj_id)||0,this},Charcoal.Admin.Widget_Quick_Form.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Quick_Form.prototype.constructor=Charcoal.Admin.Widget_Quick_Form,Charcoal.Admin.Widget_Quick_Form.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Quick_Form.prototype.init=function(){this.bind_events()},Charcoal.Admin.Widget_Quick_Form.prototype.bind_events=function(){var t=this;$(document).on("submit","#"+this.id(),function(e){e.preventDefault(),t.submit_form(this)}),$("#"+this.id()).on("click.charcoal.bs.dialog",'[data-dismiss="dialog"]',function(e){$.isFunction(t.cancel_callback)&&t.cancel_callback(e)})},Charcoal.Admin.Widget_Quick_Form.prototype.submit_form=function(t){if(!this.form_working){this.form_working=!0,this.is_new_object=!this.obj_id;var e,i,o;if(i=$(t),(e=i.find('[type="submit"]')).prop("disabled"))return!1;Charcoal.Admin.manager().prepare_submit(),o=new FormData(t),this.disable_form(i,e);var r=this.extra_form_data;for(var n in r)r.hasOwnProperty(n)&&o.append(n,r[n]);this.xhr=$.ajax({type:"POST",url:this.request_url(),data:o,dataType:"json",processData:!1,contentType:!1}),this.xhr.then($.proxy(this.request_done,this,i,e)).done($.proxy(this.request_success,this,i,e)).fail($.proxy(this.request_failed,this,i,e)).always($.proxy(this.request_complete,this,i,e))}},Charcoal.Admin.Widget_Quick_Form.prototype.disable_form=Charcoal.Admin.Widget_Form.prototype.disable_form,Charcoal.Admin.Widget_Quick_Form.prototype.enable_form=Charcoal.Admin.Widget_Form.prototype.enable_form,Charcoal.Admin.Widget_Quick_Form.prototype.request_url=Charcoal.Admin.Widget_Form.prototype.request_url,Charcoal.Admin.Widget_Quick_Form.prototype.request_done=Charcoal.Admin.Widget_Form.prototype.request_done,Charcoal.Admin.Widget_Quick_Form.prototype.request_failed=Charcoal.Admin.Widget_Form.prototype.request_failed,Charcoal.Admin.Widget_Quick_Form.prototype.request_complete=Charcoal.Admin.Widget_Form.prototype.request_complete,Charcoal.Admin.Widget_Quick_Form.prototype.request_success=function(t,e,i){i.feedbacks&&!this.suppress_feedback&&Charcoal.Admin.feedback(i.feedbacks),i.next_url&&Charcoal.Admin.feedback().add_action({label:commonL10n.continue,callback:function(){window.location.href=Charcoal.Admin.admin_url()+i.next_url}}),this.enable_form(t,e),this.form_working=!1,"function"==typeof this.save_callback&&this.save_callback(i)},Charcoal.Admin.Widget_Relation=function(){return this.dirty=!1,this},Charcoal.Admin.Widget_Relation.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Relation.prototype.constructor=Charcoal.Admin.Widget_Relation,Charcoal.Admin.Widget_Relation.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Relation.prototype.init=function(){if("function"!=typeof $.fn.sortable){return Charcoal.Admin.loadScript("https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js",this.init.bind(this)),this}var t=this.element().find(".js-relation-sortable .js-grid-container");return this.element().on("hidden.bs.collapse",'[data-toggle="collapse"]',function(){t.sortable("refreshPositions")}),t.sortable({handle:'[draggable="true"]',placeholder:"panel c-attachment_placeholder",start:function(t,e){e.item.children(".panel-heading").find('[data-toggle="collapse"]').hasClass("collapsed")||e.item.children(".panel-collapse").collapse("hide")}}).disableSelection(),this.listeners(),this},Charcoal.Admin.Widget_Relation.prototype.is_dirty=function(){return this.dirty},Charcoal.Admin.Widget_Relation.prototype.set_dirty_state=function(t){return this.dirty=t,this},Charcoal.Admin.Widget_Relation.prototype.listeners=function(){var t=this;this.element().off("click").on("click.charcoal.relation",".js-add-relation",function(e){e.preventDefault();var i=$(this).data("type");if(!i)return!1;var o=$(this).data("id");if(o)t.add({id:o,type:i}),t.create_relation(function(){t.reload()});else{var r=$(this).data("title")||relationWidgetL10n.editObject;t.create_relation_dialog({title:r,widget_options:{form_data:{target_object_type:i,target_object_id:null}}},function(e){e.success&&(e.obj.id=e.obj_id,t.add(e.obj),t.create_relation(function(){t.reload()}))})}}).on("click.charcoal.relation",".js-relation-actions a",function(e){var i=$(this);if(i.data("action")){e.preventDefault();switch(i.data("action")){case"edit":var o=i.data("type"),r=i.data("id");if(!o||!r)break;var n=i.data("title")||relationWidgetL10n.editObject;t.create_relation_dialog({title:n,widget_options:{form_data:{target_object_type:o,target_object_id:null}}},function(e){e.success&&t.reload()});break;case"unlink":if(!i.data("id"))break;t.confirm({title:relationWidgetL10n.confirmRemoval,message:commonL10n.confirmAction,btnOKLabel:commonL10n.removeObject,callback:function(e){e&&t.remove_relation(i.data("id"),function(){t.reload()})}})}}})},Charcoal.Admin.Widget_Relation.prototype.create_relation_dialog=function(t,e){t=t||{};var i=this.opts().data,o={size:BootstrapDialog.SIZE_WIDE,cssClass:"-quick-form",widget_type:"charcoal/admin/widget/quick-form",widget_options:{obj_type:"charcoal/relation/pivot",obj_id:0,form_data:{group:i.group,source_object_type:i.obj_type,source_object_id:i.obj_id,target_object_type:"",target_object_id:0}}},r=$.extend(!0,{},o,t,{}),n=this.dialog(r,function(t){if(t.success){if(!t.widget_id)return!1;Charcoal.Admin.manager().add_widget({id:t.widget_id,type:"charcoal/admin/widget/quick-form",data:{obj_type:r.widget_options.type},obj_id:r.widget_options.id,save_callback:function(t){e(t),n.close()}}),Charcoal.Admin.manager().render()}})},Charcoal.Admin.Widget_Relation.prototype.add=function(t){if(!t)return!1;this.set_dirty_state(!0);var e=this.element().find(".js-relation-template").clone();return e.find(".js-relation").attr({"data-id":t.target_object_id,"data-type":t.target_object_type}),this.element().find(".js-relation-sortable").find(".js-grid-container").append(e),this},Charcoal.Admin.Widget_Relation.prototype.save=function(){if(this.is_dirty())return!1;this.create_relation()},Charcoal.Admin.Widget_Relation.prototype.create_relation=function(t){var e=this,i=e.opts(),o={obj_type:i.data.obj_type,obj_id:i.data.obj_id,group:i.data.group,pivots:[]};this.element().find(".js-relation-container").find(".js-relation").each(function(t){var e=$(this),i=e.attr("data-id"),r=e.attr("data-type");o.pivots.push({target_object_id:i,target_object_type:r,position:t})}),$.post("relation/link",o,function(){"function"==typeof t&&t(),e.set_dirty_state(!1)},"json")},Charcoal.Admin.Widget_Relation.prototype.remove_relation=function(t,e){if(!t)return!1;var i=this,o={pivot_id:t};$.post("relation/unlink",o,function(){"function"==typeof e&&e(),i.set_dirty_state(!1)},"json")},Charcoal.Admin.Widget_Relation.prototype.widget_options=function(){return this.opts("widget_options")},Charcoal.Admin.Widget_Search=function(t){return this._elem=void 0,!!t&&(void 0!==t.id&&(this.set_element($("#"+t.id)),"object"==typeof t.data&&(this.opts=t,this.$input=null,this)))},Charcoal.Admin.Widget_Search.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Search.prototype.constructor=Charcoal.Admin.Widget_Search,Charcoal.Admin.Widget_Search.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Search.prototype.set_remote_widget=function(){},Charcoal.Admin.Widget_Search.prototype.init=function(){var t=this,e=this.element();this.$input=e.find('[name="query"]'),e.on("submit.charcoal.search",function(e){e.preventDefault(),t.submit()}),e.on("reset.charcoal.search",function(e){e.preventDefault(),t.clear()})},Charcoal.Admin.Widget_Search.prototype.submit=function(){var t,e,i,o;if(t=Charcoal.Admin.manager(),e=t.components.widgets,(o=e.length)>0){i=this.prepare_request(this.$input.val()),console.log("Search.submit",i);for(var r=0;r<o;r++)this.dispatch(i,e[r])}return this},Charcoal.Admin.Widget_Search.prototype.clear=function(){return this.$input.val(""),this.submit(),this},Charcoal.Admin.Widget_Search.prototype.prepare_request=function(t){var e,i,o=null,r=[];return(t=t.trim())&&(e=t.split(/\s/),i=this.opts.data.properties||[],$.each(e,function(t,e){$.each(i,function(t,i){r.push({property:i,operator:"LIKE",value:"%"+e+"%"})})})),r.length&&(o={conjunction:"OR",filters:r}),o},Charcoal.Admin.Widget_Search.prototype.dispatch=function(t,e){if(!e)return this;if("function"!=typeof e.set_filters)return this;void 0!==e.pagination&&(e.pagination.page=1);var i=[];return t&&i.push(t),e.set_filters(i),e.reload(),this},Charcoal.Admin.Widget_Table=function(){this.obj_type=null,this.widget_id=null,this.table_selector=null,this.filters={},this.orders={},this.pagination={page:1,num_per_page:50},this.list_actions={},this.object_actions={},this.template=this.properties=this.properties_options=void 0},Charcoal.Admin.Widget_Table.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Table.prototype.constructor=Charcoal.Admin.Widget_Table,Charcoal.Admin.Widget_Table.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Table.prototype.init=function(){this.set_properties().bind_events()},Charcoal.Admin.Widget_Table.prototype.set_properties=function(){var t=this.opts();return this.obj_type=t.data.obj_type||this.obj_type,this.widget_id=t.id||this.widget_id,this.table_selector="#"+this.widget_id,this.template=t.data.template||this.template,this.properties=t.data.properties||this.properties,this.properties_options=t.data.properties_options||this.properties_options,this.filters=t.data.filters||this.filters,this.orders=t.data.orders||this.orders,this.pagination=t.data.pagination||this.pagination,this.list_actions=t.data.list_actions||this.list_actions,this.object_actions=t.data.object_actions||this.object_actions,this.collection_ident=t.data.collection_ident||"default",this},Charcoal.Admin.Widget_Table.prototype.bind_events=function(){var t=this,e=$("tbody.js-sortable",t.table_selector);e.length>0&&new window.Sortable.default(e.get(),{delay:150,draggable:".js-table-row",handle:".js-sortable-handle",mirror:{constrainDimensions:!0}}).on("mirror:create",function(t){var e=t.originalSource.querySelectorAll(":scope > td"),i=t.source.querySelectorAll(":scope > td");e.forEach(function(t,e){i[e].style.width=t.offsetWidth+"px"})}).on("sortable:stop",function(e){if(e.oldIndex!==e.newIndex){var i=Array.from(e.newContainer.querySelectorAll(":scope > tr")).map(function(t){return t.classList.contains("draggable-mirror")||t.classList.contains("draggable--original")?"":t.getAttribute("data-id")}).filter(function(t){return""!==t});$.ajax({method:"POST",url:Charcoal.Admin.admin_url()+"object/reorder",data:{obj_type:t.obj_type,obj_orders:i,starting_order:1},dataType:"json"}).done(function(t){console.debug(t),t.feedbacks&&Charcoal.Admin.feedback(t.feedbacks).dispatch()})}}),$(".js-jump-page-form",t.table_selector).on("submit",function(e){e.preventDefault();var i=$(this),o=parseInt(i.find("input").val());o&&(t.pagination.page=o,t.reload())}),$(".js-page-switch",t.table_selector).on("click",function(e){e.preventDefault();var i=$(this).data("page-num");t.pagination.page=i,t.reload()})},Charcoal.Admin.Widget_Table.prototype.add_filter=function(t){var e=this.get_filters();return null===e&&(e={}),e=$.extend(e,t),this.set_filters(e),this},Charcoal.Admin.Widget_Table.prototype.set_filters=function(t){this.filters=t},Charcoal.Admin.Widget_Table.prototype.get_filters=function(){return this.filters},Charcoal.Admin.Widget_Table.prototype.widget_options=function(){return{obj_type:this.obj_type,template:this.template,collection_ident:this.collection_ident,collection_config:{properties:this.properties,properties_options:this.properties_options,filters:this.filters,orders:this.orders,pagination:this.pagination,list_actions:this.list_actions,object_actions:this.object_actions}}},Charcoal.Admin.Widget_Table.prototype.reload=function(t){return Charcoal.Admin.Widget.prototype.reload.call(this,t),this},Charcoal.Admin.Property=function(t){return this._ident=void 0,this._val=void 0,this._type=void 0,this._input_type=void 0,"string"==typeof t.ident&&this.set_ident(t.ident),void 0!==t.val&&this.set_val(t.val),void 0!==t.type&&this.set_type(t.type),void 0!==t.input_type&&this.set_input_type(t.input_type),this.data=t,this},Charcoal.Admin.Property.prototype.set_ident=function(t){this._ident=t},Charcoal.Admin.Property.prototype.set_val=function(t){this._val=t},Charcoal.Admin.Property.prototype.set_type=function(t){this._type=t},Charcoal.Admin.Property.prototype.set_input_type=function(t){this._input_type=t},Charcoal.Admin.Property.prototype.ident=function(){return this._ident},Charcoal.Admin.Property.prototype.val=function(){return this._val},Charcoal.Admin.Property.prototype.type=function(){return this._type},Charcoal.Admin.Property.prototype.input_type=function(){return this._input_type},Charcoal.Admin.Property.prototype.element=function(){if(!this._element){if(!this.data.id)return!1;this._element=$("#"+this.data.id)}return this._element},Charcoal.Admin.Property.prototype.validate=function(){},Charcoal.Admin.Property.prototype.save=function(){return this},Charcoal.Admin.Property.prototype.error=function(t){window.console.error(t)},Charcoal.Admin.Property_Input_Audio=function(t){t.input_type="charcoal/admin/property/input/audio",Charcoal.Admin.Property.call(this,t),this.text_properties={},this.recording_properties={},this.file_properties={},this.initialized_types=[],this.active_pane=t.data.active_pane||"text",this._recorder=void 0,this.init()},Charcoal.Admin.Property_Input_Audio.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Audio.prototype.constructor=Charcoal.Admin.Property_Input_Audio,Charcoal.Admin.Property_Input_Audio.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Audio.prototype.init=function(){var t=this.data;void 0===t.id&&console.error("Missing ID"),this.text_properties.$voice_message=$(".js-text-voice-message",this.element()),this.recording_properties.audio_context=null,this.recording_properties.audio_recorder=null,this.recording_properties.animation_frame=null,this.recording_properties.analyser_context=null,this.recording_properties.canvas_width=0,this.recording_properties.canvas_height=0,this.recording_properties.recording_index=0,this.recording_properties.current_recording=null,this.recording_properties.audio_player=null,this.recording_properties.hidden_input_id=t.data.hidden_input_id,this.recording_properties.$analyser_canvas=$(".js-recording-analyser",this.element()),this.recording_properties.$waves_canvas=$(".js-recording-waves",this.element()),this.recording_properties.record_button_class="js-recording-record",this.recording_properties.$record_button=$(".js-recording-record",this.element()),this.recording_properties.stop_button_class="js-recording-stop",this.recording_properties.$stop_button=$(".js-recording-stop",this.element()),this.recording_properties.playback_button_class="js-recording-playback",this.recording_properties.$playback_button=$(".js-recording-playback",this.element()),this.recording_properties.reset_button_class="js-recording-reset",this.recording_properties.$reset_button=$(".js-recording-reset",this.element()),this.recording_properties.$timer=$(".js-recording-timer",this.element()),this.file_properties.$file_audio=$(".js-file-audio",this.element()),this.file_properties.$file_reset=$(".js-file-reset",this.element()),this.file_properties.$file_input=$(".js-file-input",this.element()),this.file_properties.$file_input_hiden=$(".js-file-input-hidden",this.element()),this.file_properties.reset_button_class="js-file-reset",this.set_nav(this.active_pane).bind_nav_controls()},Charcoal.Admin.Property_Input_Audio.prototype.bind_nav_controls=function(){var t=this;this.element().on("click",".js-toggle-pane",function(){var e=$(this);t.set_nav(e.attr("data-pane"))})},Charcoal.Admin.Property_Input_Audio.prototype.set_nav=function(t){if(t){var e=$(".js-toggle-pane"),i=$(".js-pane"),o=i.filter('[data-pane="'+t+'"]');if(!o.hasClass("is-active")){var r=e.filter('[data-pane="'+t+'"]');e.removeClass("active"),r.addClass("active"),i.removeClass("is-active").addClass("d-none"),o.removeClass("d-none").addClass("is-active"),this.prepare_pane(t)}}return this},Charcoal.Admin.Property_Input_Audio.prototype.prepare_pane=function(t){var e="init_"+t;"function"==typeof Charcoal.Admin.Property_Input_Audio.prototype[e]&&this[e]()},Charcoal.Admin.Property_Input_Audio.prototype.init_text=function(){if(-1===this.initialized_types.indexOf("text")){this.initialized_types.push("text");var t=this.text_properties.$voice_message.val();t=this.text_strip_tags(t),this.text_properties.$voice_message.val(t)}},Charcoal.Admin.Property_Input_Audio.prototype.text_strip_tags=function(t,e){e=((String(e)||"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");return t.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,"").replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,function(t,i){return e.indexOf("<"+i.toLowerCase()+">")>-1?t:""})},Charcoal.Admin.Property_Input_Audio.prototype.init_file=function(){-1===this.initialized_types.indexOf("file")&&(this.initialized_types.push("file"),this.file_bind_events())},Charcoal.Admin.Property_Input_Audio.prototype.file_bind_events=function(){var t=this;t.element().on("click","."+t.file_properties.reset_button_class,function(){t.file_reset_input()})},Charcoal.Admin.Property_Input_Audio.prototype.file_reset_input=function(){this.file_properties.$file_audio.attr("src","").addClass("hide"),this.file_properties.$file_reset.addClass("hide"),this.file_properties.$file_input.removeClass("hide").wrap("<form>").closest("form").get(0).reset(),this.file_properties.$file_input.unwrap(),this.file_properties.$file_input_hiden.val("")},Charcoal.Admin.Property_Input_Audio.prototype.init_recording=function(){if(-1===this.initialized_types.indexOf("recording")){var t=this;t.initialized_types.push("recording"),window.navigator.getUserMedia||(window.navigator.getUserMedia=window.navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia),window.navigator.cancelAnimationFrame||(window.navigator.cancelAnimationFrame=window.navigator.webkitCancelAnimationFrame||window.navigator.mozCancelAnimationFrame),window.navigator.requestAnimationFrame||(window.navigator.requestAnimationFrame=window.navigator.webkitRequestAnimationFrame||window.navigator.mozRequestAnimationFrame),window.AudioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext),window.navigator.getUserMedia({audio:{mandatory:{googEchoCancellation:!1,googAutoGainControl:!1,googNoiseSuppression:!1,googHighpassFilter:!1},optional:[]}},function(e){t.recording_bind_events(),t.recording_got_stream(e)},function(t){window.alert(audioPropertyL10n.captureFailed+" "+commonL10n.errorOccurred),window.console.log(t)})}},Charcoal.Admin.Property_Input_Audio.prototype.recording_bind_events=function(){var t=this;t.element().on("click","."+t.recording_properties.record_button_class,function(){t.recording_manage_recorder()}),t.element().on("click","."+t.recording_properties.stop_button_class,function(){t.recording_manage_recorder("stop")}),t.element().on("click","."+t.recording_properties.playback_button_class,function(){0!==t.recording_properties.recording_index&&null!==t.recording_properties.audio_player&&t.recording_toggle_playback()}),t.element().on("click","."+t.recording_properties.reset_button_class,function(){t.recording_reset_audio()})},Charcoal.Admin.Property_Input_Audio.prototype.recording_got_stream=function(t){var e=this;e.recording_properties.audio_context=new window.AudioContext,e.recording_properties.audio_player=new window.Audio_Player({on_ended:function(){e.recording_manage_button_states("pause_playback")},on_timeupdate:function(t){e.recording_render_timer(t)},on_loadedmetadata:function(t){e.recording_render_timer(t)}});var i=e.recording_properties.audio_context.createGain(),o=null;e.recording_properties.audio_context.createMediaStreamSource(t).connect(i),window.analyserNode=e.recording_properties.audio_context.createAnalyser(),window.analyserNode.fftSize=2048,i.connect(window.analyserNode),e.recording_properties.audio_recorder=new window.Recorder(i,{workerPath:e.data.recorder_worker_path}),(o=e.recording_properties.audio_context.createGain()).gain.value=0,i.connect(o),o.connect(e.recording_properties.audio_context.destination),e.recording_update_analysers()},Charcoal.Admin.Property_Input_Audio.prototype.recording_manage_button_states=function(t){switch(t){case"start_recording":this.recording_properties.$record_button.addClass("is-recording"),this.recording_properties.$stop_button.prop("disabled",!1),this.recording_properties.$playback_button.prop("disabled",!0),this.recording_properties.$reset_button.prop("disabled",!1);break;case"pause_recording":this.recording_properties.$record_button.removeClass("is-recording"),this.recording_properties.$stop_button.prop("disabled",!1),this.recording_properties.$playback_button.prop("disabled",!0),this.recording_properties.$reset_button.prop("disabled",!1);break;case"stop_recording":this.recording_properties.$record_button.removeClass("is-recording"),this.recording_properties.$stop_button.prop("disabled",!0),this.recording_properties.$playback_button.prop("disabled",!1),this.recording_properties.$reset_button.prop("disabled",!1);break;case"start_playback":this.recording_properties.$playback_button.addClass("is-playing");break;case"pause_playback":this.recording_properties.$playback_button.removeClass("is-playing");break;case"reset":this.recording_properties.$record_button.removeClass("is-recording"),this.recording_properties.$stop_button.prop("disabled",!0),this.recording_properties.$playback_button.prop("disabled",!0).removeClass("is-playing"),this.recording_properties.$reset_button.prop("disabled",!0)}},Charcoal.Admin.Property_Input_Audio.prototype.recording_render_timer=function(t){var e="";if(t){var i=0,o=0,r=t.duration-t.currentTime;i=Math.floor(r/60),o=Math.round(r)%60,e+=(i<10?"0":"")+String(i)+":",e+=(o<10?"0":"")+String(o)}else e="00:00";this.recording_properties.$timer.text(e)},Charcoal.Admin.Property_Input_Audio.prototype.recording_manage_recorder=function(t){var e=this;if("stop"===t)return e.recording_properties.audio_recorder.stop(),e.recording_properties.audio_recorder.get_buffers(function(t){e.recording_got_buffers(t),e.recording_properties.audio_recorder.clear(),e.recording_display_canvas("waves")}),void e.recording_manage_button_states("stop_recording");if(e.recording_properties.audio_recorder.is_recording())e.recording_properties.audio_recorder.stop(),e.recording_manage_button_states("pause_recording");else{if(!e.recording_properties.audio_recorder)return;e.recording_properties.audio_recorder.record(),e.recording_manage_button_states("start_recording"),e.recording_display_canvas("analyser")}},Charcoal.Admin.Property_Input_Audio.prototype.recording_toggle_playback=function(){if(this.recording_properties.audio_player.is_playing())this.recording_properties.audio_player.pause(),this.recording_manage_button_states("pause_playback");else{if(!this.recording_properties.audio_player)return;this.recording_properties.audio_player.play(),this.recording_manage_button_states("start_playback")}},Charcoal.Admin.Property_Input_Audio.prototype.recording_reset_audio=function(){var t=this.recording_properties.$analyser_canvas[0];t.getContext("2d").clearRect(0,0,t.canvas_width,t.canvas_height);var e=this.recording_properties.$waves_canvas[0];e.getContext("2d").clearRect(0,0,e.canvas_width,e.canvas_height),this.recording_properties.audio_player.load(),this.recording_properties.audio_player.src(""),this.recording_properties.audio_recorder.stop(),this.recording_properties.audio_recorder.clear(),this.recording_manage_button_states("reset"),this.recording_display_canvas("analyser"),this.recording_render_timer();var i=document.getElementById(this.recording_properties.hidden_input_id);i&&(i.value="")},Charcoal.Admin.Property_Input_Audio.prototype.recording_got_buffers=function(t){var e=this.recording_properties.$waves_canvas[0],i=this;i.recording_draw_buffer(e.width,e.height,e.getContext("2d"),t[0]),i.recording_properties.audio_recorder.export_wav(function(t){i.recording_done_encoding(t)})},Charcoal.Admin.Property_Input_Audio.prototype.recording_draw_buffer=function(t,e,i,o){var r=Math.ceil(o.length/t),n=e/2;i.fillStyle="#DDDDDD",i.clearRect(0,0,t,e);for(var a=0;a<t;a++){for(var s=1,c=-1,l=0;l<r;l++){var p=o[a*r+l];p<s&&(s=p),p>c&&(c=p)}i.fillRect(a,(1+s)*n,1,Math.max(1,(c-s)*n))}},Charcoal.Admin.Property_Input_Audio.prototype.recording_done_encoding=function(t){var e=new window.FileReader,i=null,o=this;e.readAsDataURL(t),e.onloadend=function(){i=e.result,o.recording_properties.recording_index++,o.recording_manage_audio_data(i)}},Charcoal.Admin.Property_Input_Audio.prototype.recording_manage_audio_data=function(t){if(t){var e=document.getElementById(this.recording_properties.hidden_input_id);e&&(e.value=t),this.recording_properties.audio_player.src(t),this.recording_properties.audio_player.load()}},Charcoal.Admin.Property_Input_Audio.prototype.recording_display_canvas=function(t){switch(t){case"waves":this.recording_properties.$analyser_canvas.addClass("d-none"),this.recording_properties.$waves_canvas.removeClass("d-none");break;default:this.recording_properties.$analyser_canvas.removeClass("d-none"),this.recording_properties.$waves_canvas.addClass("d-none")}},Charcoal.Admin.Property_Input_Audio.prototype.recording_cancel_analyser_update=function(){window.cancelAnimationFrame(this.recording_properties.animation_frame),this.recording_properties.animation_frame=null},Charcoal.Admin.Property_Input_Audio.prototype.recording_update_analysers=function(){this.recording_properties.analyser_context||(this.recording_properties.analyser_context=this.recording_properties.$analyser_canvas[0].getContext("2d"));var t=this,e=t.recording_properties.analyser_context,i=t.recording_properties.$analyser_canvas[0];if(t.recording_properties.canvas_width=i.width,t.recording_properties.canvas_height=i.height,e.lineCap="round",t.recording_properties.audio_recorder.is_recording()){var o=Math.round(t.recording_properties.canvas_width/5),r=new window.Uint8Array(window.analyserNode.frequencyBinCount),n=0;window.analyserNode.getByteFrequencyData(r),n=window.analyserNode.frequencyBinCount/o,e.clearRect(0,0,t.recording_properties.canvas_width,t.recording_properties.canvas_height);for(var a=0;a<o;++a){for(var s=0,c=Math.floor(a*n),l=0;l<n;l++)s+=r[c+l];s/=n,e.fillStyle=e.fillStyle="#DDDDDD",e.fillRect(5*a,t.recording_properties.canvas_height,2,-s)}}else e.clearRect(0,0,t.recording_properties.canvas_width,t.recording_properties.canvas_height);t.recording_properties.animation_frame=window.requestAnimationFrame(function(){t.recording_update_analysers()})},function(t){t.Recorder=function(e,i){var o,r=i||{},n=r.buffer_length||4096,a=new t.Worker(r.workerPath),s=!1;this.context=e.context,this.context.createScriptProcessor?this.node=this.context.createScriptProcessor(n,2,2):this.node=this.context.createJavaScriptNode(n,2,2),a.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}}),this.node.onaudioprocess=function(t){s&&a.postMessage({command:"record",buffer:[t.inputBuffer.getChannelData(0),t.inputBuffer.getChannelData(1)]})},this.configure=function(t){for(var e in t)t.hasOwnProperty(e)&&(r[e]=t[e])},this.record=function(){s=!0},this.stop=function(){s=!1},this.clear=function(){a.postMessage({command:"clear"})},this.get_buffers=function(t){o=t||r.callback,a.postMessage({command:"getBuffers"})},this.export_wav=function(t,e){if(o=t||r.callback,e=e||r.type||"audio/wav",!o)throw new Error("Callback not set");a.postMessage({command:"exportWAV",type:e})},this.is_recording=function(){return s},a.onmessage=function(t){var e=t.data;o(e)},e.connect(this.node),this.node.connect(this.context.destination)}}(window),function(t){t.Audio_Player=function(e){this.callbacks={on_ended:e.on_ended||function(){},on_pause:e.on_pause||function(){},on_playing:e.on_playing||function(){},on_timeupdate:e.on_timeupdate||function(){},on_loadedmetadata:e.on_loadedmetadata||function(){}},this._element=new t.Audio,this.play=function(){this.element().play()},this.pause=function(){this.element().pause()},this.load=function(){this.element().load()},this.src=function(t){this.element().src=t},this.is_playing=function(){return!this.element().paused&&!this.element().ended&&this.element().currentTime>0},this.element=function(){return this._element};var i=this;i.element().addEventListener("ended",function(){i.callbacks.on_ended()}),i.element().addEventListener("pause",function(){i.callbacks.on_pause()}),i.element().addEventListener("playing",function(){i.callbacks.on_playing()}),i.element().addEventListener("timeupdate",function(){i.callbacks.on_timeupdate(i.element())}),i.element().addEventListener("loadedmetadata",function(){i.callbacks.on_loadedmetadata(i.element())})}}(window),Charcoal.Admin.Property_Input_ColorPicker=function(t){this.input_type="charcoal/admin/property/input/colorpicker",this.input_id=null,this.colorpicker_selector=null,this.colorpicker_options=null,this.set_properties(t).create_colorpicker()},Charcoal.Admin.Property_Input_ColorPicker.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_ColorPicker.prototype.constructor=Charcoal.Admin.Property_Input_ColorPicker,Charcoal.Admin.Property_Input_ColorPicker.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_ColorPicker.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.colorpicker_selector=t.data.colorpicker_selector||this.colorpicker_selector,this.colorpicker_options=t.data.colorpicker_options||this.colorpicker_options;return this.colorpicker_options=$.extend({},{},this.colorpicker_options),this},Charcoal.Admin.Property_Input_ColorPicker.prototype.create_colorpicker=function(){return $(this.colorpicker_selector).minicolors(this.colorpicker_options),this},Charcoal.Admin.Property_Input_DateTimePicker=function(t){this.input_type="charcoal/admin/property/input/datetimepicker",this.input_id=null,this.datetimepicker_selector=null,this.datetimepicker_options=null,this.set_properties(t).create_datetimepicker()},Charcoal.Admin.Property_Input_DateTimePicker.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_DateTimePicker.prototype.constructor=Charcoal.Admin.Property_Input_DateTimePicker,Charcoal.Admin.Property_Input_DateTimePicker.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_DateTimePicker.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.datetimepicker_selector=t.data.datetimepicker_selector||this.datetimepicker_selector,this.datetimepicker_options=t.data.datetimepicker_options||this.datetimepicker_options;return this.datetimepicker_options=$.extend({},{},this.datetimepicker_options),this},Charcoal.Admin.Property_Input_DateTimePicker.prototype.create_datetimepicker=function(){return $(this.datetimepicker_selector).datetimepicker(this.datetimepicker_options),this},Charcoal.Admin.Property_Input_DualSelect=function(t){this.input_type="charcoal/admin/property/input/dualselect",this.input_id=null,this.dualselect_selector=null,this.dualselect_options={},this._dualselect=null,this.set_properties(t).init()},Charcoal.Admin.Property_Input_DualSelect.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_DualSelect.prototype.constructor=Charcoal.Admin.Property_Input_DualSelect,Charcoal.Admin.Property_Input_DualSelect.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_DualSelect.prototype.init=function(){this.create_dualselect()},Charcoal.Admin.Property_Input_DualSelect.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.dualselect_selector=t.dualselect_selector||t.data.dualselect_selector||this.dualselect_selector,this.dualselect_options=t.dualselect_options||t.data.dualselect_options||this.dualselect_options;return t.data.dualselect_options.searchable&&(this.dualselect_options.search={left:this.dualselect_selector+"_searchLeft",right:this.dualselect_selector+"_searchRight"}),this.dualselect_options=$.extend({},{keepRenderingSort:!1},this.dualselect_options),this},Charcoal.Admin.Property_Input_DualSelect.prototype.create_dualselect=function(){return $(this.dualselect_selector).multiselect(this.dualselect_options),this},Charcoal.Admin.Property_Input_DualSelect.prototype.set_dualselect=function(t){return this._dualselect=t,this},Charcoal.Admin.Property_Input_DualSelect.prototype.dualselect=function(){return this._dualselect},Charcoal.Admin.Property_Input_DualSelect.prototype.destroy=function(){var t=this.dualselect();t&&t.remove()},Charcoal.Admin.Property_Input_File=function(t){return this.EVENT_NAMESPACE=".charcoal.property.file",this.input_type="charcoal/admin/property/input/file",this.opts=t,this.data=t.data,this.dialog=null,this.set_input_id(this.opts.id).init(),this},Charcoal.Admin.Property_Input_File.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_File.prototype.constructor=Charcoal.Admin.Property_Input_File,Charcoal.Admin.Property_Input_File.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_File.prototype.init=function(){this.input_id&&(this.$input=$("#"+this.input_id),this.$file=this.$input.find('input[type="file"]'),this.$hidden=this.$input.find('input[type="hidden"]'),this.$preview=this.$input.find(".js-preview"),window.elFinderCallback||(window.elFinderCallback={}),this.set_listeners())},Charcoal.Admin.Property_Input_File.prototype.set_listeners=function(){void 0!==this.$input&&(this.$input.on("click"+this.EVENT_NAMESPACE,".js-remove-file",this.remove_file.bind(this)).on("click"+this.EVENT_NAMESPACE,".js-elfinder",this.load_elfinder.bind(this)),this.$file.on("change"+this.EVENT_NAMESPACE,this.change_file.bind(this)),window.elFinderCallback[this.input_id]=this.elfinder_callback.bind(this))},Charcoal.Admin.Property_Input_File.prototype.remove_file=function(t){t.preventDefault(),this.$hidden.val(""),this.$input.find(".form-control-plaintext").empty(),this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none")},Charcoal.Admin.Property_Input_File.prototype.change_file=function(t){var e,i;i=(e=t.dataTransfer||t.target)&&e.files&&e.files[0],URL.createObjectURL(i),this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$input.find(".form-control-plaintext").html(i),this.$preview.empty()},Charcoal.Admin.Property_Input_File.prototype.load_elfinder=function(t){t.preventDefault(),this.dialog=BootstrapDialog.show({title:this.data.dialog_title||"",size:BootstrapDialog.SIZE_WIDE,cssClass:"-elfinder",message:$('<iframe name="'+this.input_id+'-elfinder" width="100%" height="400px" frameborder="0" src="'+this.data.elfinder_url+'"></iframe>')})},Charcoal.Admin.Property_Input_File.prototype.elfinder_callback=function(t){this.dialog&&this.dialog.close(),t&&t.path&&(this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$input.find(".form-control-plaintext").html(t.name),this.$hidden.val(decodeURI(t.url).replace(Charcoal.Admin.base_url(),"")),this.$preview.empty())},Charcoal.Admin.Property_Input_File.prototype.set_input_id=function(t){return this.input_id=t,this},Charcoal.Admin.Property_Input_File.prototype.set_input_name=function(t){return this.input_name=t,this},Charcoal.Admin.Property_Input_File.prototype.set_input_val=function(t){return this.input_val=t,this},Charcoal.Admin.Property_Input_Geometry_Widget=function(t){t.input_type="charcoal/admin/property/input/geometry-widget",Charcoal.Admin.Property.call(this,t);var e=this;this._controller=void 0,this._object_inc=0,this._startGeometry=!1,setTimeout(function(){"undefined"==typeof google?(window._tmp_google_onload_function=function(){e.init()},$.getScript("https://maps.googleapis.com/maps/api/js?sensor=false&callback=_tmp_google_onload_function&key="+t.data.map_options.api_key,function(){})):e.init()},2e3)},Charcoal.Admin.Property_Input_Geometry_Widget.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Geometry_Widget.prototype.constructor=Charcoal.Admin.Property_Input_Geometry_Widget,Charcoal.Admin.Property_Input_Geometry_Widget.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Geometry_Widget.prototype.init=function(){if(void 0!==window._tmp_google_onload_function&&delete window._tmp_google_onload_function,"undefined"==typeof BB||"undefined"==typeof google)return console.error("Plugins not loaded"),!1;var t=this.data;void 0===t.id&&console.error("Missing ID");var e=this.default_styles(),i=this.default_map_options();i=$.extend(!0,i,t.data);var o=this.element().find("input[type=hidden]").val();if(o){var r={object1:{ident:"object1",paths:this.reverse_translate_coords(o),editable:!0,draggable:!0,type:i.geometry_type,styles:e}},n={},a=0;for(var s in r)a++,n[s]=r[s],n[s].styles=$.extend(r[s].styles,e);n&&(i.places=n),a&&(this._object_inc=a)}this.$map_maker=this.element().find(".js-map-maker"),this._controller=new window.BB.gmap.controller(this.element().find(".js-map-maker-map").get(0),i),this.controller().init().ready(function(t){t.fit_bounds(),t.remove_focus()}),this.controller().set_styles([{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]}]),this.controller().remove_focus(),this.link_related_property();var c=this,l=i.geometry_type;c.hide_marker_toolbar();for(var p="object"+c.object_index();c.controller().get_place(p);)p="object"+c.object_index();this.element().on("click",function(){var t=c.controller().export();if(t&&0!==Object.keys(t.places).length)return!1;if(!c._startGeometry)switch(c._startGeometry=!0,l){case"marker":case"line":case"polygon":c.controller().create_new(l,p)}}),this.element().on("click",".js-reset",function(t){c._startGeometry=!1,t.preventDefault(),c.controller().reset()})},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.link_related_property=function(){var t=this.data.data.related_property;if(!t)return!1;for(var e in t)switch(t[e].obj_type){case"charcoal/admin/object/geometry-blueprint":this.related_object_geometry(e)}},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.related_object_geometry=function(t){var e=this.data.data.related_property[t].obj_type;if(!e)return!1;var i=[],o=!1,r=this;$.ajax({url:Charcoal.Admin.admin_url()+"object/load",data:{obj_type:e},type:"GET",error:function(){},success:function(t){o=!0,i=t.collection}}),this.element().parents("fieldset").on("change",'[name="'+t+'"]',function(t){if(!o)return!1;r.controller().reset();for(var e in i)if(i[e].id===$(t.currentTarget).val()){var n=i[e].geometry,a=r.default_styles(),s=r.default_map_options();s=$.extend(!0,s,r.data.data);var c={paths:r.reverse_translate_coords(n),editable:!0,draggable:!0,type:s.geometry_type,styles:a};r.controller().add_place("object1",c),r.controller().fit_bounds()}})},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.controller=function(){return this._controller},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.object_index=function(){return++this._object_inc},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.default_styles=function(){return{strokeColor:"#000000",strokeOpacity:.8,strokeWeight:3,fillColor:"#ffffff",fillOpacity:.35,hover:{strokeColor:"#000000",strokeOpacity:1,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.5},focused:{fillOpacity:.8}}},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.default_map_options=function(){return{default_styles:this.default_styles(),use_clusterer:!1,map:{center:{x:45.3712923,y:-73.9820994},zoom:14,mapType:"roadmap",coordsType:"inpage",map_mode:"default"}}},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.display_marker_toolbar=function(){this.$map_maker.addClass("is-header-open")},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.hide_marker_toolbar=function(){this.$map_maker.removeClass("is-header-open")},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.translate_coords=function(t){for(var e=0,i=t.length,o=[];e<i;e++)o.push(t[e].join(" "));return i&&o.push(t[0].join(" ")),o.join(",")},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.reverse_translate_coords=function(t){for(var e=t.split(","),i=0,o=e.length;i<o;i++)e[i]=e[i].split(" ");return e.pop(),e},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.save=function(){if(!this.controller())return this;var t=this.controller().export(),e="object"==typeof t.places?t.places:{},i=Object.keys(e).length?this.translate_coords(e[Object.keys(e)[0]].paths):[];return this.element().find("input[type=hidden]").val(JSON.stringify(i)),this},Charcoal.Admin.Property_Input_Image=function(t){return this.EVENT_NAMESPACE=".charcoal.property.image",this.input_type="charcoal/admin/property/input/image",this.opts=t,this.data=t.data,this.set_input_id(this.opts.id).init(),this},Charcoal.Admin.Property_Input_Image.prototype=Object.create(Charcoal.Admin.Property_Input_File.prototype),Charcoal.Admin.Property_Input_Image.prototype.constructor=Charcoal.Admin.Property_Input_Image,Charcoal.Admin.Property_Input_Image.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Image.prototype.remove_file=function(t){t.preventDefault(),this.$hidden.val(""),this.$preview.empty(),this.$input.find(".form-control-plaintext").empty(),this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none")},Charcoal.Admin.Property_Input_Image.prototype.change_file=function(t){var e,i,o,r;e=new File,o=(i=t.dataTransfer||t.target)&&i.files&&i.files[0],r=URL.createObjectURL(o),e.src=r,this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$input.find(".form-control-plaintext").html(o),this.$preview.empty().append(e)},Charcoal.Admin.Property_Input_Image.prototype.elfinder_callback=function(t){if(this.dialog&&this.dialog.close(),t&&t.path){var e=$('<img src="'+t.url+'" style="max-width: 100%">');this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$input.find(".form-control-plaintext").html(t.name),this.$hidden.val(decodeURI(t.url).replace(Charcoal.Admin.base_url(),"")),this.$preview.empty().append(e)}},Charcoal.Admin.Property_Input_Map_Widget=function(t){t.input_type="charcoal/admin/property/input/map-widget",Charcoal.Admin.Property.call(this,t);var e=this;this._controller=void 0,this._object_inc=0,"undefined"==typeof google?(window._tmp_google_onload_function=function(){e.init()},$.getScript("https://maps.googleapis.com/maps/api/js?sensor=false&callback=_tmp_google_onload_function&key="+t.data.api_key,function(){})):e.init()},Charcoal.Admin.Property_Input_Map_Widget.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Map_Widget.prototype.constructor=Charcoal.Admin.Property_Input_Map_Widget,Charcoal.Admin.Property_Input_Map_Widget.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Map_Widget.prototype.init=function(){if(void 0!==window._tmp_google_onload_function&&delete window._tmp_google_onload_function,"undefined"==typeof BB||"undefined"==typeof google)return console.error("Plugins not loaded"),!1;var t=this.data;void 0===t.id&&console.error("Missing ID");var e={strokeColor:"#000000",strokeOpacity:.8,strokeWeight:3,fillColor:"#ffffff",fillOpacity:.35,hover:{strokeColor:"#000000",strokeOpacity:1,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.5},focused:{fillOpacity:.8}},i={default_styles:e,use_clusterer:!1,map:{center:{x:45.3712923,y:-73.9820994},zoom:14,mapType:"roadmap",coordsType:"inpage",map_mode:"default"}};i=$.extend(!0,i,t.data);var o=this.element().find("input[type=hidden]").val();if(o){var r=JSON.parse(o),n={},a=0;for(var s in r)a++,n[s]=r[s],n[s].styles=$.extend(r[s].styles,e);n&&(i.places=n),a&&(this._object_inc=a)}this.$map_maker=this.element().find(".js-map-maker"),this._controller=new window.BB.gmap.controller(this.element().find(".js-map-maker-map").get(0),i),this.controller().init().ready(function(t){t.fit_bounds(),t.remove_focus()}),this.controller().set_styles([{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]}]),this.controller().remove_focus();var c=this;this.element().on("change",'[name="'+this.data.controls_name+'"]',function(t){var e=$(t.currentTarget).val();switch(e){case"display_marker_toolbar":c.display_marker_toolbar();break;case"add_line":case"add_polygon":c.hide_marker_toolbar();for(var i="object"+c.object_index();c.controller().get_place(i);)i="object"+c.object_index();c.controller().create_new(e.replace("add_",""),i)}}),this.element().on("click",".js-add-marker",function(t){t.preventDefault();for(var e="object"+c.object_index();c.controller().get_place(e);)e="object"+c.object_index();c.controller().create_new("marker",e)}),this.element().on("click",".js-add_place_by_address",function(t){t.preventDefault();var e=c.element().find(".js-address").text();if(!e)return!1;c.controller().add_place_by_address("object"+c.object_index(),e,{type:"marker",draggable:!0,editable:!0,loaded_callback:function(t){c.controller().map().setCenter(t.object().getPosition())}})}),this.element().on("click",".js-reset",function(t){t.preventDefault(),c.controller().reset()})},Charcoal.Admin.Property_Input_Map_Widget.prototype.controller=function(){return this._controller},Charcoal.Admin.Property_Input_Map_Widget.prototype.object_index=function(){return++this._object_inc},Charcoal.Admin.Property_Input_Map_Widget.prototype.display_marker_toolbar=function(){this.$map_maker.addClass("is-header-open")},Charcoal.Admin.Property_Input_Map_Widget.prototype.hide_marker_toolbar=function(){this.$map_maker.removeClass("is-header-open")},Charcoal.Admin.Property_Input_Map_Widget.prototype.save=function(){var t=this.controller().export(),e="object"==typeof t.places?t.places:{};return this.element().find("input[type=hidden]").val(JSON.stringify(e)),this},Charcoal.Admin.Property_Input_SelectPicker=function(t){this.input_type="charcoal/admin/property/input/select",this.input_id=null,this.select_selector=null,this.select_options=null,this.set_properties(t).create_select()},Charcoal.Admin.Property_Input_SelectPicker.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_SelectPicker.prototype.constructor=Charcoal.Admin.Property_Input_SelectPicker,Charcoal.Admin.Property_Input_SelectPicker.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_SelectPicker.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.select_selector=t.data.select_selector||this.select_selector,this.select_options=t.data.select_options||this.select_options;return this.select_options=$.extend({},{},this.select_options),this},Charcoal.Admin.Property_Input_SelectPicker.prototype.create_select=function(){return $(this.select_selector).selectpicker(this.select_options),this},function(){var t=function(t){this.input_type="charcoal/admin/property/input/selectize",this.input_id=null,this.obj_type=null,this.remote_source=null,this.copy_items=!1,this.title=null,this.translations=null,this.pattern=null,this.multiple=!1,this.separator=",",this.selectize=null,this.selectize_selector=null,this.form_ident=null,this.selectize_options={},this.choice_obj_map={},this.selectize_property_ident=null,this.selectize_property=null,this.selectize_obj_type=null,this.selectize_templates={},this.clipboard=null,this.allow_update=null,this.set_properties(t).init()};t.prototype=Object.create(Charcoal.Admin.Property.prototype),t.constructor=Charcoal.Admin.Property_Input_Selectize,t.parent=Charcoal.Admin.Property.prototype,t.prototype.init=function(){this.init_selectize(),this.init_clipboard(),this.init_allow_update(),this.init_allow_create();var t=this;this.selectize.on("update_item",function(e){t.create_item(null,e.callback,{id:e.value,step:0})})},t.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.obj_type=t.data.obj_type||this.obj_type,this.remote_source=t.data.remote_source||this.remote_source,this.copy_items=t.data.copy_items||this.copy_items,this.allow_update=t.data.allow_update||this.allow_update,this.allow_create=t.data.allow_create||this.allow_create,this.title=t.data.title||this.title,this.translations=t.data.translations||this.translations,this.pattern=t.data.pattern||this.pattern,this.multiple=t.data.multiple||this.multiple,this.separator=t.data.multiple_separator||this.multiple_separator||",",this.form_ident=t.data.form_ident||this.form_ident,this.selectize_selector=t.data.selectize_selector||this.selectize_selector,this.selectize_options=t.data.selectize_options||this.selectize_options,this.choice_obj_map=t.data.choice_obj_map||this.choice_obj_map,this.selectize_property_ident=t.data.selectize_property_ident||this.selectize_property_ident,this.selectize_property=t.data.selectize_property||this.selectize_property,this.selectize_obj_type=t.data.selectize_obj_type||this.selectize_obj_type,this.selectize_templates=t.data.selectize_templates||this.selectize_templates,this.$input=$(this.selectize_selector||"#"+this.input_id);var e;e=this.multiple?{drag_drop:{},charcoal_item:{}}:{charcoal_item:{}};var i=this.obj_type,o=this.remote_source,r={plugins:e,formData:{},delimiter:this.separator,persist:!0,preload:"focus",openOnFocus:!0,labelField:"label",searchField:["value","label"],dropdownParent:this.$input.closest(".form-field"),render:{},onItemRemove:function(t){this.refreshOption(t)},createFilter:function(t){for(var e in this.options)if((e=this.options[e]).label===t)return!1;return!0},onInitialize:function(){var t=this;t.sifter.iterator(this.items,function(e){t.refreshItem(e,t.getItem(e))}),t.sifter.iterator(this.options,function(e){t.refreshOption(e.value)})}};if(this.selectize_templates.item&&(r.render.item=function(t,e){return t.item_render?'<div class="item">'+t.item_render+"</div>":'<div class="item">'+e(t[r.labelField])+"</div>"}),this.selectize_templates.option&&(r.render.option=function(t,e){return t.option_render?'<div class="option">'+t.option_render+"</div>":'<div class="option">'+e(t[r.labelField])+"</div>"}),o?(r.create=function(t){return{value:t,label:t}},r.load=this.load_from_remote.bind(this)):i?(r.create=this.create_item.bind(this),r.load=this.load_items.bind(this)):(r.plugins.create_on_enter={},r.create=function(t){return{value:t,label:t}}),this.selectize_options.splitOn){var n=this.selectize_options.splitOn;if("array"===$.type(n)){for(var a=n.length-1;a>=0;a--)switch(n[a]){case"comma":n[a]="\\s*,\\s*";break;case"tab":n[a]="\\t+";break;default:n[a]=n[a].replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}n=n.join("|")}this.selectize_options.splitOn=new RegExp(n)}return this.selectize_options=$.extend(!0,{},r,this.selectize_options),this},t.prototype.create_item=function(t,e,i){var o={};i=i||{};var r=this,n=this.obj_type,a=this.title,s=this.translations,c=this.selectize_options,l=i.step||0,p=this.form_ident,d=null,h=i.id||null,u=this.selectize_property,_=this.selectize_property_ident,m=this.selectize_obj_type;p&&"object"==typeof p&&(!h&&p.create?(p=p.create,a+=" - "+s.statusTemplate.replaceMap({"[[ current ]]":1,"[[ total ]]":2}),l=1,d="Next"):h&&p.update?(p=p.update,2===l&&(a+=" - "+s.statusTemplate.replaceMap({"[[ current ]]":2,"[[ total ]]":2}),d="Finish")):p=null),$.isEmptyObject(c.formData)?(t&&(o[this.choice_obj_map.label]=t),o.form_ident=p,o.submit_label=d):t&&(o=$.extend({},c.formData),$.each(o,function(e,i){":input"===i&&(o[e]=t)}));var f={title:a,size:BootstrapDialog.SIZE_WIDE,cssClass:"-quick-form",dialog_options:{onhide:function(){e({return:!1})}},widget_type:"charcoal/admin/widget/quick-form",widget_options:{obj_type:n,obj_id:h,form_data:o}};l>0&&(f.type=BootstrapDialog.TYPE_PRIMARY);var y=this.dialog(f,function(i){if(i.success){if(!i.widget_id)return!1;Charcoal.Admin.manager().add_widget({id:i.widget_id,type:"charcoal/admin/widget/quick-form",data:{obj_type:n},obj_id:h,extra_form_data:{selectize_obj_type:m,selectize_prop_ident:_,selectize_property:u},save_action:"selectize/save",update_action:"selectize/update",suppress_feedback:1===l,save_callback:function(i){var o={class:"new"},n=i.selectize[0];n&&$.extend(!0,o,n),e(o),y.close(),1===l&&r.create_item(t,e,{id:n.value,step:2})}}),Charcoal.Admin.manager().render()}})},t.prototype.load_from_remote=function(t,e){if(!t.length)return e();var i=this,o={selectize_obj_type:this.selectize_obj_type,selectize_prop_ident:this.selectize_property_ident,selectize_property:this.selectize_property};$.ajax({url:this.remote_source+encodeURIComponent(t),type:"GET",data:o,error:function(){e()},success:function(t){null!==t.optgroups&&$.each(t.optgroups,function(t,e){i.selectize.registerOptionGroup(e)}),null!==t.options?e(t.options):e(t)}})},t.prototype.load_items=function(t,e){var i=this.obj_type,o=this.selectize_property_ident,r={obj_type:i,selectize_obj_type:this.selectize_obj_type,selectize_prop_ident:o,selectize_property:this.selectize_property};$.ajax({url:Charcoal.Admin.admin_url()+"selectize/load",data:r,type:"GET",error:function(){e()},success:function(t){var i=[],o=t.selectize;for(var r in o)o.hasOwnProperty(r)&&(r=o[r],i.push(r));e(i)}})},t.prototype.dialog=Charcoal.Admin.Widget.prototype.dialog,t.prototype.init_selectize=function(){var t=this.$input.selectize(this.selectize_options);this.selectize=t[0].selectize},t.prototype.init_allow_create=function(){if(this.allow_create){var t=this.selectize,e=this;$(this.selectize_selector+"_create").on("click",function(){e.create_item(null,function(e){e&&e.value&&(t.addOption(e),t.addItem(e.value))})})}},t.prototype.init_allow_update=function(){switch(this.selectize.settings.mode){case"single":this.allow_update_single();break;case"multiple":this.allow_update_multiple()}},t.prototype.allow_update_single=function(){if(this.allow_update){var t=this.selectize,e=this;$(this.selectize_selector+"_update").on("click",function(){var i=t.items;i&&e.create_item(null,function(e){e&&e.value&&(t.updateOption(e.value,e),t.refreshOption(e.value),t.refreshItem(e.value,t.getItem(e.value)))},{id:i[0],step:0})})}},t.prototype.allow_update_multiple=function(){if(this.allow_update){var t=this.selectize,e=$(this.selectize_selector+"_update"),i=null,o=this;e[0].disabled=!0,e.on("click",function(){i&&o.create_item(null,function(e){e&&e.value&&(t.updateOption(i,e),t.refreshOption(i),t.refreshItem(i,t.getItem(e)))},{id:i,step:0})}),t.on("blur",function(){setTimeout(function(){e[0].disabled=!0},500)}),t.$control.on("mousedown","*:not(input)",function(o){i=$(o.target).eq(0).data("value"),t.$control.find(".active:not(input)")&&(e[0].disabled=!1)})}},t.prototype.init_clipboard=function(){if(this.copy_items){var t=this.selectize;this.clipboard=new Clipboard(this.selectize_selector+"_copy",{text:function(){return t.$input.val()}})}},Charcoal.Admin.Property_Input_Selectize=t}(jQuery,document),Selectize.define("btn_remove",function(t){t=$.extend({label:'<span class="fa fa-trash-o"></span>',title:"Remove",className:"selectize-button-remove",append:!0},t),this.require("buttons");"single"!==this.settings.mode&&function(t,e){var i=t;i.addButton(t,e,function(t){if(t.preventDefault(),!i.isLocked){var e=$(t.currentTarget).parent();i.setActiveItem(e),i.deleteSelection()&&i.setCaret(i.items.length)}})}(this,t)}),Selectize.define("btn_update",function(t){t=$.extend({label:'<span class="fa fa-pencil"></span>',title:"Update",className:"selectize-button-update",append:!0},t),this.require("buttons");"single"!==this.settings.mode&&function(t,e){var i=t;i.addButton(t,e,function(t){if(t.preventDefault(),!i.isLocked){var e=$(t.currentTarget).parent();i.setActiveItem(e),i.trigger("update_item",{item:e,value:e.eq(0).data("value"),callback:function(t){t&&t.value&&(i.updateOption(t.value,t),i.refreshOption(t.value,t),i.refreshItem(t.value,i.getItem(t.value)))}})}})}(this,t)}),Selectize.define("buttons",function(){this.buttonOffset=40,this.currentButtonOffset=0,this.addButton=function(t,e,i){var o=t,r='<button type="button" class="selectize-button '+e.className+'" tabindex="-1" title="'+function(t){return(t+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}(e.title)+'" style="right:'+o.currentButtonOffset+'px">'+e.label+"</a>";o.currentButtonOffset+=o.buttonOffset;t.setup=function(){var n=o.setup;return function(){if(e.append){var a=o.settings.render.item;o.settings.render.item=function(){return function(t,e){var i=$(t);return i.hasClass("item")?(i.append($(e)),i[0]):t}(function(t,e){var i=$(t);return i.hasClass("item")?(i.css("padding-right",e+8+"px"),i[0]):t}(a.apply(t,arguments),o.currentButtonOffset),r)}}n.apply(t,arguments),t.$control.on("mousedown","."+e.className,function(t){t.preventDefault();o.$control.data("ui-sortable")&&(o.$control.sortable("disable"),$(document).on("mouseup.sortable",function(){$(document).off("mouseup.sortable"),o.$control.sortable("enable")}))}),t.$control.on("click","."+e.className,function(t){"function"==typeof i&&i(t)})}}()}}),Selectize.define("create_on_blur",function(){if("multi"===this.settings.mode){var t=this;this.onBlur=function(){var e=t.onBlur;return function(){return""!==this.$control_input.val().trim()&&t.createItem(this.$control_input.val()),e.apply(this,arguments)}}()}}),Selectize.define("create_on_enter",function(){if("multi"===this.settings.mode){var t=this;this.onKeyUp=function(){var e=t.onKeyUp;return function(i){return 13===i.keyCode&&""!==this.$control_input.val().trim()&&t.createItem(this.$control_input.val()),e.apply(this,arguments)}}()}}),Selectize.define("charcoal_item",function(t){t=$.extend({classField:"class",colorField:"color"},t);var e=this,i=null;this.refreshItem=function(o,r){var n=e.options[o];if(n.hasOwnProperty(t.colorField)&&n[t.colorField]&&(r.addClass("has-color"),r.css("border-left-color",n[t.colorField])),n.hasOwnProperty(t.classField)&&r.addClass(n[t.classField]),i)return i.apply(this,arguments)},this.refreshOption=function(o){var r=e.options[o];e.refreshOptions(!1);var n=e.getElementWithValue(o,e.$dropdown_content.find(".option"));if(r.hasOwnProperty(t.colorField)&&r[t.colorField]&&(n.addClass("has-color"),n.css("border-left-color",r[t.colorField])),i)return i.apply(this,arguments)},this.settings.onOptionAdd=(i=null,e.settings.hasOwnProperty("onOptionAdd")&&(i=e.settings.onOptionAdd),e.refreshOption),this.settings.onItemAdd=(i=null,e.settings.hasOwnProperty("onItemAdd")&&(i=e.settings.onItemAdd),e.refreshItem)}),function(){var t=function(t){this.input_type="charcoal/admin/property/input/selectize/list",this.input_id=null,this.obj_type=null,this.copy_items=!1,this.title=null,this.translations=null,this.pattern=null,this.multiple=!1,this.separator=",",this.selectize=null,this.selectize_selector=null,this.form_ident=null,this.selectize_options={},this.clipboard=null,this.allow_update=!1,this.set_properties(t).init()};t.prototype=Object.create(Charcoal.Admin.Property_Input_Selectize.prototype),t.constructor=Charcoal.Admin.Property_Input_Selectize,t.parent=Charcoal.Admin.Property_Input_Selectize.prototype,t.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.obj_type=t.data.obj_type||this.obj_type,this.copy_items=t.data.copy_items||this.copy_items,this.allow_update=t.data.allow_update||this.allow_update,this.title=t.data.title||this.title,this.translations=t.data.translations||this.translations,this.pattern=t.data.pattern||this.pattern,this.multiple=t.data.multiple||this.multiple,this.separator=t.data.multiple_separator||this.multiple_separator||",",this.form_ident=t.data.form_ident||this.form_ident,this.selectize_selector=t.data.selectize_selector||this.selectize_selector,this.selectize_options=t.data.selectize_options||this.selectize_options,this.$input=$(this.selectize_selector||"#"+this.input_id);var e;e=this.multiple?{drag_drop:{},charcoal_item:{}}:{charcoal_item:{}};var i=this.obj_type,o={plugins:e,formData:{},delimiter:this.separator,persist:!0,preload:"focus",openOnFocus:!0,searchField:["value","label"],dropdownParent:this.$input.closest(".form-field"),createFilter:function(t){for(var e in this.options)if((e=this.options[e]).label===t)return!1;return!0},onInitialize:function(){var t=this;t.sifter.iterator(this.items,function(e){var i=t.options[e],o=t.getItem(e);i.color&&o.css("background-color",i.color)})}};if(i?(o.create=this.create_item.bind(this),o.load=this.load_items.bind(this)):(o.plugins.create_on_enter={},o.create=function(t){return{value:t,label:t}}),this.selectize_options.splitOn){var r=this.selectize_options.splitOn;if("array"===$.type(r)){for(var n=r.length-1;n>=0;n--)switch(r[n]){case"comma":r[n]="\\s*,\\s*";break;case"tab":r[n]="\\t+";break;default:r[n]=r[n].replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}r=r.join("|")}this.selectize_options.splitOn=new RegExp(r)}return this.selectize_options=$.extend(!0,{},o,this.selectize_options),this},Charcoal.Admin.Property_Input_Selectize_List=t}(jQuery,document),Charcoal.Admin.Property_Input_Selectize_Tags=function(t){this.input_type="charcoal/admin/property/input/selectize/tags",this.input_id=null,this.obj_type=null,this.copy_items=!1,this.title=null,this.multiple=!1,this.separator=",",this._tags=null,this.selectize=null,this.selectize_selector=null,this.selectize_options={},this.clipboard=null,this.set_properties(t).init()},Charcoal.Admin.Property_Input_Selectize_Tags.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Selectize_Tags.prototype.constructor=Charcoal.Admin.Property_Input_Selectize_Tags,Charcoal.Admin.Property_Input_Selectize_Tags.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Selectize_Tags.prototype.init=function(){if("function"!=typeof $.fn.sortable){return Charcoal.Admin.loadScript("https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js",this.init.bind(this)),this}this.init_selectize(),this.init_clipboard()},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.obj_type=t.data.obj_type||this.obj_type,this.copy_items=t.data.copy_items||this.copy_items,this.title=t.data.title||this.title,this.multiple=t.data.multiple||this.multiple,this.separator=t.data.multiple_separator||this.multiple_separator||",",this.selectize_selector=t.data.selectize_selector||this.selectize_selector,this.selectize_options=t.data.selectize_options||this.selectize_options,this.$input=$(this.selectize_selector||"#"+this.input_id);var e;e=this.multiple?["remove_button","drag_drop","charcoal_item"]:["charcoal_item"];var i=this.obj_type,o={plugins:e,formData:{},delimiter:this.separator,persist:!1,preload:!0,openOnFocus:!0,dropdownParent:this.$input.closest(".form-field"),createFilter:function(t){for(var e in this.options)if((e=this.options[e]).text===t)return!1;return!0},onInitialize:function(){var t=this;t.sifter.iterator(this.items,function(e){var i=t.options[e],o=t.getItem(e);i.color&&o.css("background-color",i.color)})}};if(i?(o.create=this.create_tag.bind(this),o.load=this.load_tags.bind(this)):(o.plugins.push("create_on_enter"),o.create=function(t){return{value:t,text:t}}),this.selectize_options=$.extend({},o,this.selectize_options),this.selectize_options.splitOn){var r=this.selectize_options.splitOn;if("array"===$.type(r)){for(var n=r.length-1;n>=0;n--)switch(r[n]){case"comma":r[n]="\\s*,\\s*";break;case"tab":r[n]="\\t+";break;default:r[n]=r[n].replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}r=r.join("|")}this.selectize_options.splitOn=new RegExp(r)}return this},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.create_tag=function(t,e){var i=this.obj_type,o=this.id,r=this.title,n=this.selectize_options,a={};$.isEmptyObject(n.formData)?a={name:t}:(a=$.extend({},n.formData),$.each(a,function(e,i){":input"===i&&(a[e]=t)}));var s={title:r,size:BootstrapDialog.SIZE_WIDE,cssClass:"-quick-form",dialog_options:{onhide:function(){e({return:!1})}},widget_type:"charcoal/admin/widget/quick-form",widget_options:{obj_type:i,obj_id:o,form_data:a}};this.dialog(s,function(t){if(t.success){if(!t.widget_id)return!1;Charcoal.Admin.manager().add_widget({id:t.widget_id,type:"charcoal/admin/widget/quick-form",data:{obj_type:i},obj_id:o,save_callback:function(t){var i=t.obj.id;"name"in t.obj&&t.obj.name&&(i=t.obj.name[Charcoal.Admin.lang()]||t.obj.name),e({value:t.obj.id,text:i,color:t.obj.color,class:"new"}),BootstrapDialog.closeAll()}})}})},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.load_tags=function(t,e){var i=this.obj_type;if(!t.length)return e();$.ajax({url:Charcoal.Admin.admin_url()+"object/load",data:{obj_type:i},type:"GET",error:function(){e()},success:function(t){var i=[];for(var o in t.collection){var r=(o=t.collection[o]).id;"name"in o&&o.name&&(r=o.name[Charcoal.Admin.lang()]||o.name),i.push({value:o.id,text:r,color:o.color})}e(i)}})},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.dialog=Charcoal.Admin.Widget.prototype.dialog,Charcoal.Admin.Property_Input_Selectize_Tags.prototype.onKeyDown=function(t){var e=!1,i=/Mac/.test(navigator.userAgent);if(this.isLocked&&9!==t.keyCode&&t.preventDefault(),"undefined"===$.type(this.isCmdDown)&&(e=!0,this.isCmdDown=t[i?"metaKey":"ctrlKey"]),this.isCmdDown&&67===t.keyCode){if(e&&(this.isCmdDown=void 0),this.$activeItems.length)for(var o=[],r=0,n=this.$activeItems.length;r<n;r++)o.push($(this.$activeItems[r]).attr("data-value")),document.execCommand("copy")}else!this.isFull()&&!this.isInputHidden||(i?t.metaKey:t.ctrlKey)||t.preventDefault()},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.init_selectize=function(){var t=this.$input.selectize(this.selectize_options);this.selectize=t[0].selectize},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.init_clipboard=function(){if(this.copy_items){var t=this.selectize;this.clipboard=new Clipboard(this.selectize_selector+"_copy",{text:function(){return t.$input.val()}})}},Charcoal.Admin.Property_Input_Text=function(t){return this.input_type="charcoal/admin/property/input/text",this.opts=t,this.data=t.data,this.set_input_id(this.opts.id),this.set_data(this.data),this.initialisation=!0,this.init(),this.initialisation=!1,this},Charcoal.Admin.Property_Input_Text.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Text.prototype.constructor=Charcoal.Admin.Property_Input_Text,Charcoal.Admin.Property_Input_Text.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Text.prototype.set_data=function(t){this.set_input_name(t.input_name),this.set_input_val(t.input_val),this.set_readonly(t.readonly),this.set_required(t.required),this.set_min_length(t.min_length),this.set_max_length(t.max_length),this.set_size(t.size),this.set_multiple(t.multiple),this.set_multiple_separator(t.multiple_separator);var e=t.multiple_options?t.multiple_options.min:0,i=t.multiple_options?t.multiple_options.max:0;this.set_multiple_min(e),this.set_multiple_max(i);var o=t.multiple_options?t.multiple_options.split_on:null;return this.set_split_on(o),this},Charcoal.Admin.Property_Input_Text.prototype.init=function(){if(!this.input_id)return this;this.$input=$("#"+this.input_id),this.multiple&&this.init_multiple()},Charcoal.Admin.Property_Input_Text.prototype.init_multiple=function(){if(this.chars_new=[13],this.chars_remove=[8,46],this.char_next=[40],this.char_prev=[38],this.currentValAmount=1,this.$container=this.$input.parent("div"),this.bind_keyboard_events(this.$input),this.split_val(this.$input),this.multiple_min)for(var t=this.multiple_min-this.currentValAmount;t>0;t--)this.add_item();return this},Charcoal.Admin.Property_Input_Text.prototype.split_val=function(t){var e=this.split_on||this.multiple_separator,i=(t=t||this.$input).val().split(e),o=0,r=i.length;if(1===r)return!1;for(;o<r;o++)if(0===o)t.val(i[o]);else if(this.initialisation||!this.multiple_max||this.currentValAmount<this.multiple_max)t=this.insert_item(t,i[o]);else{var n=t.next("input");n.length&&!n.innerHTML&&(this.remove_item(n),t=this.insert_item(t,i[o]))}return t},Charcoal.Admin.Property_Input_Text.prototype.bind_keyboard_events=function(t){var e=this,i=this.chars_new,o=this.chars_remove,r=this.char_next,n=this.char_prev;t.on("keydown",function(t){var a=t.keyCode;if(i.indexOf(a)>-1&&(!e.multiple_max||e.currentValAmount<e.multiple_max)){t.preventDefault();e.insert_item($(this)).focus()}o.indexOf(a)>-1&&(!e.multiple_min||e.currentValAmount>e.multiple_min)&&""===$(this).val()&&(t.preventDefault(),e.remove_item($(this))),n.indexOf(a)>-1&&(t.preventDefault(),$(this).prev("input").focus()),r.indexOf(a)>-1&&(t.preventDefault(),$(this).next("input").focus())}),t.on("keyup",function(){var t=e.split_val($(this));t&&t.focus()})},Charcoal.Admin.Property_Input_Text.prototype.insert_item=function(t,e){var i=this.input_clone(e);return i.insertAfter(t),this.bind_keyboard_events(i),this.currentValAmount++,i},Charcoal.Admin.Property_Input_Text.prototype.add_item=function(t){var e=this.input_clone(t);return this.$container.append(e),this.bind_keyboard_events(e),this.currentValAmount++,e},Charcoal.Admin.Property_Input_Text.prototype.remove_item=function(t){var e=t.prev("input"),i=t.next("input");return!(!e.length&&!i.length)&&(e.length?e.focus():i.length&&i.focus(),this.remove_item_listeners(t),t.remove(),this.currentValAmount--,this)},Charcoal.Admin.Property_Input_Text.prototype.remove_item_listeners=function(t){return t.off("keydown"),t.off("keyup"),this},Charcoal.Admin.Property_Input_Text.prototype.input_clone=function(t){var e=this.$input,i=e.attr("class"),o=e.attr("type"),r=this.min_length,n=this.max_length,a=this.required,s=this.readonly,c=this.input_name,l=$("<input />");return o&&l.attr("type",o),i&&l.attr("class",i),r&&l.attr("minlength",r),n&&l.attr("maxlength",n),a&&l.attr("required","required"),s&&l.attr("readonly","readonly"),t&&l.val(t),l.attr("name",c),l},Charcoal.Admin.Property_Input_Text.prototype.set_input_id=function(t){return this.input_id=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_input_name=function(t){return this.input_name=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_input_val=function(t){return this.input_val=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_readonly=function(t){return t||(t=!1),this.readonly=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_required=function(t){return t||(t=!1),this.required=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_min_length=function(t){return t||(t=0),this.min_length=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_max_length=function(t){return t||(t=0),this.max_length=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_size=function(t){return t||(t=0),this.size=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_multiple=function(t){return t||(t=!1),this.multiple=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_multiple_min=function(t){return t||(t=!1),this.multiple_min=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_multiple_max=function(t){return t||(t=!1),this.multiple_max=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_multiple_separator=function(t){return t||(t=","),this.multiple_separator=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_split_on=function(t){if(t){if("array"===$.type(t)){for(var e=t.length-1;e>=0;e--)switch(t[e]){case"comma":t[e]="\\s*,\\s*";break;case"tab":t[e]="\\t+";break;case"newline":t[e]="[\\n\\r]+";break;default:t[e]=t[e].replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}t=t.join("|")}t=new RegExp(t)}else t=this.multiple_separator;return this.split_on=t,this},Charcoal.Admin.Property_Input_Tinymce=function(t){this.input_type="charcoal/admin/property/input/tinymce",this.input_id=null,this.data=t.data,this.editor_options=null,this._editor=null,window.elFinderCallback||(window.elFinderCallback={}),this.set_properties(t),this.init()},Charcoal.Admin.Property_Input_Tinymce.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Tinymce.prototype.constructor=Charcoal.Admin.Property_Input_Tinymce,Charcoal.Admin.Property_Input_Tinymce.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Tinymce.prototype.init=function(){this.create_tinymce()},Charcoal.Admin.Property_Input_Tinymce.prototype.base_url=function(){return Charcoal.Admin.base_url()+"assets/admin/scripts/vendors/tinymce"},Charcoal.Admin.Property_Input_Tinymce.prototype.set_properties=function(t){this.input_id=t.input_id||this.input_id,this.editor_options=t.editor_options||t.data.editor_options||this.editor_options,window.elFinderCallback[this.input_id]=this.elfinder_callback.bind(this);var e=Charcoal.Admin.locale().match(/([a-zA-Z]{2})(_|-)([a-zA-Z]{2})/)[0]||"en";(e=e.replace("-","_")).match(/en_/)&&(e="en");var i={language:e,plugins:["advlist","anchor","autolink","autoresize","charcoal","charmap","code","colorpicker","contextmenu","fullscreen","hr","image","link","lists","media","nonbreaking","noneditable","paste","placeholder","searchreplace","tabfocus","table","visualblocks","visualchars","wordcount"],toolbar:"undo redo | styleselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image anchor",browser_spellcheck:!0,end_container_on_empty_block:!0,entity_encoding:"raw",allow_conditional_comments:!0,convert_fonts_to_spans:!0,forced_root_block:"p",allow_script_urls:!1,document_base_url:Charcoal.Admin.base_url(),relative_urls:!0,remove_script_host:!1,autoresize_min_height:"150px",autoresize_max_height:"400px",contextmenu:"link image inserttable | cell row column deletetable",file_picker_callback:$.proxy(this.elfinder_browser,null,this),image_advtab:!0,importcss_append:!0,media_alt_source:!1,nonbreaking_force_tab:!1,paste_data_images:!0,paste_as_text:!0,paste_merge_formats:!0,root_lang_attr:$("#"+this.input_id).closest("[data-lang]").data("lang"),table_grid:!0,table_tab_navigation:!0,visualblocks_default_state:!1,automatic_uploads:!0,images_upload_url:"tinymce/upload/image"};return"plugins"in i&&"plugins"in this.editor_options&&("string"===$.type(this.editor_options.plugins)&&(this.editor_options.plugins=this.editor_options.plugins.split(" ")),$.each(this.editor_options.plugins,function(t,e){var o,r=0===e.indexOf("!");if(r&&(e=e.slice(1)),r)for(;(o=i.plugins.indexOf(e))>-1;)delete i.plugins[o];else-1===i.plugins.indexOf(e)&&i.plugins.push(e)}),delete this.editor_options.plugins),this.editor_options=$.extend({},i,this.editor_options),this.editor_options.selector="#"+this.input_id,this.editor_options.setup=function(t){t.on("change",function(){window.tinymce.triggerSave()})},this},Charcoal.Admin.Property_Input_Tinymce.prototype.create_tinymce=function(){var t=this;if("object"!=typeof window.tinyMCE){var e=this.base_url()+"/tinymce.min.js";return Charcoal.Admin.loadScript(e,this.create_tinymce.bind(this)),this}window.tinyMCE.dom.Event.domLoaded=!0,window.tinyMCE.baseURI=new window.tinyMCE.util.URI(this.base_url()),window.tinyMCE.baseURL=this.base_url(),window.tinyMCE.suffix=".min",window.tinyMCE.PluginManager.get(this.input_id)||(window.tinyMCE.PluginManager.add(this.input_id,function(e){t.set_editor(e)}),"array"!==$.type(this.editor_options.plugins)&&(this.editor_options.plugins=[]),this.editor_options.plugins.push(this.input_id)),window.tinyMCE.init(this.editor_options)},Charcoal.Admin.Property_Input_Tinymce.prototype.elfinder_callback=function(t,e){parent.tinyMCE.activeEditor.windowManager.getParams().oninsert(t,e),parent.tinyMCE.activeEditor.windowManager.close()},Charcoal.Admin.Property_Input_Tinymce.prototype.elfinder_browser=function(t,e,i,o){var r=this;return window.tinyMCE.activeEditor.windowManager.open({file:t.data.elfinder_url+"&"+$.param(o),title:t.data.dialog_title||"",width:900,height:450,resizable:"yes"},{oninsert:function(t,i){var n,a,s,c;for(n=t.url,a=/\/[^/]+?\/\.\.\//;n.match(a);)n=n.replace(a,"/");0===(c=r.selection.getContent()).length&&"A"===r.selection.getNode().nodeName&&(c=r.selection.getNode().textContent),s=t.name+" ("+i.formatSize(t.size)+")","file"===o.filetype&&e(n,{text:c||s,title:s}),"image"===o.filetype&&e(n,{alt:s}),"media"===o.filetype&&e(n)}}),!1},Charcoal.Admin.Property_Input_Tinymce.prototype.set_editor=function(t){return this._editor=t,this},Charcoal.Admin.Property_Input_Tinymce.prototype.editor=function(){return this._editor},Charcoal.Admin.Property_Input_Tinymce.prototype.destroy=function(){var t=this.editor();t&&t.remove()},Charcoal.Admin.Template=function(t){window.alert("Template "+t)},Charcoal.Admin.Template_Login=function(t){this.template_type="charcoal/admin/template/login",this.init(t)},Charcoal.Admin.Template_Login.prototype=Object.create(Charcoal.Admin.Template.prototype),Charcoal.Admin.Template_Login.prototype.constructor=Charcoal.Admin.Template_Login,Charcoal.Admin.Template_Login.prototype.parent=Charcoal.Admin.Template.prototype,Charcoal.Admin.Template_Login.prototype.init=function(t){window.console.debug(t),this.bind_events()},Charcoal.Admin.Template_Login.prototype.bind_events=function(){var t=$("#login-form");t.on("submit.charcoal.login",$.proxy(this.onSubmit,this)),window.CharcoalCaptchaLoginCallback=this.submitForm.bind(this,t)},Charcoal.Admin.Template_Login.prototype.onSubmit=function(t){t.preventDefault();var e=$(t.currentTarget),i=Charcoal.Admin.recaptcha();i.hasInvisibleWidget(e,"#g-recaptcha-challenge")?i.getApi().execute():this.submitForm.call(this,e)},Charcoal.Admin.Template_Login.prototype.submitForm=function(t){var e=this,i=t.prop("action")||window.location.href,o=t.serialize(),r=Charcoal.Admin.queryParams();"redirect_to"in r&&(o=o.concat("&next_url="+encodeURIComponent(r.redirect_to))),$.post(i,o,Charcoal.Admin.resolveJqXhrFalsePositive.bind(this),"json").done(function(t){var i=t.next_url||Charcoal.Admin.admin_url(),o=e.parseFeedbackAsHtml(t)||authL10n.authSuccess,r=function(){window.location.href=i};o+="<p>"+authL10n.postLoginRedirect+" "+authL10n.postLoginFallback.replace("[[ url ]]",i)+"</p>",BootstrapDialog.show({title:authL10n.loginTitle,message:o,type:BootstrapDialog.TYPE_SUCCESS,onhidden:r}),setTimeout(r,300)}).fail(function(t,i,o){var r=Charcoal.Admin.parseJqXhrResponse(t,i,o),n=e.parseFeedbackAsHtml(r)||authL10n.authFailed,a=Charcoal.Admin.recaptcha(),s=null;a.hasApi()&&(s=function(){a.getApi().reset()}),BootstrapDialog.show({title:authL10n.loginTitle,message:n,type:BootstrapDialog.TYPE_DANGER,onhidden:s})})},Charcoal.Admin.Template_Login.prototype.parseFeedbackAsHtml=function(t){if(t.feedbacks&&(t=t.feedbacks),!1===Array.isArray(t)||0===t.length)return null;if(0===t.length)return null;var e,i,o=Charcoal.Admin.feedback(t),r=o.getMessagesMap();i="<p>";for(e in r)i+=r[e].join("</p><p>");return i+="</p>",o.empty(),"<p></p>"===i?null:i},Charcoal.Admin.Template_MenuHeader=function(){$(".js-toggle-class").click(function(t){t.preventDefault();var e=$(this),i=e.data("class"),o=e.data("target");$(o).toggleClass(i)}),$(document).on("click",".js-accordion-header",function(t){t.preventDefault();$(this).toggleClass("is-open").siblings(".js-accordion-content").stop().slideToggle()})},Charcoal.Admin.Template_Account_LostPassword=function(t){this.template_type="charcoal/admin/template/account/lost-password",this.init(t)},Charcoal.Admin.Template_Account_LostPassword.prototype=Object.create(Charcoal.Admin.Template.prototype),Charcoal.Admin.Template_Account_LostPassword.prototype.constructor=Charcoal.Admin.Template_Account_LostPassword,Charcoal.Admin.Template_Account_LostPassword.prototype.parent=Charcoal.Admin.Template.prototype,Charcoal.Admin.Template_Account_LostPassword.prototype.init=function(t){window.console.debug(t),this.bind_events()},Charcoal.Admin.Template_Account_LostPassword.prototype.bind_events=function(){var t=$("#lost-password-form");t.on("submit.charcoal.password",$.proxy(this.onSubmit,this)),window.CharcoalCaptchaResetPassCallback=this.submitForm.bind(this,t)},Charcoal.Admin.Template_Account_LostPassword.prototype.onSubmit=Charcoal.Admin.Template_Login.prototype.onSubmit,Charcoal.Admin.Template_Account_LostPassword.prototype.parseFeedbackAsHtml=Charcoal.Admin.Template_Login.prototype.parseFeedbackAsHtml,Charcoal.Admin.Template_Account_LostPassword.prototype.submitForm=function(t){var e=this,i=t.prop("action")||window.location.href,o=t.serialize();$.post(i,o,Charcoal.Admin.resolveJqXhrFalsePositive.bind(this),"json").done(function(t){var i=e.parseFeedbackAsHtml(t)||authL10n.lostPassSuccess;BootstrapDialog.show({title:authL10n.lostPassword,message:i,type:BootstrapDialog.TYPE_SUCCESS,onhidden:function(){window.location.href=t.next_url||Charcoal.Admin.admin_url("login?notice=resetpass")}})}).fail(function(t,i,o){var r=Charcoal.Admin.parseJqXhrResponse(t,i,o),n=e.parseFeedbackAsHtml(r)||authL10n.lostPassFailed,a=Charcoal.Admin.recaptcha(),s=null;a.hasApi()&&(s=function(){a.getApi().reset()}),BootstrapDialog.show({title:authL10n.lostPassword,message:n,type:BootstrapDialog.TYPE_DANGER,onhidden:s})})},Charcoal.Admin.Template_Account_ResetPassword=function(t){this.template_type="charcoal/admin/template/account/reset-password",this.init(t)},Charcoal.Admin.Template_Account_ResetPassword.prototype=Object.create(Charcoal.Admin.Template.prototype),Charcoal.Admin.Template_Account_ResetPassword.prototype.constructor=Charcoal.Admin.Template_Account_ResetPassword,Charcoal.Admin.Template_Account_ResetPassword.prototype.parent=Charcoal.Admin.Template.prototype,Charcoal.Admin.Template_Account_ResetPassword.prototype.init=function(t){window.console.debug(t),this.bind_events()},Charcoal.Admin.Template_Account_ResetPassword.prototype.bind_events=function(){var t=$("#reset-password-form");t.on("submit.charcoal.password",$.proxy(this.onSubmit,this)),window.CharcoalCaptchaChangePassCallback=this.submitForm.bind(this,t)},Charcoal.Admin.Template_Account_ResetPassword.prototype.onSubmit=Charcoal.Admin.Template_Login.prototype.onSubmit,Charcoal.Admin.Template_Account_ResetPassword.prototype.parseFeedbackAsHtml=Charcoal.Admin.Template_Login.prototype.parseFeedbackAsHtml,Charcoal.Admin.Template_Account_ResetPassword.prototype.submitForm=function(t){var e=this,i=t.prop("action")||window.location.href,o=t.serialize();$.post(i,o,Charcoal.Admin.resolveJqXhrFalsePositive.bind(this),"json").done(function(t){var i=e.parseFeedbackAsHtml(t)||authL10n.resetPassSuccess;BootstrapDialog.show({title:authL10n.passwordReset,message:i,type:BootstrapDialog.TYPE_SUCCESS,onhidden:function(){window.location.href=t.next_url||Charcoal.Admin.admin_url("login?notice=newpass")}})}).fail(function(t,i,o){var r=Charcoal.Admin.parseJqXhrResponse(t,i,o),n=e.parseFeedbackAsHtml(r)||authL10n.resetPassFailed,a=Charcoal.Admin.recaptcha(),s=null;a.hasApi()&&(s=function(){a.getApi().reset()}),BootstrapDialog.show({title:authL10n.passwordReset,message:n,type:BootstrapDialog.TYPE_DANGER,onhidden:s})})};