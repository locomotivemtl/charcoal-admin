/*! @locomotivemtl/charcoal-admin */
$.fn.enable=function(){return this.each(function(){$(this).removeAttr("disabled").prop("disabled",!1)}),this},$.fn.disable=function(){return this.each(function(){$(this).attr("disabled",!0).prop("disabled",!0)}),this},$.fn.exists=function(){return 0<this.length},$.fn.or=function(){return this.length?this:$.apply($,arguments)},jQuery.getCachedScript=function(t,e){return e=$.extend(e||{},{dataType:"script",cache:!0,url:t}),jQuery.ajax(e)},RegExp.escape||(RegExp.escape=function(t){return t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}),window.CustomEvent&&"function"==typeof window.CustomEvent||(window.CustomEvent=function(){function t(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var i=document.createEvent("CustomEvent");return i.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),i}return t.prototype=window.Event.prototype,t}()),window.Promise||(window.Promise=function(){function e(t){this.catch=this.catch.bind(this),this.then=this.then.bind(this),this.deferred=$.Deferred(),t(this.deferred.resolve,this.deferred.reject)}return e.prototype.then=function(t,e){return this.deferred.then(t,e)},e.prototype.catch=function(t){return this.then(void 0,t)},e.prototype.finally=function(t){return this.deferred.always(t)},e.all=function(t){return $.when.apply($,[this.resolve()].concat(t.slice()))},e.allSettled=function(t){t=t.map(function(t){e.resolve(t).then(function(t){return{state:"fulfilled",value:t}},function(t){return{state:"rejected",reason:t}})});return this.all(t)},e.race=function(t){for(var i=!1,o=$.Deferred(),e=function(t,e){i||(i=!0,o[t](e))},r=e.apply(this,"resolve"),n=e.apply(this,"reject"),a=0,s=t.length;a<s;a++)t[a].then(r,n);return o.promise()},e.reject=function(t){var e=$.Deferred();return e.reject(t),e.promise()},e.resolve=function(t){var e=$.Deferred();return e.resolve(t),e.promise()},e}()),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(null==this)throw new TypeError('"this" is null or not defined');if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e=Object(this),i=e.length>>>0,o=arguments[1],r=0;r<i;){var n=e[r];if(t.call(o,n,r,e))return n;r++}}}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),i=1;i<arguments.length;i++){var o=arguments[i];if(null!=o)for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r])}return e},writable:!0,configurable:!0}),String.prototype.replacePairs||Object.defineProperty(String.prototype,"replaceMap",{value:function(o){var t,e=[];for(t in o)t instanceof RegExp?this.replace(t,o[t]):e.push(RegExp.escape(t));return 0===e.length?this:(e=new RegExp(e.join("|"),"g"),this.replace(e,function(t){var e,i=o[t];return"function"==typeof i?i(t,(e=Array.prototype.slice.call(arguments,-2))[0],e[1]):i}))}});var Charcoal=Charcoal||{},globalXHR=(Charcoal.Admin=function(){"use strict";for(var e,t,i,o,r,n,a,s=document.documentElement.getAttribute("locale"),l=document.documentElement.lang,c="en",d=36,p="";d--;)p+=d.toString(36);function h(){}return e={debug:!(a={}),base_url:null,admin_url:null,admin_path:null},h.debug=function(t){if(arguments.length){if("boolean"!=typeof t)throw new TypeError("Must be a boolean, received "+typeof t);e.debug=t}return e.debug||!1},h.devMode=function(t){return h.debug(t)},h.locale=function(){return s},h.lang=function(t){return"string"==typeof t?l===t:l||c},h.defaultLang=function(t){return"string"==typeof t?c===t:c},h.set_lang=h.setLang=function(t){if(null===t)l=document.documentElement.lang||c;else{if("string"!=typeof t)throw new TypeError("Must be a language code, received "+typeof mode);l=t||document.documentElement.lang||c}return l},h.set_data=function(t){e=$.extend(!0,e,t)},h.admin_url=function(t){return e.admin_url+("string"==typeof t?t:"")},h.base_url=function(){return e.base_url},h.is_absolute_url=function(t){return/(?:^[a-z][a-z0-9+\.-]*:|\/\/)/i.test(t)},h.redirect_to_url=function(t){window.location.href=h.is_absolute_url(t)?t:Charcoal.Admin.admin_url()+t},h.manager=function(){return t=void 0===t?new Charcoal.Admin.ComponentManager:t},h.action=function(){return i=void 0===i?new Charcoal.Admin.ActionManager:i},h.queryParams=function(){var t=location.search.slice(1).split("&"),e={};return t.forEach(function(t){(t=t.split("="))[1]&&(e[t[0]]=decodeURIComponent(t[1]||""))}),JSON.parse(JSON.stringify(e))},h.feedback=function(){return void 0===o&&(o=new Charcoal.Admin.Feedback),arguments.length&&o.push.apply(o,arguments),o},h.recaptcha=function(){return r=void 0===r?new Charcoal.Admin.ReCaptcha:r},h.get_object_name=function(t){var e=t.split("/");return(e=e.splice(2,e.length)).forEach(function(t,e,i){var o=t.split("-");1<o.length&&(o.forEach(function(t,e){o[e]=t.charAt(0).toUpperCase()+t.slice(1)}),t=o.join("_")),i[e]=t.charAt(0).toUpperCase()+t.slice(1)}),t=e.join("_")},h.parseNumber=function(t){return/^(\-|\+)?([0-9]+(\.[0-9]+)?|Infinity)$/.test(t)?Number(t):t},h.loadScript=function(e,t){this.store(e,function(t){$.ajax({url:e,dataType:"script",success:t.resolve,error:t.reject})}).then(t)},h.store=function(t,e,i){return a[t]||"function"==typeof e&&(a[t]=$.Deferred(function(t){e(t)}).promise()),"function"==typeof a[t]?a[t].done(i):a[t]},h.cache=function(){return void 0===n&&(n=new Charcoal.Admin.Cache),arguments.length&&n.purge.apply(n,arguments),n},h.uid=function(t){for(var e="",i=t||11;i--;)e+=p[36*Math.random()|0];return e},h.parseJqXhrArgs=function(){var t={failed:!0,jqXHR:null,textStatus:"",errorThrown:"",response:null};return arguments[2]&&"string"===$.type(arguments[2])?(t.jqXHR=arguments[0]||null,t.textStatus=arguments[1]||null,t.errorThrown=arguments[2]||null,t.response=arguments[3]||t.jqXHR.responseJSON||null,"object"===$.type(t.response)?t.failed=!t.response.success:t.failed=!0):(t.response=arguments[0]||null,t.textStatus=arguments[1]||null,t.jqXHR=arguments[2]||null,(t.errorThrown=null)===t.response&&(t.response=t.jqXHR.responseJSON),"object"===$.type(t.response)?t.failed=!t.response.success:t.failed=!1),t},h.parseJqXhrResponse=function(t,e,i){var o={success:!1,feedbacks:[]};return t.responseJSON&&$.extend(o,t.responseJSON),0===o.feedbacks.length&&(o.message?o.feedbacks=Array.isArray(o.message)?o.message:[{level:"error",message:o.message}]:o.feedbacks=Array.isArray(i)?i:[{level:"error",message:i}]),o},h.resolveJqXhrFalsePositive=function(t,e,i){return t&&t.success&&!t.error?$.Deferred().resolve(t,e,i):t.message?$.Deferred().reject(i,"error",t.message):t.feedbacks?$.Deferred().reject(i,"error",t.feedbacks):$.Deferred().reject(i,"error","")},h.resolveSimpleJsonXhr=function(t,o,r,e){return t=t.then(this.resolveJqXhrFalsePositive),"function"==typeof o&&(t=t.done(function(t,e,i){0===(t=$.extend({success:!0,feedbacks:[]},t)).feedbacks.length&&t.message&&(t.feedbacks=Array.isArray(t.message)?t.message:[{level:"notice",message:t.message}]),o.call(i,t)})),"function"==typeof r&&(t=t.fail(function(t,e,i){var o={success:!1,feedbacks:[]};t.responseJSON&&$.extend(o,t.responseJSON),0===o.feedbacks.length&&(o.message?o.feedbacks=Array.isArray(o.message)?o.message:[{level:"error",message:o.message}]:o.feedbacks=Array.isArray(i)?i:[{level:"error",message:i}]),o=$.extend({success:!1,feedbacks:[]},o),r.call(t,o)})),t="function"==typeof e?t.always(function(){e.call(t)}):t},h}(),!function(r,n,t){"use strict";function e(){return r(this.init.bind(this)),this}var a=r(t),t=".charcoal.cache",s={FLUSH:"flush"+t,FLUSHED:"flushed"+t,CLICK:"click"+t},i='[data-clear="cache"]',o='[data-purge="cache"]',l="clear",c="purge",d=null,p=null,h=null,u=null,_=!1,m=!1,f=(e.prototype.init=function(){a.off(s.CLICK).on(s.CLICK,i,this.onClear.bind(this)).on(s.CLICK,o,this.onPurge.bind(this))},e.prototype.isFlushing=function(){return m},e.prototype.lastAction=function(){return p},e.prototype.lastCacheType=function(){return h},e.prototype.lastTarget=function(){return u},e.prototype.lastXhr=function(){return d},e.prototype.resolveType=function(t){return t.data("cacheType")||null},e.prototype.resolveKey=function(t){return t.data("cacheKey")||null},e.prototype.onClear=function(t){var e,i;t.preventDefault(),_=!0,u=t.currentTarget,e=r(t.currentTarget),i=t.cacheType||this.resolveType(e),t=t.cacheKey||this.resolveKey(e),i&&this.clear(i,t),_=!1},e.prototype.onPurge=function(t){var e,i;t.preventDefault(),_=!0,u=t.currentTarget,e=r(t.currentTarget),i=t.cacheType||this.resolveType(e),t=t.cacheKey||this.resolveKey(e),i&&this.purge(i,t),_=!1},e.prototype.clear=function(t,e){this.flush(l,t,e)},e.prototype.purge=function(t,e){this.flush(c,t,e)},e.prototype.flush=function(t,e,i){var o;!0!==m&&(p=t=t!==l&&t!==c?c:t,h=e,!(m=!(d=null))===_&&(u=null),o=r.Event(s.FLUSH,{cacheManager:this,cacheAction:t,cacheType:h,relatedTarget:u}),a.trigger(o),o.isDefaultPrevented()||(o={},e&&(o.cache_type=e),i&&(o.cache_key=i),e={url:n.admin_url()+"system/cache/"+t,data:o,dataType:"json",context:this},d=r.post(e).then(f).done(y).fail(g).always(b)))},function(t,e,i){var o;return t&&t.success?r.Deferred().resolveWith(this,[t,e,i]):(o={},t.feedbacks&&r.isArray(t.feedbacks)&&(o=A(t).message),r.Deferred().rejectWith(this,[i,e,o]))}),y=function(t){window.console.debug(t);t=A(t).message;BootstrapDialog.show({title:cacheL10n.title,message:t||cacheL10n.cleared,type:BootstrapDialog.TYPE_SUCCESS})},g=function(t,e,i){t=t.responseJSON,t=A(t).message;!1===n.debug()&&(i=cacheL10n.failed),BootstrapDialog.show({title:cacheL10n.title,message:t||i||cacheL10n.failed,type:BootstrapDialog.TYPE_DANGER})},b=function(){m=!1;var t=r.Event(s.FLUSH,{cacheManager:this,cacheAction:p,cacheType:h,relatedTarget:u});a.trigger(t)},A=function(t){var e;return(e=t&&t.feedbacks&&t.feedbacks.length?t.feedbacks.shift():e)||{}};n.Cache=e,n.cache()}(jQuery,Charcoal.Admin,document),!function(l,e){"use strict";function t(){this.isReady=!1,this.components={};var t=this;l(e).ready(function(){t.render()})}var c=l(e),d=l.Deferred(),p=1;t.prototype.add_property_input=function(t){return this.add_component("property_inputs",t)},t.prototype.add_widget=function(t){return this.add_component("widgets",t)},t.prototype.add_template=function(t){return this.add_component("templates",t)},t.prototype.add_component=function(t,e){if(!e.type)return console.error("Unable to store component:","missing type"),!1;var i=Charcoal.Admin.get_object_name(e.type),o="Charcoal.Admin."+i;if("function"!=typeof Charcoal.Admin[i])return console.error("Unable to store component ["+o+"]:","missing class"),!1;if(e.ident=i,Array.isArray(this.components[t])){if(e.id&&this.components[t].length){var r,i=this.components[t].find(function(t){return t._id&&t._id===e.id||t.id&&t.id===e.id});if(i)return o="Unable to store component ["+o+"]:",r=e.id+" already registered",i._type&&i._type===e.type||i.type&&i.type===e.type?console.warn(o,r):console.error(o,r),!1}}else this.components[t]=[];return this.components[t].push(e),!0},t.prototype.get_property_inputs=function(){return Array.isArray(this.components.property_inputs)?this.components.property_inputs:[]},t.prototype.get_property_input=function(t){return this.get_component("property_inputs",t)},t.prototype.get_widgets=function(){return Array.isArray(this.components.widgets)?this.components.widgets:[]},t.prototype.get_widget=function(t){return this.get_component("widgets",t)},t.prototype.get_templates=function(){return Array.isArray(this.components.templates)?this.components.templates:[]},t.prototype.get_template=function(t){return this.get_component("templates",t)},t.prototype.get_component=function(t,e){if(this.isReady)return t in this.components?this.components[t].find(function(t){return t._id===e}):null;throw new Error("Components must be rendered.")},t.prototype.has_component=function(t,e){return t in this.components&&this.components[t].some(function(t){return!(!t._id||t._id!==e)||!(!t.id||t.id!==e)})},t.prototype.destroy_component=function(t,e){if(!this.isReady)throw new Error("Components must be rendered.");t in this.components&&(this.components[t]=this.components[t].filter(function(t){return t._id!==e||("function"==typeof t.destroy&&t.destroy(),!1)}))},t.prototype.remove_component=function(t,e){if(!this.isReady)throw new Error("Components must be rendered.");t in this.components&&(this.components[t]=this.components[t].filter(function(t){return t._id!==e}))},t.prototype.ready=function(t){return d.promise().done(t),this},t.prototype.render=function(){var t=l.Event("render.charcoal.components",{relatedTarget:this});if(c.trigger(t),!t.isDefaultPrevented()){for(var e in this.components){var i=Charcoal;switch(e){case"widgets":i=Charcoal.Admin.Widget;break;case"property_inputs":i=Charcoal.Admin.Property;break;case"templates":i=Charcoal.Admin.Template}for(var o=0,r=this.components[e].length;o<r;o++){var n=this.components[e][o];if(n instanceof i)"function"==typeof n.destroy&&(n.destroy(),n.init());else try{var a=this.create_component(n.ident,n);this.components[e][o]=a,"widgets"===e&&(Charcoal.Admin.Widget.call(a,n),a.init())}catch(t){var s="Charcoal.Admin."+n.ident;n.id?console.error("Was not able to instantiate component ["+s+"] ("+n.id+")"):console.error("Was not able to instantiate component ["+s+"]"),console.error(t)}}}return this.isReady?this:(this.isReady=!0,0<--p?void 0:(d.resolveWith(this),t=l.Event("rendered.charcoal.components",{relatedTarget:this}),c.trigger(t),this))}},t.prototype.create_component=function(t,e){if(!t)throw new TypeError("Expected component data to include ident");if(Charcoal.Admin[t])return new Charcoal.Admin[e.ident](e);throw new TypeError("Expected component [Charcoal.Admin."+t+"] to exist")},t.prototype.prepare_submit=function(t){return this.prepare_inputs(t)&&this.prepare_widgets(t)},t.prototype.prepare_inputs=function(t){var e=this.get_property_inputs();return this.prepare_components(e,t)},t.prototype.prepare_widgets=function(t){var e=this.get_widgets();return this.prepare_components(e,t)},t.prototype.prepare_components=function(t,e){if(t.length){for(var i,o,r=t.length,n=0;n<r;n++)if(("function"!=typeof(i=t[n]).will_validate||!1!==i.will_validate(e))&&"function"==typeof i.validate&&!1===(o=i.validate(e)))return o;for(n=0;n<r;n++)if(("function"!=typeof(i=t[n]).will_save||!1!==i.will_save(e))&&"function"==typeof i.save&&!1===(o=i.save(e)))return o}return!0},Charcoal.Admin.ComponentManager=t}(jQuery,document),!function(o,t){"use strict";function e(){o(i).on("click",".js-action-button",function(t){this.handle_action(t)}.bind(this))}var i=o(t);e.prototype.handle_action=function(t){t.preventDefault();t=o(t.target).attr("href");this.xhr=o.ajax({type:"GET",url:t,processData:!1,contentType:!1}),this.xhr.then(o.proxy(this.request_done,this)).done(o.proxy(this.request_success,this)).fail(o.proxy(this.request_failed,this)).always(o.proxy(this.request_complete,this))},e.prototype.request_done=function(t,e,i){return t&&t.success||!t.feedbacks?o.Deferred().resolve(t,e,i):o.Deferred().reject(i,e,t.feedbacks)},e.prototype.request_success=function(t){t.feedbacks&&Charcoal.Admin.feedback(t.feedbacks)},e.prototype.request_failed=function(t,e,i){t.responseJSON&&t.responseJSON.feedbacks?Charcoal.Admin.feedback(t.responseJSON.feedbacks):(t=i||commonL10n.errorOccurred,Charcoal.Admin.feedback([{level:"error",message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":"There was an error. Sorry for the inconvenience.","[[ errorThrown ]]":t})}]))},e.prototype.request_complete=function(){Charcoal.Admin.feedback().dispatch()},Charcoal.Admin.ActionManager=e,new Charcoal.Admin.ActionManager}(jQuery,document),!function(n){"use strict";n.SimpleAudioElement=function(t){var e,i,o,r=typeof t;switch(!0){case t instanceof HTMLAudioElement:t={element:t};break;case t instanceof URL:case"string"==r:t={src:t};break;case"function"==r:t={factory:t};break;case"object"==r:break;default:t={}}if(e=t.element instanceof HTMLAudioElement?t.element:new n.Audio,t.properties)for(i in t.properties)e[i]=t.properties[i];if(t.listeners)for(i in t.listeners)"on"+i in HTMLAudioElement.prototype&&(o=t.listeners[i],(o=Array.isArray(o)?o:[o]).forEach(function(t,e,i){t.addEventListener(e,i)}.bind(null,e,i)));return t.src&&(e.src=t.src),this.getElement=function(){return e},this.isPlaying=function(){return!e.paused&&!e.ended&&0<e.currentTime},this.reset=function(){e.src=""},this.src=function(t){e.src=t},this.stop=function(){e.pause(),e.currentTime=0},this.canPlayType=function(){return e.canPlayType.apply(e,arguments).replace(/no/,"")},this.load=function(){return e.load.apply(e,arguments)},this.pause=function(){return e.pause.apply(e,arguments)},this.play=function(){return e.play.apply(e,arguments)},this}}(window),!function(c,i){"use strict";function t(){r=s.supported.slice(),e=s.displayModes.slice(),n=c.extend({},s.definitions),a=c.extend({},s.aliases)}function o(){return this.empty(),arguments.length&&this.push.apply(this,arguments),this}var r,e,n,a,s={displayModes:["dialog","toast"],supported:["success","info","notice","warning","error","danger"],definitions:{success:{title:commonL10n.success,display:"toast",type:BootstrapDialog.TYPE_SUCCESS},notice:{title:commonL10n.notice,display:"toast",type:BootstrapDialog.TYPE_INFO,alias:["info"]},warning:{title:commonL10n.warning,display:"dialog",type:BootstrapDialog.TYPE_WARNING},error:{title:commonL10n.errorOccurred,display:"dialog",type:BootstrapDialog.TYPE_DANGER,alias:["danger"]}},aliases:{info:"notice",danger:"error"},delay:3200},l=(o.prototype.validContext=function(t){return"string"===c.type(t)},o.prototype.parseContext=function(t){if("undefined"===c.type(t))t="global";else{var e=c.type(t);if("string"!==e)throw new TypeError("Storage key must be a string, received "+e)}if(t in this.storage)return t;throw new TypeError("Invalid key, received "+t)},o.prototype.resolveAliases=function(t){this.assertValidLevel(t);for(var e,i=t,o=(t=n[t]).alias.length-1;0<=o;o--)e=t.alias[o],a[e]=i;return this},o.prototype.push=function(){var t=arguments[0],e=arguments;this.validContext(t)?e=Array.prototype.slice.call(arguments,1):t="global";for(var i,o=0;o<e.length;o++)i=e[o],"array"===c.type(i)?this.push.apply(this,[t].concat(i)):(i="object"!==c.type(i)||i instanceof l?i:l.createFromObject(i))instanceof l&&this.storage.push(i);return this},o.prototype.getMessages=function(){return this.storage},o.prototype.countMessages=function(){return this.storage.length},o.prototype.hasMessages=function(){return 0<this.countMessages()},o.prototype.validMessage=function(t){return"string"===c.type(t)},o.prototype.getMessagesMap=function(){return this.getMessagesMapByLevel()},o.prototype.getMessagesMapByLevel=function(){return this.hasMessages()?this.groupMessagesByLevel(this.getMessages()):{}},o.prototype.groupMessagesByLevel=function(t){if(!t.length)return{};for(var e,i,o={},r=0;r<t.length;r++)(e=(i=t[r]).level())in o||(o[e]=[]),o[e].push(i);return o},o.prototype.availableLevels=function(){return r},o.prototype.levels=function(){return n},o.prototype.level=function(t){return n[t]||null},o.prototype.setLevels=function(t){var e,i=c.type(t);if("object"!==i)throw new TypeError("Level(s) must be an associative array, received "+i);for(e in t)c.inArray(e,r)||r.push(e),"aliases"in t[e]&&(t[e].alias=t[e].aliases,delete t[e].aliases),n[e]=c.extend({},s.definitions[e]||{},t[e]),t[e].alias&&this.resolveAliases(e);return this},o.prototype.mergeLevels=function(t){var e,i=c.type(t);if("object"!==i)throw new TypeError("Level(s) must be an associative array, received "+i);for(e in t)c.inArray(e,r)||r.push(e),"aliases"in t[e]&&(t[e].alias=t[e].aliases,delete t[e].aliases),n[e]=c.extend({},s.definitions[e]||{},n[e]||{},t[e]),t[e].alias&&this.resolveAliases(e);return this},o.prototype.assertValidLevel=function(t){if(!this.isValidLevel(t))throw new TypeError('Unsupported feedback level, received "'+t+'". Must be one of: '+r.join(", "))},o.prototype.isValidLevel=function(t){return"string"===c.type(t)&&-1<c.inArray(t,r)},o.prototype.getDisplay=function(){return this.display},o.prototype.setDisplay=function(t){return this.assertValidDisplay(t),this.display=t,this},o.prototype.assertValidDisplay=function(t){if(!this.isValidDisplay(t))throw new TypeError('Unsupported display mode, received "'+t+'". Must be one of: null, '+e.join(", "))},o.prototype.isValidDisplay=function(t){return null!==t&&-1<c.inArray(t,e)},o.prototype.addAction=function(t){return this.actions.push(t),this},o.prototype.add_action=function(t){return this.addAction(t)},o.prototype.dispatch=function(){if(this.hasMessages()){var t,e,i,o=this.getMessagesMap();for(t in o){if(e=this.level(t),i=[],this.actions.length)for(var r,n=0;n<this.actions.length;n++)r=this.actions[n],r=c.extend(r,{label:r.label,action:r.callback}),i.push(r);var a={title:e.title,message:'<p class="mb-0">'+o[t].join('</p><p class="mb-0 mt-3">')+"</p>",level:t,type:e.type,buttons:i},s=this.getDisplay(),l=null;switch(s){case"dialog":case"toast":l=s;break;default:l=e.display}"toast"===l?(a.dismissible=0===i.length,new d(a)):BootstrapDialog.show(a)}this.empty()}return this},o.prototype.empty=function(){t(),this.display=null,this.actions=[],this.storage=[]},function(t,e){if(i.feedback(),this.validLevel(t))return this.setLevel(t),this.validMessage(e)&&this.setMessage(e),this;throw new TypeError("Feedback level required. Must be one of: "+r.join(", "))}),d=(l.createFromObject=function(t){var e=t.level||null,t=t.message||null;return e||t?new l(e,t):null},l.prototype={toString:function(){return this.message()},level:function(){return this._level||null},setLevel:function(t){var e=c.type(t);if("string"!==e)throw new TypeError("Feedback level must be a string, received "+e);return o.prototype.assertValidLevel(t),t in a&&(t=a[t]),this._level=t,this},validLevel:function(t){return o.prototype.isValidLevel(t)},message:function(){return this._message||null},setMessage:function(t){var e=c.type(t);if("string"!==e)throw new TypeError("Feedback message must be a string, received "+e);return this._message=t,this},validMessage:function(t){return o.prototype.validMessage(t)}},function(t){var e=c.type(t);if("object"!==e)throw new TypeError("Notification config must be an associative array, received "+e);return this.validMessage(t.message)&&this.setMessage(t.message),this.config=c.extend({},{id:BootstrapDialog.newGuid(),delay:s.delay},t),this.$elem=c('<article class="c-notifications_item alert fade show" role="alert"></article>'),this.$elem.prop("id",this.config.id),this.$elem.addClass("alert-"+this.config.type.replace("type-","")),this.config.dismissible&&(this.$elem.addClass("alert-dismissible"),(e=c('<button type="button" class="close" data-dismiss="alert" aria-label="'+commonL10n.close+'"></button>')).append('<span aria-hidden="true">&times;</span>'),this.$elem.append(e)),this.config.message&&((t=c('<div class="alert-body"></div>')).html("").append(this.config.message),this.$elem.append(t)),this.$elem.appendTo(".c-notifications").addClass("show"),this.$elem.on("closed.bs.alert",{notification:this},function(t){t=t.data.notification;t.$elem.off(".charcoal.feedback"),t.closeTimer&&window.clearTimeout(t.closeTimer)}),"number"==typeof this.config.delay&&0<this.config.delay&&(this.$elem.on("mouseover.charcoal.feedback",{notification:this},function(t){t=t.data.notification;t.closeTimer&&window.clearTimeout(t.closeTimer)}),this.$elem.on("mouseout.charcoal.feedback",{notification:this},function(t){var e=t.data.notification;e.closeTimer=window.setTimeout(function(){e.$elem.alert("close")},e.config.delay)}),this.closeTimer=window.setTimeout(c.proxy(function(){this.$elem.alert("close")},this),this.config.delay)),this});d.prototype=Object.create(l.prototype),(d.prototype.constructor=d).prototype.parent=l.prototype,t(),i.Feedback=o,i.FeedbackEntry=l}(jQuery,Charcoal.Admin,document),!function(i,t,e){"use strict";function o(){return this}o.prototype.getApi=function(){return e.grecaptcha||null},o.prototype.hasApi=function(){return void 0!==e.grecaptcha},o.prototype.hasWidget=function(t,e){if(!1===this.hasApi())return!1;e=e||".g-recaptcha";t=i(t);return t.is(e)||t.find(e).exists()},o.prototype.hasInvisibleWidget=function(t,e){if(!1===this.hasApi())return!1;e=e||".g-recaptcha";t=i(t),t=t.is(e)?t:t.find(e);return t.exists()&&"invisible"===t.data("size")},t.ReCaptcha=o}(jQuery,Charcoal.Admin,window),Charcoal.Admin.Component=function(t){return this._element,this._id,this._type,this._opts,t&&(t.element?this.set_element(t.element):"string"==typeof t.id&&(this.set_element("#"+t.id),this.set_id(t.id)),"string"==typeof t.type&&this.set_type(t.type),this.set_opts(t)),this},Charcoal.Admin.Component.prototype.set_element=function(t){if(1!==(t=t instanceof jQuery?t:$(t)).length)throw new TypeError("Component Element must be a DOM Element");return this.set_id(t.attr("id")),this._element=t,this},Charcoal.Admin.Component.prototype.element=function(){return this._element},Charcoal.Admin.Component.prototype.set_id=function(t){return this._id=t,this},Charcoal.Admin.Component.prototype.id=function(){return this._id},Charcoal.Admin.Component.prototype.set_type=function(t){return this._type=t,this},Charcoal.Admin.Component.prototype.type=function(){return this._type},Charcoal.Admin.Component.prototype.set_opts=function(t){if("object"!=typeof t)throw new TypeError("Component Options must be an object");return this._opts=t,this},Charcoal.Admin.Component.prototype.add_opts=function(t,e){if("string"!=typeof t)throw new TypeError("Component Options Key must be a string");return this._opts[t]=e,this},Charcoal.Admin.Component.prototype.opts=function(t){return"string"==typeof t?void 0===this._opts[t]?null:this._opts[t]:this._opts},Charcoal.Admin.Component.prototype.init=function(){return this},Charcoal.Admin.Component.prototype.destroy=function(){},!function(e,t){"use strict";function i(t){return Array.isArray(t)?Object.assign({},t):e.isPlainObject(t)?t:null}t.Mixin_Model_Filters={filters:{},parse_filters:i,parse_filter:function(t){return Array.isArray(t)?{filters:t}:e.isPlainObject(t)?t:null},add_filter:function(t){var e;return null!==(t=this.parse_filter(t))&&(this.has_filters()||(this.filters={}),e=Charcoal.Admin.uid(),this.filters[e]=t),this},add_filters:function(t){return null!==(t=this.parse_filters(t))&&(this.has_filters()?this.filters=e.extend({},this.filters,t):this.filters=t),this},remove_filter:function(t){return this.has_filters()&&delete this.filters[t],this},set_filter:function(t,e){return null===e||!1===e?this.remove_filter(t):null!==(e=this.parse_filter(e))&&(this.has_filters()||(this.filters={}),this.filters[t]=e),this},set_filters:function(t){this.filters=this.parse_filters(t)},has_filter:function(t){return this.filters&&t in this.filters},has_filters:function(){return!e.isEmptyObject(this.filters)},get_filters:function(){return this.filters}},t.Mixin_Model_Orders={orders:{},parse_orders:i,parse_order:function(t){return e.isPlainObject(t)?t:null},add_order:function(t){var e;return null!==(t=this.parse_order(t))&&(this.has_orders()||(this.orders={}),e=Charcoal.Admin.uid(),this.orders[e]=t),this},add_orders:function(t){return null!==(t=this.parse_orders(t))&&(this.has_orders()?this.orders=e.extend({},this.orders,t):this.orders=t),this},remove_order:function(t){return this.has_orders()&&delete this.orders[t],this},set_order:function(t,e){return null===e||!1===e?this.remove_order(t):null!==(e=this.parse_order(e))&&(this.has_orders()||(this.orders={}),this.orders[t]=e),this},set_orders:function(t){this.orders=this.parse_orders(t)},has_order:function(t){return this.orders&&t in this.orders},has_orders:function(){return!e.isEmptyObject(this.orders)},get_orders:function(){return this.orders}}}(jQuery,Charcoal.Admin),!function(){"use strict";Charcoal.Admin.Mixin_Model_Search={search_query:null,set_search_query:function(t){this.search_query=t},get_search_query:function(){return this.search_query}}}(),Charcoal.Admin.Widget=function(t){return Charcoal.Admin.Component.call(this,t),this._widget_id,this._widget_type,this._is_reloading=!1,this._suppress_feedback=!1,t.widget_id&&(this._widget_id=t.widget_id),t.widget_type&&(this._widget_type=t.widget_type),"suppress_feedback"in t&&(this._suppress_feedback=t.suppress_feedback),this},Charcoal.Admin.Widget.prototype=Object.create(Charcoal.Admin.Component.prototype),Charcoal.Admin.Widget.prototype.constructor=Charcoal.Admin.Widget,Charcoal.Admin.Widget.prototype.parent=Charcoal.Admin.Component.prototype,Charcoal.Admin.Widget.prototype.widget_id=function(){return this._widget_id||this.id()},Charcoal.Admin.Widget.prototype.widget_type=function(){return this._widget_type||this.type()},Charcoal.Admin.Widget.prototype.widget_options=function(){return this.opts()},Charcoal.Admin.Widget.prototype.suppress_feedback=function(t){if(arguments.length){if("boolean"!=typeof t)throw new TypeError("Must be a boolean, received "+typeof t);this._suppress_feedback=t}return this._suppress_feedback||!1},Charcoal.Admin.Widget.prototype.anim_out=function(t){return"function"!=typeof t&&(t=null),this.element().fadeOut(400,t),this},Charcoal.Admin.Widget.prototype.is_reloading=function(){return this._is_reloading},Charcoal.Admin.Widget.prototype.try_reload=function(){return this.is_reloading()||this.reload.apply(this,arguments),this},Charcoal.Admin.Widget.prototype.reload=function(i,o){this._is_reloading=!0;var r,n=this,t=Charcoal.Admin.admin_url()+"widget/load"+window.location.search,e={widget_type:n.widget_type(),widget_options:n.widget_options(),with_data:o};return this.reloadXHR&&this.reloadXHR.abort(),this.element().addClass("is-loading"),this.reloadXHR=$.ajax({type:"POST",url:t,data:JSON.stringify(e),dataType:"json",contentType:"application/json"}),r=function(t){t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):Charcoal.Admin.feedback([{level:"error",message:widgetL10n.loadingFailed}])},Charcoal.Admin.resolveSimpleJsonXhr(this.reloadXHR,function(t){if("string"!=typeof t.widget_id)return t.feedbacks.push({level:"error",message:widgetL10n.loadingFailed}),void r.call(this,t);var e=t.widget_id;n.set_id(e),n.add_opts("id",e),n.add_opts("widget_id",e),o&&n.add_opts("data",t.widget_data),n.widget_id=e,n.anim_out(function(){n.destroy(),n.element().replaceWith(t.widget_html),n.set_element($("#"+n.id())),n.element().removeClass("is-loading"),n.element().hide().fadeIn(),n.init(),"function"==typeof i&&i.call(n,t)})},r,function(){n._is_reloading=!1,n.suppress_feedback()||Charcoal.Admin.feedback().dispatch()}),this},Charcoal.Admin.Widget.prototype.dialog=function(e,i){var t=e.title||"",o=e.type||BootstrapDialog.TYPE_DEFAULT,r=e.size||BootstrapDialog.SIZE_NORMAL,n=e.cssClass||"",a=e.showHeader||!0,s=e.showFooter||!0,l=e.dialog_options||{};delete e.title,delete e.type,delete e.size,delete e.cssClass,delete e.dialog_options;var t=$.extend({},{title:t,type:o,size:r,cssClass:n,nl2br:!1,showHeader:a,showFooter:s},l),c='<div class="alert alert-{type}" role="alert">{text}</div>';return t.onshown=function(r){var t=Charcoal.Admin.admin_url()+"widget/load";r.xhr=$.ajax({method:"POST",url:t,data:e,dataType:"json"}),r.xhr.then(function(t,e,i){return t&&t.success?$.Deferred().resolve(t,e,i):t.feedbacks?$.Deferred().reject(i,e,t.feedbacks):$.Deferred().reject(i,e,widgetL10n.loadingFailed)}).done(function(t){r.setMessage(t.widget_html),"function"==typeof i&&i(t,r),$('[data-toggle="tooltip"]',r.getModalBody()).tooltip()}).fail(function(t,e,i){r.setType(BootstrapDialog.TYPE_DANGER),r.setMessage(widgetL10n.loadingFailed);var o="";"string"===$.type(i)&&t.responseJSON&&t.responseJSON.feedbacks&&(i=t.responseJSON.feedbacks),$.isArray(i)?$.each(i,function(t,e){e.message&&("error"===e.level&&(e.level="danger"),o+=c.replaceMap({"{type}":e.level,"{text}":e.message}))}):"string"===$.type(i)&&(o=c.replaceMap({"{type}":"danger","{text}":i})),o&&r.setMessage(o),$('[data-toggle="tooltip"]',r.getModalBody()).tooltip()}),Charcoal.Admin.manager().render()},t.message=function(t){var e=$(c.replaceMap({"{type}":"warning","{text}":widgetL10n.loading}));return a||t.getModalHeader().addClass("d-none"),s||t.getModalFooter().addClass("d-none"),t.getModalBody().on("click.charcoal.bs.dialog",'[data-dismiss="dialog"]',{dialog:t},function(t){t.data.dialog.close()}),e},new BootstrapDialog.show(t)},Charcoal.Admin.Widget.prototype.confirm=function(t,e,i){var o={type:BootstrapDialog.TYPE_DANGER,callback:function(t){t?"function"==typeof e&&e():"function"==typeof i&&i()}},o=$.extend(o,t);return BootstrapDialog.confirm(o)},{});Charcoal.Admin.Widget_Attachment=function(t){this.EVENT_NAMESPACE=Charcoal.Admin.Widget_Attachment.EVENT_NAMESPACE,Charcoal.Admin.Widget.call(this,t),this.busy=!1,this.dirty=!1,this.glyphs={embed:"glyphicon-blackboard",video:"glyphicon-film",image:"glyphicon-picture",file:"glyphicon-file",link:"glyphicon-link",text:"glyphicon-font",gallery:"glyphicon-duplicate",container:"glyphicon-list",accordion:"glyphicon-list"};var e=this;return $(document).on("beforelanguageswitch"+Charcoal.Admin.Widget_Form.EVENT_NAMESPACE,function(t){if(e.is_busy())return t.preventDefault(),void e.enqueue_is_busy_feedback().dispatch();e.perform_save()}).on("languageswitch"+Charcoal.Admin.Widget_Form.EVENT_NAMESPACE,function(){e.change_locale().try_reload()}),this},Charcoal.Admin.Widget_Attachment.EVENT_NAMESPACE=".charcoal.attachments",Charcoal.Admin.Widget_Attachment.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Attachment.prototype.constructor=Charcoal.Admin.Widget_Attachment,Charcoal.Admin.Widget_Attachment.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Attachment.prototype.init=function(){var t,e=this.element().find(".js-attachment-sortable > .js-grid-container");return e.length&&(this.element().on("hidden.bs.collapse",'[data-toggle="collapse"]',function(){e.sortable("refreshPositions")}),t=this,e.sortable({handle:'[draggable="true"]',placeholder:"card c-attachments_row -placeholder",start:function(t,e){e.item.children(".card-header").find('[data-toggle="collapse"]').hasClass("collapsed")||e.item.children(".collapse").collapse("hide")},update:function(){t.set_dirty_state(!0)}}).disableSelection()),this.listeners(),this},Charcoal.Admin.Widget_Attachment.prototype.is_busy=function(){return this.busy||this.is_reloading()},Charcoal.Admin.Widget_Attachment.prototype.set_busy_state=function(t){return this.busy=t,this},Charcoal.Admin.Widget_Attachment.prototype.is_dirty=function(){return this.dirty},Charcoal.Admin.Widget_Attachment.prototype.set_dirty_state=function(t){return this.dirty=t,this},Charcoal.Admin.Widget_Attachment.prototype.change_locale=function(t){var e=this.opts();return e.widget_options.lang=t||Charcoal.Admin.lang(),this.set_opts(e),this},Charcoal.Admin.Widget_Attachment.prototype.listeners=function(){var p=this,e=this.element().find(".c-attachments_container > .js-grid-container");this.element().off(this.EVENT_NAMESPACE).on("click"+this.EVENT_NAMESPACE,".js-attachments-collapse",function(){var t=e.children(".js-attachment");e.hasClass("js-attachment-preview-only")&&t.find(".card-header.sr-only").removeClass("sr-only").addClass("sr-only-off"),t.find(".collapse.show").collapse("hide")}).on("click"+this.EVENT_NAMESPACE,".js-attachments-expand",function(){var t=e.children(".js-attachment");e.hasClass("js-attachment-preview-only")&&t.find(".card-header.sr-only-off").removeClass("sr-only-off").addClass("sr-only"),t.find(".collapse:not(.show)").collapse("show")}).on("click"+this.EVENT_NAMESPACE,".js-add-attachment",function(t){t.preventDefault();var t=$(this),e=t.data("type");if(!e)return!1;var i=t.data("id");i?(p.add({id:i,type:e}),p.join(function(){p.reload()})):(i={title:t.data("title")||attachmentWidgetL10n.editObject,formIdent:t.data("form-ident"),skipForm:t.data("skip-form")},p.create_attachment(e,0,null,i,function(t){t.success&&(t.obj.id=t.obj_id,p.add(t.obj),p.join(function(){p.reload()}))}))}).on("click"+this.EVENT_NAMESPACE,".js-attachment-actions a",function(t){var e=$(this);if(e.data("action"))switch(t.preventDefault(),e.data("action")){case"edit":var i=e.data("type"),o=e.data("id");if(!i||!o)break;var r={title:e.data("title")||attachmentWidgetL10n.editObject,formIdent:e.data("form-ident")};p.create_attachment(i,o,null,r,function(t){t.success&&p.reload()});break;case"delete":if(!e.data("id"))break;p.confirm({title:attachmentWidgetL10n.confirmRemoval,message:commonL10n.confirmAction,btnOKLabel:commonL10n.removeObject,callback:function(t){t&&p.remove_join(e.data("id"),function(){p.reload()})}});break;case"add-object":var i=e.data("title"),o=e.data("attachment"),n=e.data("type"),a=e.data("id"),s=e.data("group"),l=e.data("form-ident"),c=e.data("skip-form"),d={id:a,type:n,group:s},r={title:i,formIdent:l,skipForm:c};p.create_attachment(o,0,d,r,function(t){t.success&&p.add_object_to_container({id:t.obj_id,type:t.obj.type},d)})}})},Charcoal.Admin.Widget_Attachment.prototype.select_attachment=function(t){if(!t.data("id")||!t.data("type"))return this},Charcoal.Admin.Widget_Attachment.prototype.create_attachment=function(t,e,i,o,r){return o&&o.skipForm?this.create_quick_attachment(t,e,i,o,r):this.create_dialog_attachment(t,e,i,o,r)},Charcoal.Admin.Widget_Attachment.prototype.create_quick_attachment=function(t,i,e,o,r){return i=i||0,e=e||this.get_parent_container(),this.xhr=$.ajax({type:"POST",url:"object/save",data:{obj_type:t,obj_id:i,pivot:e}}),Charcoal.Admin.resolveSimpleJsonXhr(this.xhr,function(t){t.feedbacks.length&&Charcoal.Admin.feedback(t.feedbacks),"function"==typeof r&&r(t)},function(t){var e;t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):(t=i?formWidgetL10n.updateFailed:formWidgetL10n.createFailed,e=commonL10n.errorOccurred,Charcoal.Admin.feedback([{level:"error",message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":t,"[[ errorThrown ]]":e})}]))},function(){Charcoal.Admin.feedback().dispatch(),Charcoal.Admin.manager().render()})},Charcoal.Admin.Widget_Attachment.prototype.create_dialog_attachment=function(t,i,e,o,r){i=i||0,o=o||{},e=e||this.get_parent_container();t={size:BootstrapDialog.SIZE_WIDE,cssClass:"-quick-form",widget_type:"charcoal/admin/widget/quick-form",with_data:!0,widget_options:{obj_type:t,obj_id:i,form_ident:o.formIdent||null,form_data:{pivot:e}}},e=$.extend({},t,o,{});return this.dialog(e,function(t,e){return!!t.success&&(!!t.widget_id&&(Charcoal.Admin.manager().add_widget({id:t.widget_id,type:"charcoal/admin/widget/quick-form",data:t.widget_data,obj_id:i,save_callback:function(t){"function"==typeof r&&r(t),this instanceof Charcoal.Admin.Component&&this.id()&&Charcoal.Admin.manager().destroy_component("widgets",this.id()),e.close()}}),void Charcoal.Admin.manager().render()))})},Charcoal.Admin.Widget_Attachment.prototype.get_parent_container=function(){var t=this.opts();return{obj_type:t.data.obj_type,obj_id:t.data.obj_id,group:t.data.group}},Charcoal.Admin.Widget_Attachment.prototype.add_object_to_container=function(t,e,i){if(this.is_busy())return null;this.set_busy_state(!0);var o=this,r={obj_type:e.type,obj_id:e.id,attachments:[{attachment_id:t.id,attachment_type:t.type,position:0}],group:i||e.group||""},t=(null!=globalXHR[r.group]&&globalXHR[r.group].abort&&globalXHR[r.group].abort(),$.post("add-join",r));return globalXHR[r.group]=Charcoal.Admin.resolveSimpleJsonXhr(t,function(){o.reload()},function(t){t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):Charcoal.Admin.feedback([{level:"error",message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":formWidgetL10n.saveFailed,"[[ errorThrown ]]":commonL10n.errorOccurred})}])},function(){delete globalXHR[r.group],o.set_busy_state(!1),Charcoal.Admin.feedback().dispatch()})},Charcoal.Admin.Widget_Attachment.prototype.add=function(t){if(!t)return!1;this.set_dirty_state(!0);var e=this.element().find(".js-attachment-template").clone();return e.find(".js-attachment").data("id",t.id).data("type",t.type),this.element().find(".c-attachments_container > .js-grid-container").append(e),this},Charcoal.Admin.Widget_Attachment.prototype.enqueue_is_busy_feedback=function(){var t=this.widget_options(),t=t&&t.title||attachmentWidgetL10n.widgetName;return Charcoal.Admin.feedback([{level:"warning",display:"toast",message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":t,"[[ errorThrown ]]":widgetL10n.isBusy})}])},Charcoal.Admin.Widget_Attachment.prototype.validate=function(t){return!this.is_busy()||(t.attempts&&t.max_attempts&&t.attempts<t.max_attempts&&this.enqueue_is_busy_feedback(),!1)},Charcoal.Admin.Widget_Attachment.prototype.save=function(){return!this.is_busy()&&this.perform_save()},Charcoal.Admin.Widget_Attachment.prototype.perform_save=function(){return this.is_dirty()&&this.join(),!0},Charcoal.Admin.Widget_Attachment.prototype.join=function(t){if(this.is_busy())return null;if(!$("#"+this.element().attr("id")).length)return null;this.set_busy_state(!0);var e=this,i=e.opts(),o={obj_type:i.data.obj_type,obj_id:i.data.obj_id,attachments:[],group:i.data.group},i=(this.element().find(".c-attachments_container").find(".js-attachment").each(function(t){var e=$(this),i=e.data("id"),e=e.data("type");o.attachments.push({attachment_id:i,attachment_type:e,position:t})}),null!=globalXHR[o.group]&&globalXHR[o.group].abort&&globalXHR[o.group].abort(),$.post("join",o));return globalXHR[o.group]=Charcoal.Admin.resolveSimpleJsonXhr(i,function(){"function"==typeof t&&t()},function(t){t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):Charcoal.Admin.feedback([{level:"error",message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":formWidgetL10n.saveFailed,"[[ errorThrown ]]":commonL10n.errorOccurred})}])},function(){delete globalXHR[o.group],e.set_busy_state(!1),e.set_dirty_state(!1),Charcoal.Admin.feedback().dispatch()})},Charcoal.Admin.Widget_Attachment.prototype.remove_join=function(t,e){if(this.is_busy())return null;if(!t)return null;this.set_busy_state(!0);var i=this,o=i.opts(),r={obj_type:o.data.obj_type,obj_id:o.data.obj_id,attachment_id:t,group:o.data.group},t=(null!=globalXHR[r.group]&&globalXHR[r.group].abort&&globalXHR[r.group].abort(),$.post("remove-join",r));return globalXHR[r.group]=Charcoal.Admin.resolveSimpleJsonXhr(t,function(){"function"==typeof e&&e()},function(t){t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):Charcoal.Admin.feedback([{level:"error",message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":attachmentWidgetL10n.removeFailed,"[[ errorThrown ]]":commonL10n.errorOccurred})}])},function(){delete globalXHR[r.group],i.set_busy_state(!1),i.set_dirty_state(!1),Charcoal.Admin.feedback().dispatch()})},Charcoal.Admin.Widget_Attachment.prototype.widget_options=function(){var t=this.opts("widget_options");return!t.widget_id&&this.widget_id()&&(t.widget_id=this.widget_id()),t},Charcoal.Admin.Widget_Card_Collection=function(t){Charcoal.Admin.Widget.call(this,t),this.obj_type=null,this.widget_id=null,this.table_selector=null,this.pagination={page:1,num_per_page:50},this.list_actions={},this.object_actions={},this.template=this.properties=this.properties_options=void 0,this.sortable=!1,this.sortable_handler=null},Charcoal.Admin.Widget_Card_Collection.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Card_Collection.prototype.constructor=Charcoal.Admin.Widget_Card_Collection,Charcoal.Admin.Widget_Card_Collection.prototype.parent=Charcoal.Admin.Widget.prototype,Object.assign(Charcoal.Admin.Widget_Card_Collection.prototype,Charcoal.Admin.Mixin_Model_Search),Object.assign(Charcoal.Admin.Widget_Card_Collection.prototype,Charcoal.Admin.Mixin_Model_Filters),Object.assign(Charcoal.Admin.Widget_Card_Collection.prototype,Charcoal.Admin.Mixin_Model_Orders),Charcoal.Admin.Widget_Card_Collection.prototype.init=function(){this.set_properties().bind_events()},Charcoal.Admin.Widget_Card_Collection.prototype.set_properties=function(){var t=this.opts();switch(this.obj_type=t.data.obj_type||this.obj_type,this.widget_id=t.id||this.widget_id,this.table_selector="#"+this.widget_id,this.sortable=t.data.sortable||this.sortable,this.template=t.data.template||this.template,this.card_template=t.data.card_template||this.card_template,this.num_columns=t.data.num_columns||this.num_columns,this.collection_ident=t.data.collection_ident||"default","properties"in t.data&&Array.isArray(t.data.properties)&&(this.properties=t.data.properties),"properties_options"in t.data&&$.isPlainObject(t.data.properties_options)&&(this.properties_options=t.data.properties_options),"filters"in t.data&&this.set_filters(t.data.filters),"orders"in t.data&&this.set_orders(t.data.orders),"pagination"in t.data&&$.isPlainObject(t.data.pagination)&&(this.pagination=t.data.pagination),"list_actions"in t.data&&(Array.isArray(t.data.list_actions)?this.list_actions=Object.assign({},t.data.list_actions):$.isPlainObject(t.data.list_actions)&&(this.list_actions=t.data.list_actions)),"object_actions"in t.data&&(Array.isArray(t.data.object_actions)?this.object_actions=Object.assign({},t.data.object_actions):$.isPlainObject(t.data.object_actions)&&(this.object_actions=t.data.object_actions)),t.lang){case"fr":moment.locale("fr-ca");break;case"en":moment.locale("en-ca");break;default:moment.locale(t.lang)}return $(".js-last-time",this.table_selector).each(function(){$(this).html(moment.unix($(this).attr("data-time")).fromNow())}),this},Charcoal.Admin.Widget_Card_Collection.prototype.bind_events=function(){null!==this.sortable_handler&&this.sortable_handler.destroy();var e=this,t=$(".js-sortable",e.table_selector);0<t.length&&(this.sortable_handler=new window.Sortable.default(t.get(),{draggable:".js-sortable-item",handle:".js-sortable-handle",mirror:{constrainDimensions:!0}}).on("mirror:create",function(t){var e=t.originalSource.querySelectorAll(":scope .js-sortable-item"),i=t.source.querySelectorAll(":scope .js-sortable-item");e.forEach(function(t,e){i[e].style.width=t.offsetWidth+"px"})}).on("sortable:stop",function(t){t.oldIndex!==t.newIndex&&(t=Array.from(t.newContainer.querySelectorAll(":scope > .js-sortable-item")).map(function(t){return t.classList.contains("draggable-mirror")||t.classList.contains("draggable--original")?"":t.getAttribute("data-id")}).filter(function(t){return""!==t}),$.ajax({method:"POST",url:Charcoal.Admin.admin_url()+"object/reorder",data:{obj_type:e.obj_type,obj_orders:t,starting_order:1},dataType:"json"}).done(function(t){console.debug(t),t.feedbacks&&Charcoal.Admin.feedback(t.feedbacks).dispatch()}))})),$(".js-jump-page-form",e.table_selector).on("submit",function(t){t.preventDefault();t=$(this),t=parseInt(t.find("input").val());t&&(e.pagination.page=t,e.reload(null,!0))}),$(".js-page-switch",e.table_selector).on("click",function(t){t.preventDefault();t=$(this).data("page-num");console.log(t),e.pagination.page=t,e.reload(null,!0)})},Charcoal.Admin.Widget_Card_Collection.prototype.widget_options=function(){return{obj_type:this.obj_type,template:this.template,collection_ident:this.collection_ident,card_template:this.card_template,num_columns:this.num_columns,collection_config:{properties:this.properties,properties_options:this.properties_options,search_query:this.get_search_query(),filters:this.get_filters(),orders:this.get_orders(),pagination:this.pagination,list_actions:this.list_actions,object_actions:this.object_actions}}},Charcoal.Admin.Widget_Form=function(t){this.EVENT_NAMESPACE=Charcoal.Admin.Widget_Form.EVENT_NAMESPACE,Charcoal.Admin.Widget.call(this,t),this.widget_id=null,this.obj_type=null,this.obj_id=null,this.save_action=t.save_action||"object/save",this.update_action=t.update_action||"object/update",this.extra_form_data=t.extra_form_data||{},this.form_selector=null,this.form_working=!1,this.attempts=0,this.max_attempts=5,this.submitted_via=null,this.is_new_object=!1,this.xhr=null,this.useDefaultAction=!1,this.confirmed=!1;var e=$("[data-lang]:not(.d-none)").data("lang");e&&Charcoal.Admin.setLang(e),this._on_popstate_tab=this._on_popstate_tab.bind(this),this._on_shown_tab=this._on_shown_tab.bind(this),this.set_properties(t)},Charcoal.Admin.Widget_Form.EVENT_NAMESPACE=".charcoal.form",Charcoal.Admin.Widget_Form.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Form.prototype.constructor=Charcoal.Admin.Widget_Form,Charcoal.Admin.Widget_Form.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Form.prototype.init=function(){this.update_tab_ident(),this.bind_events(),this.parse_group_conditions()},Charcoal.Admin.Widget_Form.prototype.set_properties=function(t){return this.widget_id=t.id||this.widget_id,this.obj_type=t.data.obj_type||this.obj_type,this.obj_id=Charcoal.Admin.parseNumber(t.data.obj_id||this.obj_id),this.form_selector=t.data.form_selector||this.form_selector,this.isTab=t.data.tab,this.group_conditions=t.data.group_conditions,this.$form=$(this.form_selector),this.allow_reload=t.data.allow_reload,this.force_page_reload=t.data.force_page_reload,this.useDefaultAction=t.data.use_default_action,this},Charcoal.Admin.Widget_Form.prototype.widget_options=function(){var t=this.parent.widget_options.call(this);return $.extend({},t,this.opts("data"))},Charcoal.Admin.Widget_Form.prototype.bind_events=function(){var e=this,i=this.$form,t=(i.on("submit"+this.EVENT_NAMESPACE,function(t){t.preventDefault(),e.request_submit()}).find(":submit").on("click"+this.EVENT_NAMESPACE,function(){e.submitted_via=this}),$(".js-sidebar-widget",this.form_selector));t.on("click"+this.EVENT_NAMESPACE,".js-obj-delete",function(t){t.preventDefault(),e.delete_object(this)}),t.on("click"+this.EVENT_NAMESPACE,".js-reset-form",function(t){t.preventDefault(),i[0].reset()}),t.on("click"+this.EVENT_NAMESPACE,".js-obj-revision",function(t){t.preventDefault(),e.view_revision(this)}),t.on("click"+this.EVENT_NAMESPACE,".js-obj-list",function(t){t.preventDefault(),e.back_to_list(this)}),t.on("click"+this.EVENT_NAMESPACE,".js-lang-switch button",function(t){t.preventDefault();t=$(this).attr("data-lang-switch");e.switch_language(t)}),window.addEventListener("popstate",this._on_popstate_tab),this.isTab&&i.on("shown.bs.tab",".js-group-tabs",this._on_shown_tab)},Charcoal.Admin.Widget_Form.prototype._on_popstate_tab=function(){this.update_tab_ident()},Charcoal.Admin.Widget_Form.prototype._on_shown_tab=function(t){var t=$(t.target),e=[],i=Charcoal.Admin.queryParams();if(void 0===i.tab_ident||t.data("tab-ident")!==i.tab_ident){for(var o in i.tab_ident=t.data("tab-ident"),i)e.push(o+"="+i[o]);history.pushState("","",window.location.pathname+"?"+e.join("&"))}},Charcoal.Admin.Widget_Form.prototype.parse_group_conditions=function(){var o=this,r=this.$form;$.each(this.group_conditions,function(i,t){var e=o.validate_group_conditions(i);e||o.toggle_conditional_group(i,e,!1),$.each(t,function(t,e){r.on("change"+this.EVENT_NAMESPACE,"#"+e.input_id,{condition_target:i},function(t){var e=o.validate_group_conditions(t.data.condition_target);o.toggle_conditional_group(t.data.condition_target,e)})})})},Charcoal.Admin.Widget_Form.prototype.validate_group_conditions=function(t){var t=this.group_conditions[t],r=this,n=this.$form,a=!0;return $.each(t,function(t,e){var i=n.find("#"+e.input_id),o=r.get_input_value(i);switch(JSON.stringify(e.operator)){case'"!=="':case'"!="':case'"!"':case'"not"':if(o===e.value)return void(a=!1);break;default:case'"==="':case'"=="':case'"="':case'"is"':if(o!==e.value)return void(a=!1)}}),a},Charcoal.Admin.Widget_Form.prototype.toggle_conditional_group=function(t,e,i){function o(){r.each(function(){$(this).attr("disabled",!e)})}var t=this.$form.find("#"+t),r=t.find("select, input, textarea");i=void 0===i||i;e?i?t.slideDown({easing:"easeInOutQuad",start:o}):t.show(0,o):i?t.slideUp({easing:"easeInOutQuad",complete:o}):t.hide(0,o)},Charcoal.Admin.Widget_Form.prototype.get_input_value=function(t){if("disabled"===t.attr("disabled"))return null;var e;switch(t.attr("type")){case"select":e=t.find(":selected").val();break;case"checkbox":e=t.is(":checked");break;default:e=t.val()}return e},Charcoal.Admin.Widget_Form.prototype.update_tab_ident=function(){var t=Charcoal.Admin.queryParams();"tab_ident"in t&&$('.js-group-tabs[data-tab-ident="'+t.tab_ident+'"]').tab("show")},Charcoal.Admin.Widget_Form.prototype.get_form_data=function(){var t=this.$form.length?new FormData(this.$form[0]):new FormData;if(this.submitted_via&&this.submitted_via.name&&t.append(this.submitted_via.name,this.submitted_via.value||!0),this.confirmed&&t.append("confirmed",!0),this.extra_form_data)for(var e in this.extra_form_data)this.extra_form_data.hasOwnProperty(e)&&t.append(e,this.extra_form_data[e]);return t},Charcoal.Admin.Widget_Form.prototype.request_submit=function(){var t;return this.attempts++,this.form_working?(t=this.attempts>=this.max_attempts?commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":formWidgetL10n.isBlocked,"[[ errorThrown ]]":commonL10n.tryAgainLater}):commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":formWidgetL10n.isProcessing,"[[ errorThrown ]]":commonL10n.pleaseWait}),void Charcoal.Admin.feedback([{level:"warning",display:"toast",message:t}])):(this.form_working=!0,this.is_new_object=!this.obj_id,!0!==Charcoal.Admin.manager().prepare_submit(this)?(t=$.Event("failed"+this.EVENT_NAMESPACE,{subtype:"validation",component:this}),this.$form.trigger(t),void this.request_complete()):(this.disable_form(),void this.submit_form()))},Charcoal.Admin.Widget_Form.prototype.submit_form=function(){this.xhr=$.ajax({type:"POST",url:this.request_url(),data:this.get_form_data(),dataType:"json",processData:!1,contentType:!1}),this.xhr.then($.proxy(this.request_done,this)).done($.proxy(this.request_success,this)).fail($.proxy(this.request_failed,this)).always($.proxy(this.request_complete,this))},Charcoal.Admin.Widget_Form.prototype.request_done=function(t,e,i){return t&&t.success?$.Deferred().resolve(t,e,i):t.feedbacks?$.Deferred().reject(i,e,t.feedbacks):$.Deferred().reject(i,e,commonL10n.errorOccurred)},Charcoal.Admin.Widget_Form.prototype.request_success=function(t){this.attempts=0;var e=$.Event("success"+this.EVENT_NAMESPACE,{subtype:"submission",component:this,response:t});this.$form.trigger(e),e.isDefaultPrevented()||(this.confirmed=!1,t.feedbacks&&Charcoal.Admin.feedback(t.feedbacks),t.need_confirmation?this.add_actions_for_confirmation(t.confirmation_label):t.next_url?this.add_action_for_next_url(t.next_url,t.next_url_label):!this.useDefaultAction&&this.is_new_object?(this.suppress_feedback(!0),t.next_url?Charcoal.Admin.redirect_to_url(t.next_url):(e=new URLSearchParams(window.location.search),window.location.href=Charcoal.Admin.admin_url()+"object/edit?"+(e.has("main_menu")?"main_menu="+e.get("main_menu")+"&":"")+(e.has("secondary_menu")?"secondary_menu="+e.get("secondary_menu")+"&":"")+"obj_type="+this.obj_type+"&obj_id="+t.obj_id)):this.force_page_reload?window.location.reload():this.allow_reload&&(e=Charcoal.Admin.manager().get_widgets(),$.each(e,function(t,e){e.reload()}.bind(this))))},Charcoal.Admin.Widget_Form.prototype.request_failed=function(t,e,i){var o=$.Event("failed"+this.EVENT_NAMESPACE,{subtype:"submission",component:this,response:t.responseJSON||{}});this.$form.trigger(o),o.isDefaultPrevented()||(t.responseJSON&&t.responseJSON.feedbacks?Charcoal.Admin.feedback(t.responseJSON.feedbacks):(o=this.is_new_object?formWidgetL10n.createFailed:formWidgetL10n.updateFailed,t=i||commonL10n.errorOccurred,Charcoal.Admin.feedback([{level:"error",message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":o,"[[ errorThrown ]]":t})}])))},Charcoal.Admin.Widget_Form.prototype.request_complete=function(){var t=$.Event("complete"+this.EVENT_NAMESPACE,{subtype:"submission",component:this});this.$form.trigger(t),t.isDefaultPrevented()||(this.suppress_feedback()||(this.attempts>=this.max_attempts&&Charcoal.Admin.feedback([{level:"error",message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":formWidgetL10n.isBlocked,"[[ errorThrown ]]":commonL10n.tryAgainLater})}]),Charcoal.Admin.feedback().dispatch(),this.enable_form()),this.submitted_via=null,this.suppress_feedback(!1),this.form_working=this.is_new_object=!1)},Charcoal.Admin.Widget_Form.prototype.add_action_for_next_url=function(t,e){Charcoal.Admin.feedback().add_action({label:e||commonL10n.continue,callback:function(){Charcoal.Admin.redirect_to_url(t)}})},Charcoal.Admin.Widget_Form.prototype.add_actions_for_confirmation=function(t){Charcoal.Admin.feedback().add_action({label:commonL10n.cancel,cssClass:"btn-danger",callback:function(t){t.close()}}).add_action({label:t||commonL10n.continue,callback:function(t){t.close(),this.confirmed=!0,this.request_submit()}.bind(this)})},Charcoal.Admin.Widget_Form.prototype.disable_form=function(){var t=this.$form;return t.length&&(t.prop("disabled",!0),(t=t.find('[type="submit"]')).length&&t.prop("disabled",!0)),this.submitted_via&&this.disable_button($(this.submitted_via)),this},Charcoal.Admin.Widget_Form.prototype.enable_form=function(){var t=this.$form;return t.length&&(t.prop("disabled",!1),(t=t.find('[type="submit"]')).length&&t.prop("disabled",!1)),this.submitted_via&&this.enable_button($(this.submitted_via)),this},Charcoal.Admin.Widget_Form.prototype.disable_button=function(t){return t.prop("disabled",!0).children(".fa").removeClass("d-none").next(".btn-label").addClass("sr-only"),this},Charcoal.Admin.Widget_Form.prototype.enable_button=function(t){return t.prop("disabled",!1).children(".fa").addClass("d-none").next(".btn-label").removeClass("sr-only"),this},Charcoal.Admin.Widget_Form.prototype.request_url=function(){return this.useDefaultAction?this.$form.attr("action"):this.is_new_object?Charcoal.Admin.admin_url()+this.save_action:Charcoal.Admin.admin_url()+this.update_action},Charcoal.Admin.Widget_Form.prototype.view_revision=function(){var e=this.obj_type,i=this.obj_id,t={size:BootstrapDialog.SIZE_WIDE,title:formWidgetL10n.revisions,widget_type:"charcoal/admin/widget/object-revisions",widget_options:{obj_type:e,obj_id:i}},t=$.extend({},t);this.dialog(t,function(t){if(t.success){if(!t.widget_id)return!1;Charcoal.Admin.manager().add_widget({id:t.widget_id,type:"charcoal/admin/widget/object-revisions",obj_type:e,obj_id:i}),Charcoal.Admin.manager().render()}})},Charcoal.Admin.Widget_Form.prototype.back_to_list=function(){var t=new URLSearchParams(window.location.search);window.location.href="object/collection?"+(t.has("main_menu")?"main_menu="+t.get("main_menu")+"&":"")+(t.has("secondary_menu")?"secondary_menu="+t.get("secondary_menu")+"&":"")+"obj_type="+this.obj_type},Charcoal.Admin.Widget_Form.prototype.delete_object=function(){var i=this,t=new URLSearchParams(window.location.search),o=Charcoal.Admin.admin_url()+"object/collection?"+(t.has("main_menu")?"main_menu="+t.get("main_menu")+"&":"")+(t.has("secondary_menu")?"secondary_menu="+t.get("secondary_menu")+"&":"")+"obj_type="+this.obj_type;if(!i.obj_type||!i.obj_id)return t={level:"warning",message:commonL10n.errorTemplate.replaceMap({"[[ errorMessage ]]":formWidgetL10n.deleteFailed,"[[ errorThrown ]]":commonL10n.invalidObject})},void Charcoal.Admin.feedback([t]).dispatch();BootstrapDialog.confirm({title:formWidgetL10n.confirmDeletion,type:BootstrapDialog.TYPE_DANGER,message:$("<p>"+commonL10n.confirmAction+'</p><p class="mb-0">'+commonL10n.cantUndo+"</p>"),btnOKLabel:commonL10n.delete,callback:function(t){var e;t&&(t=Charcoal.Admin.admin_url()+"object/delete",e={obj_type:i.obj_type,obj_id:i.obj_id},t=$.ajax({method:"POST",url:t,data:e,dataType:"json"}),Charcoal.Admin.resolveSimpleJsonXhr(t,function(){window.location.href=o},function(t){t.feedbacks.length?Charcoal.Admin.feedback(t.feedbacks):Charcoal.Admin.feedback([{level:"error",message:formWidgetL10n.deleteFailed}])},function(){i.suppress_feedback()||Charcoal.Admin.feedback().dispatch()}))}})},Charcoal.Admin.Widget_Form.prototype.reload=function(i){return this.destroy(),Charcoal.Admin.Widget.prototype.reload.call(this,function(t,e){"function"==typeof i&&i.call(t,e),Charcoal.Admin.manager().render()},!0),this},Charcoal.Admin.Widget_Form.prototype.switch_language=function(t){var e,i=Charcoal.Admin.lang();i!==t&&(e=$.Event("beforelanguageswitch"+this.EVENT_NAMESPACE,{language:t,originalLanguage:i,relatedTarget:this.$form[0],relatedComponent:this}),$(document).triggerHandler(e),e.isDefaultPrevented()||(Charcoal.Admin.setLang(t),$("[data-lang][data-lang!="+t+"]").addClass("d-none"),$("[data-lang][data-lang="+t+"]").removeClass("d-none"),$("[data-lang-switch][data-lang-switch!="+t+"]").removeClass("btn-primary").addClass("btn-outline-primary"),$("[data-lang-switch][data-lang-switch="+t+"]").removeClass("btn-outline-primary").addClass("btn-primary"),$(document).triggerHandler({type:"switch_language.charcoal"}),e=$.Event("languageswitch"+this.EVENT_NAMESPACE,{language:t,originalLanguage:i,relatedTarget:this.$form[0],relatedComponent:this}),$(document).triggerHandler(e)))},Charcoal.Admin.Widget_Form.prototype.destroy=function(){this.$form.off(this.EVENT_NAMESPACE),$(".js-sidebar-widget",this.form_selector).off(this.EVENT_NAMESPACE),window.removeEventListener("popstate",this._on_popstate_tab),this.isTab&&this.$form.off("shown.bs.tab",".js-group-tabs",this._shown_tab_handler)},function(e,t,i){"use strict";function o(t){this.EVENT_NAMESPACE=o.EVENT_NAMESPACE,Charcoal.Admin.Widget.call(this,t),this.graph_options=t.graph_options||t.data.graph_options||{}}o.EVENT_NAMESPACE=".charcoal.widget.graph",((o.prototype=Object.create(Charcoal.Admin.Widget.prototype)).contructor=o).prototype.parent=Charcoal.Admin.Widget.prototype,o.prototype.init=function(){var t;echarts?(t=echarts.init(this.element()[0]),(this.chart=t).setOption(this.graph_options),e(i).on("resize"+this.EVENT_NAMESPACE,function(){t.resize()})):console.error("Could not initialize graph widget:","eCharts is missing")},o.prototype.destroy=function(){this.chart&&this.chart.dispose(),e(i).off("resize"+this.EVENT_NAMESPACE)},t.Widget_Graph=o}(jQuery,Charcoal.Admin,window),Charcoal.Admin.Widget_Map=function(t){return Charcoal.Admin.Widget.call(this,t),this._controller=void 0,this},Charcoal.Admin.Widget_Map.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Map.prototype.constructor=Charcoal.Admin.Widget_Map,Charcoal.Admin.Widget_Map.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Map.prototype.init=function(){var t=this;return"undefined"==typeof google?(window._tmp_google_onload_function=function(){t.activate_map()},$.getScript("https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&language=fr&callback=_tmp_google_onload_function",function(){})):t.activate_map(),this},Charcoal.Admin.Widget_Map.prototype.activate_map=function(){var t={default_styles:{strokeColor:"#000000",strokeOpacity:.8,strokeWeight:3,fillColor:"#ffffff",fillOpacity:.35,hover:{strokeColor:"#000000",strokeOpacity:1,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.5},focused:{fillOpacity:.8}},use_clusterer:!1,map:{center:{x:this.opts("coords")[0],y:this.opts("coords")[1]},zoom:14,mapType:"roadmap",coordsType:"inpage",map_mode:"default"},places:{first:{type:"marker",coords:this.coords()}}};this._controller=new window.BB.gmap.controller(this.element().find(".js-map-maker-map").get(0),t),this.controller().set_styles([{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]}]),this.controller().remove_focus(),this.controller().init()},Charcoal.Admin.Widget_Map.prototype.controller=function(){return this._controller},Charcoal.Admin.Widget_Map.prototype.coords=function(){return this.opts("coords")},Charcoal.Admin.Widget_Object_Revisions=function(t){return Charcoal.Admin.Widget.call(this,t),this.extra_form_data=t.extra_form_data||{},this.xhr=null,this.obj_id=Charcoal.Admin.parseNumber(t.obj_id)||0,this.obj_type=t.obj_type,this},Charcoal.Admin.Widget_Object_Revisions.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Object_Revisions.prototype.constructor=Charcoal.Admin.Widget_Object_Revisions,Charcoal.Admin.Widget_Object_Revisions.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Object_Revisions.prototype.init=function(){this.bind_events()},Charcoal.Admin.Widget_Object_Revisions.prototype.bind_events=function(){var e=this;$("#"+this.id()).on("click.object.revisions",".js-obj-revert",this.revert.bind(this)),$("#"+this.id()).on("click.charcoal.bs.dialog",'[data-dismiss="dialog"]',function(t){$.isFunction(e.cancel_callback)&&e.cancel_callback(t)})},Charcoal.Admin.Widget_Object_Revisions.prototype.revert=function(t){t.preventDefault();var e=Charcoal.Admin.admin_url()+"object/revert-revision",i={obj_type:this.obj_type,obj_id:this.obj_id,rev_num:$(t.currentTarget).attr("data-rev-num")};BootstrapDialog.show({title:objectRevisionsWidgetL10n.title,message:objectRevisionsWidgetL10n.message,buttons:[{id:"ok-btn",label:objectRevisionsWidgetL10n.restore,action:function(t){t.close(),$.ajax({url:e,type:"POST",data:i,dataType:"json",success:function(t){t.success?window.location.reload():(Charcoal.Admin.feedback().push([{level:"error",message:objectRevisionsWidgetL10n.restoreError}]),Charcoal.Admin.feedback().dispatch())},error:function(){Charcoal.Admin.feedback().push([{level:"error",message:objectRevisionsWidgetL10n.restoreError}]),Charcoal.Admin.feedback().dispatch()}})}}]})},Charcoal.Admin.Widget_Object_Revisions.prototype.disable_form=Charcoal.Admin.Widget_Form.prototype.disable_form,Charcoal.Admin.Widget_Object_Revisions.prototype.enable_form=Charcoal.Admin.Widget_Form.prototype.enable_form,Charcoal.Admin.Widget_Object_Revisions.prototype.request_url=Charcoal.Admin.Widget_Form.prototype.request_url,Charcoal.Admin.Widget_Object_Revisions.prototype.request_done=Charcoal.Admin.Widget_Form.prototype.request_done,Charcoal.Admin.Widget_Object_Revisions.prototype.request_failed=Charcoal.Admin.Widget_Form.prototype.request_failed,Charcoal.Admin.Widget_Object_Revisions.prototype.request_complete=Charcoal.Admin.Widget_Form.prototype.request_complete,Charcoal.Admin.Widget_Object_Revisions.prototype.request_success=function(t,e,i){i.feedbacks&&!this.suppress_feedback()&&Charcoal.Admin.feedback(i.feedbacks),i.next_url&&Charcoal.Admin.feedback().add_action({label:commonL10n.continue,callback:function(){window.location.href=Charcoal.Admin.admin_url()+i.next_url}})},Charcoal.Admin.Widget_Quick_Form=function(t){this.EVENT_NAMESPACE=Charcoal.Admin.Widget_Quick_Form.EVENT_NAMESPACE,Charcoal.Admin.Widget.call(this,t),this.save_callback=t.save_callback||"",this.cancel_callback=t.cancel_callback||"",this.form_selector=t.data.form_selector,this.$form=$(this.form_selector),this.save_action=t.save_action||"object/save",this.update_action=t.update_action||"object/update",this.extra_form_data=t.extra_form_data||{},this.group_conditions=t.data.group_conditions,this.group_display_mode=t.data.group_display_mode||"",this.show_language_switch=t.data.show_language_switch||!1,this.form_working=!1,this.is_new_object=!1,this.xhr=null,this.obj_id=Charcoal.Admin.parseNumber(t.obj_id)||0},Charcoal.Admin.Widget_Quick_Form.EVENT_NAMESPACE=".charcoal.quickform",Charcoal.Admin.Widget_Quick_Form.prototype=Object.create(Charcoal.Admin.Widget_Form.prototype),Charcoal.Admin.Widget_Quick_Form.prototype.constructor=Charcoal.Admin.Widget_Quick_Form,Charcoal.Admin.Widget_Quick_Form.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Quick_Form.prototype.init=function(){this.bind_events(),this.parse_group_conditions(),this.show_language_switch&&$('.nav-link.nav-lang[data-tab-ident="'+Charcoal.Admin.lang()+'"]').trigger("click")},Charcoal.Admin.Widget_Quick_Form.prototype.bind_events=function(){var e=this,t=this.$form;t.on("submit"+this.EVENT_NAMESPACE,function(t){t.preventDefault(),e.request_submit()}).on("click"+this.EVENT_NAMESPACE,'[data-dismiss="dialog"]',function(t){$.isFunction(e.cancel_callback)&&e.cancel_callback(t)}),this.show_language_switch&&t.on("click.nav-link.nav-lang","a.nav-link.nav-lang",function(t){t.preventDefault(),e.trigger_lang_tab($(this).attr("data-tab-ident"))})},Charcoal.Admin.Widget_Quick_Form.prototype.request_success=function(t){var e=$.Event("success"+this.EVENT_NAMESPACE,{subtype:"submission",component:this,response:t});this.$form.trigger(e),e.isDefaultPrevented()||(this.confirmed=!1,t.feedbacks&&!this.suppress_feedback()&&Charcoal.Admin.feedback(t.feedbacks),t.need_confirmation?this.add_actions_for_confirmation(t.confirmation_label):t.next_url?this.add_action_for_next_url(t.next_url,t.next_url_label):(this.enable_form(),this.form_working=!1,"function"==typeof this.save_callback&&this.save_callback(t)))},Charcoal.Admin.Widget_Quick_Form.prototype.trigger_lang_tab=function(e){$(".modal .form-field").each(function(){var t=$(this).attr("data-lang");t&&(e!==t?this.style.setProperty("display","none","important"):this.style.setProperty("display","block","important"))})},Charcoal.Admin.Widget_Relation=function(t){return Charcoal.Admin.Widget.call(this,t),this.dirty=!1,this},Charcoal.Admin.Widget_Relation.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Relation.prototype.constructor=Charcoal.Admin.Widget_Relation,Charcoal.Admin.Widget_Relation.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Relation.prototype.init=function(){if("function"!=typeof $.fn.sortable)return Charcoal.Admin.loadScript("https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js",this.init.bind(this)),this;var t=this.element().find(".js-relation-sortable .js-grid-container");return this.element().on("hidden.bs.collapse",'[data-toggle="collapse"]',function(){t.sortable("refreshPositions")}),t.sortable({handle:'[draggable="true"]',placeholder:"panel c-attachment_placeholder",start:function(t,e){e.item.children(".panel-heading").find('[data-toggle="collapse"]').hasClass("collapsed")||e.item.children(".panel-collapse").collapse("hide")}}).disableSelection(),this.listeners(),this},Charcoal.Admin.Widget_Relation.prototype.is_dirty=function(){return this.dirty},Charcoal.Admin.Widget_Relation.prototype.set_dirty_state=function(t){return this.dirty=t,this},Charcoal.Admin.Widget_Relation.prototype.listeners=function(){var r=this;this.element().off("click").on("click.charcoal.relation",".js-add-relation",function(t){t.preventDefault();t=$(this).data("type");if(!t)return!1;var e=$(this).data("id");e?(r.add({id:e,type:t}),r.create_relation(function(){r.reload()})):(e=$(this).data("title")||relationWidgetL10n.editObject,r.create_relation_dialog({title:e,widget_options:{form_data:{target_object_type:t,target_object_id:null}}},function(t){t.success&&(t.obj.id=t.obj_id,r.add(t.obj),r.create_relation(function(){r.reload()}))}))}).on("click.charcoal.relation",".js-relation-actions a",function(t){var e=$(this);if(e.data("action"))switch(t.preventDefault(),e.data("action")){case"edit":var i=e.data("type"),o=e.data("id");if(!i||!o)break;o=e.data("title")||relationWidgetL10n.editObject;r.create_relation_dialog({title:o,widget_options:{form_data:{target_object_type:i,target_object_id:null}}},function(t){t.success&&r.reload()});break;case"unlink":if(!e.data("id"))break;r.confirm({title:relationWidgetL10n.confirmRemoval,message:commonL10n.confirmAction,btnOKLabel:commonL10n.removeObject,callback:function(t){t&&r.remove_relation(e.data("id"),function(){r.reload()})}})}})},Charcoal.Admin.Widget_Relation.prototype.create_relation_dialog=function(t,e){t=t||{};var i=this.opts().data,i={size:BootstrapDialog.SIZE_WIDE,cssClass:"-quick-form",widget_type:"charcoal/admin/widget/quick-form",widget_options:{obj_type:"charcoal/relation/pivot",obj_id:0,form_data:{group:i.group,source_object_type:i.obj_type,source_object_id:i.obj_id,target_object_type:"",target_object_id:0}}},o=$.extend(!0,{},i,t,{}),r=this.dialog(o,function(t){if(t.success){if(!t.widget_id)return!1;Charcoal.Admin.manager().add_widget({id:t.widget_id,type:"charcoal/admin/widget/quick-form",data:{obj_type:o.widget_options.type},obj_id:o.widget_options.id,save_callback:function(t){e(t),this instanceof Charcoal.Admin.Component&&this.id()&&Charcoal.Admin.manager().destroy_component("widgets",this.id()),r.close()}}),Charcoal.Admin.manager().render()}})},Charcoal.Admin.Widget_Relation.prototype.add=function(t){if(!t)return!1;this.set_dirty_state(!0);var e=this.element().find(".js-relation-template").clone();return e.find(".js-relation").attr({"data-id":t.target_object_id,"data-type":t.target_object_type}),this.element().find(".js-relation-sortable").find(".js-grid-container").append(e),this},Charcoal.Admin.Widget_Relation.prototype.will_save=function(t){return t&&$.contains(t.element()[0],this.element()[0])},Charcoal.Admin.Widget_Relation.prototype.save=function(){return!this.is_dirty()&&(this.create_relation(),!0)},Charcoal.Admin.Widget_Relation.prototype.create_relation=function(t){var e=this,i=e.opts(),o={obj_type:i.data.obj_type,obj_id:i.data.obj_id,group:i.data.group,pivots:[]};this.element().find(".js-relation-container").find(".js-relation").each(function(t){var e=$(this),i=e.attr("data-id"),e=e.attr("data-type");o.pivots.push({target_object_id:i,target_object_type:e,position:t})}),$.post("relation/link",o,function(){"function"==typeof t&&t(),e.set_dirty_state(!1)},"json")},Charcoal.Admin.Widget_Relation.prototype.remove_relation=function(t,e){if(!t)return!1;var i=this;$.post("relation/unlink",{pivot_id:t},function(){"function"==typeof e&&e(),i.set_dirty_state(!1)},"json")},Charcoal.Admin.Widget_Relation.prototype.widget_options=function(){return this.opts("widget_options")},Charcoal.Admin.Widget_Search=function(t){return this.EVENT_NAMESPACE=Charcoal.Admin.Widget_Search.EVENT_NAMESPACE,Charcoal.Admin.Widget.call(this,t),this._elem=void 0,!!t&&(void 0!==t.id&&(this.set_element($("#"+t.id)),"object"==typeof t.data&&(this.data=t.data,this.$input=null,this._search_filters=!1,this._search_query=!1,this)))},Charcoal.Admin.Widget_Search.EVENT_NAMESPACE=".charcoal.widget.search",Charcoal.Admin.Widget_Search.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Search.prototype.constructor=Charcoal.Admin.Widget_Search,Charcoal.Admin.Widget_Search.prototype.parent=Charcoal.Admin.Widget.prototype,Charcoal.Admin.Widget_Search.prototype.widget_options=function(){return this.data},Charcoal.Admin.Widget_Search.prototype.set_remote_widget=function(){},Charcoal.Admin.Widget_Search.prototype.init=function(){var e=this,t=this.element();this.$input=t.find('[name="query"]'),t.on("submit"+this.EVENT_NAMESPACE,function(t){t.preventDefault(),e.submit()}),t.on("reset"+this.EVENT_NAMESPACE,function(t){t.preventDefault(),e.clear()})},Charcoal.Admin.Widget_Search.prototype.submit=function(){return this.set_search_query(this.$input.val()),Charcoal.Admin.manager().get_widgets().forEach(this.dispatch.bind(this)),this.set_search_query(null),this},Charcoal.Admin.Widget_Search.prototype.clear=function(){return this._search_search=!1,this._search_filters=!1,this.$input.val(""),this.submit(),this},Charcoal.Admin.Widget_Search.prototype.parse_search_query=function(t){return"string"!=typeof t||0===(t=t.trim()).length?null:t},Charcoal.Admin.Widget_Search.prototype.parse_search_filters=function(t){var e,o,r=[];return(t=this.parse_search_query(t))&&(t=t.split(/\s/),e=this.data.properties||[],$.each(t,function(t,i){o=[],i=i.replace(/'/g,"\\'"),$.each(e,function(t,e){o.push({property:e,operator:"LIKE",value:"%"+i+"%"})}),r.push({conjunction:"OR",filters:o})})),r.length?r:null},Charcoal.Admin.Widget_Search.prototype.set_search_query=function(t){this._search_search=this.parse_search_query(t),this._search_filters=!1},Charcoal.Admin.Widget_Search.prototype.search_query=function(){return!1===this._search_search?null:this._search_search},Charcoal.Admin.Widget_Search.prototype.search_filters=function(){return!1===this._search_filters&&(this._search_filters=this.parse_search_filters(this._search_search)),this._search_filters},Charcoal.Admin.Widget_Search.prototype.dispatch=function(t){if(t&&t!==this){var e="function"==typeof t.set_search_query,i="function"==typeof t.set_filter;if(!e&&!i)return this;e&&(e=this.search_query(),t.set_search_query(e)),i&&(e=this.search_filters(),t.set_filter("search",e)),void 0!==t.pagination&&(t.pagination.page=1),t.reload(null,!0)}},Charcoal.Admin.Widget_Search.prototype.destroy=function(){this.element().off(this.EVENT_NAMESPACE)},Charcoal.Admin.Widget_Table=function(t){Charcoal.Admin.Widget.call(this,t),this.obj_type=null,this.widget_id=null,this.table_selector=null,this.pagination={page:1,num_per_page:50},this.list_actions={},this.object_actions={},this.template=this.properties=this.properties_options=void 0,this.sortable=!1,this.sortable_handler=null},Charcoal.Admin.Widget_Table.prototype=Object.create(Charcoal.Admin.Widget.prototype),Charcoal.Admin.Widget_Table.prototype.constructor=Charcoal.Admin.Widget_Table,Charcoal.Admin.Widget_Table.prototype.parent=Charcoal.Admin.Widget.prototype,Object.assign(Charcoal.Admin.Widget_Table.prototype,Charcoal.Admin.Mixin_Model_Search),Object.assign(Charcoal.Admin.Widget_Table.prototype,Charcoal.Admin.Mixin_Model_Filters),Object.assign(Charcoal.Admin.Widget_Table.prototype,Charcoal.Admin.Mixin_Model_Orders),Charcoal.Admin.Widget_Table.prototype.init=function(){this.set_properties().bind_events()},Charcoal.Admin.Widget_Table.prototype.set_properties=function(){var t=this.opts();return this.obj_type=t.data.obj_type||this.obj_type,this.widget_id=t.id||this.widget_id,this.table_selector="#"+this.widget_id,this.sortable=t.data.sortable||this.sortable,this.template=t.data.template||this.template,this.collection_ident=t.data.collection_ident||"default","properties"in t.data&&Array.isArray(t.data.properties)&&(this.properties=t.data.properties),"properties_options"in t.data&&$.isPlainObject(t.data.properties_options)&&(this.properties_options=t.data.properties_options),"filters"in t.data&&this.set_filters(t.data.filters),"orders"in t.data&&this.set_orders(t.data.orders),"pagination"in t.data&&$.isPlainObject(t.data.pagination)&&(this.pagination=t.data.pagination),"list_actions"in t.data&&(Array.isArray(t.data.list_actions)?this.list_actions=Object.assign({},t.data.list_actions):$.isPlainObject(t.data.list_actions)&&(this.list_actions=t.data.list_actions)),"object_actions"in t.data&&(Array.isArray(t.data.object_actions)?this.object_actions=Object.assign({},t.data.object_actions):$.isPlainObject(t.data.object_actions)&&(this.object_actions=t.data.object_actions)),this},Charcoal.Admin.Widget_Table.prototype.bind_events=function(){null!==this.sortable_handler&&this.sortable_handler.destroy();var e=this,t=$("tbody.js-sortable",e.table_selector);0<t.length&&(this.sortable_handler=new window.Sortable.default(t.get(),{delay:150,draggable:".js-table-row",handle:".js-sortable-handle",mirror:{constrainDimensions:!0}}).on("mirror:create",function(t){var e=t.originalSource.querySelectorAll(":scope > td"),i=t.source.querySelectorAll(":scope > td");e.forEach(function(t,e){i[e].style.width=t.offsetWidth+"px"})}).on("sortable:stop",function(t){t.oldIndex!==t.newIndex&&(t=Array.from(t.newContainer.querySelectorAll(":scope > tr")).map(function(t){return t.classList.contains("draggable-mirror")||t.classList.contains("draggable--original")?"":t.getAttribute("data-id")}).filter(function(t){return""!==t}),$.ajax({method:"POST",url:Charcoal.Admin.admin_url()+"object/reorder",data:{obj_type:e.obj_type,obj_orders:t,starting_order:1},dataType:"json"}).done(function(t){console.debug(t),t.feedbacks&&Charcoal.Admin.feedback(t.feedbacks).dispatch()}))})),$(".js-jump-page-form",e.table_selector).on("submit",function(t){t.preventDefault();t=$(this),t=parseInt(t.find("input").val());t&&(e.pagination.page=t,e.reload(null,!0))}),$(".js-page-switch",e.table_selector).on("click",function(t){t.preventDefault();t=$(this).data("page-num");e.pagination.page=t,e.reload(null,!0)})},Charcoal.Admin.Widget_Table.prototype.widget_options=function(){return{obj_type:this.obj_type,template:this.template,sortable:this.sortable,collection_ident:this.collection_ident,collection_config:{properties:this.properties,properties_options:this.properties_options,search_query:this.get_search_query(),filters:this.get_filters(),orders:this.get_orders(),pagination:this.pagination,list_actions:this.list_actions,object_actions:this.object_actions}}},Charcoal.Admin.Property=function(t){return Charcoal.Admin.Component.call(this,t),this._ident,this._val,this._input_type,t&&("string"==typeof t.ident&&this.set_ident(t.ident),void 0!==t.val&&this.set_val(t.val),void 0!==t.input_type&&this.set_input_type(t.input_type)),this},Charcoal.Admin.Property.prototype=Object.create(Charcoal.Admin.Component.prototype),Charcoal.Admin.Property.prototype.constructor=Charcoal.Admin.Property,Charcoal.Admin.Property.prototype.parent=Charcoal.Admin.Component.prototype,Charcoal.Admin.Property.prototype.element=function(){if(!this._element){if(!this.id())return null;this.set_element("#"+this.id())}return this._element},Charcoal.Admin.Property.prototype.set_ident=function(t){return this._ident=t,this},Charcoal.Admin.Property.prototype.ident=function(){return this._ident},Charcoal.Admin.Property.prototype.set_input_type=function(t){return this._input_type=t,this},Charcoal.Admin.Property.prototype.input_type=function(){return this._input_type},Charcoal.Admin.Property.prototype.set_val=function(t){return this._val=t,this},Charcoal.Admin.Property.prototype.val=function(){return this._val},Charcoal.Admin.Property.prototype.error=function(t){window.console.error(t)},Charcoal.Admin.Property_Input_File=function(t){this.EVENT_NAMESPACE=Charcoal.Admin.Property_Input_File.EVENT_NAMESPACE,this.input_type="charcoal/admin/property/input/file",Charcoal.Admin.Property.call(this,t),this.data=t.data,this.dialog=null,this.set_input_id(t.id).init()},Charcoal.Admin.Property_Input_File.EVENT_NAMESPACE=".charcoal.property.file",Charcoal.Admin.Property_Input_File.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_File.prototype.constructor=Charcoal.Admin.Property_Input_File,Charcoal.Admin.Property_Input_File.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_File.prototype.init=function(){this.input_id&&(this.$input=$("#"+this.input_id),this.$file=$("#"+this.data.file_input_id).or('input[type="file"]',this.$input),this.$hidden=$("#"+this.data.hidden_input_id).or('input[type="hidden"]',this.$input),this.$previewFile=this.$input.find(".js-preview-file"),this.$previewText=this.$input.find(".js-preview-text"),window.elFinderCallback||(window.elFinderCallback={}),this.set_listeners())},Charcoal.Admin.Property_Input_File.prototype.set_listeners=function(){void 0!==this.$input&&(this.$input.on("click"+this.EVENT_NAMESPACE,".js-remove-file",this.remove_file.bind(this)).on("click"+this.EVENT_NAMESPACE,".js-elfinder",this.load_elfinder.bind(this)),this.$file.on("change"+this.EVENT_NAMESPACE,this.change_file.bind(this)),window.elFinderCallback[this.input_id]=this.elfinder_callback.bind(this))},Charcoal.Admin.Property_Input_File.prototype.remove_file=function(t){t.preventDefault(),this.$hidden.val(""),this.$file.val(""),this.$previewFile.empty(),this.$previewText.empty(),this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none")},Charcoal.Admin.Property_Input_File.prototype.change_file=function(t){this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none"),this.$previewFile.empty(),this.$previewText.empty(),t.target&&t.target.files&&t.target.files[0]&&(t=t.target.files[0],console.log("[Property_Input_File.change_file]",t),this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$previewText.html(t.name))},Charcoal.Admin.Property_Input_File.prototype.load_elfinder=function(t){t.preventDefault(),this.dialog=BootstrapDialog.show({title:this.data.dialog_title||"",size:BootstrapDialog.SIZE_WIDE,cssClass:"-elfinder",message:$('<iframe name="'+this.input_id+'-elfinder" width="100%" height="400px" frameborder="0" src="'+this.data.elfinder_url+'"></iframe>')})},Charcoal.Admin.Property_Input_File.prototype.elfinder_callback=function(t){var e;this.dialog&&this.dialog.close(),this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none"),this.$previewFile.empty(),this.$previewText.empty(),t&&t.url&&(e=decodeURI(t.url).replace(Charcoal.Admin.base_url(),""),console.log("[Property_Input_File.elfinder_callback]",t),this.$hidden.val(e),this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$previewText.html(t.name))},Charcoal.Admin.Property_Input_File.prototype.set_input_id=function(t){return this.input_id=t,this},Charcoal.Admin.Property_Input_File.prototype.set_input_name=function(t){return this.input_name=t,this},Charcoal.Admin.Property_Input_File.prototype.set_input_val=function(t){return this.input_val=t,this},Charcoal.Admin.Property_Input_File.prototype.destroy=function(){this.$input.off(this.EVENT_NAMESPACE),this.$file.off(this.EVENT_NAMESPACE)},function(s,n,y){"use strict";var l="[Property_Input_Audio_Recorder]",e=".charcoal.property.audio.recorder",a={CLICK:"click"+e},i=0,r=1,c=2,o=3,d=4,p=5,h=6,u=7,_=8,m=9,f=10,g=11,b=12,A=".js-recording-record",C=".js-recording-playback",v=".js-recording-stop",w=".js-recording-reset",F=".js-recording-visualizer",O=".js-recording-time-elapsed",L=".js-recording-time-duration",E="round",j="#EBEDF0",P="#DEE2E6",k=5,N=2,t=null,$=null;function T(t){this.EVENT_NAMESPACE=e,this.PROPERTY_IDLE=i,this.PROPERTY_READY=r,this.PROPERTY_LIVE=c,this.MODE_IDLE=o,this.MODE_PLAYBACK=d,this.MODE_CAPTURE=p,this.MEDIA_IDLE=h,this.MEDIA_LOCKED=u,this.MEDIA_BUSY=_,this.MEDIA_PAUSED=m,this.VISUAL_NONE=f,this.VISUAL_WAVEFORM=g,this.VISUAL_FREQUENCY=b,n.Property.call(this,t),this.data=t.data,this.data.id=t.id,this.readyState=i,this.mediaMode=o,this.mediaState=h,this.mediaVisual=f,this.status=null,this.mediaPromise=null,this.mediaStream=null,this.audioRecorder=null,this.audioContext=null,this.analyserNode=null,this.canvasElement=null,this.canvasContext=null,this.isFirefox=-1<y.navigator.userAgent.toLowerCase().indexOf("firefox"),this.recordingStartDate=null,this.recordingDuration=0,this.playbackCurrentTime=0,this.playbackDuration=0,this.workerPostMessageTimeoutID=null,this.drawVisualizationFrameID=null,void 0===this.data.worker_timeout&&(this.data.worker_timeout=5e3),void 0===this.data.buffer_length&&(this.data.buffer_length=4096),void 0===this.data.sample_rate&&(this.data.sample_rate=2),void 0===this.data.num_channels&&(this.data.num_channels=2),void 0===this.data.mime_type&&(this.data.mime_type="audio/wav"),this.init()}function S(t,e,i){n.debug()&&console.log(l,"Recorder Plugin Failed"),$=!1,this.status="Error";var o=audioPropertyL10n.missingRecorderPlugin;i&&(o+=" "+commonL10n.reason+" "+i),W(o,!0),"function"==typeof this.data.on_stream_error&&this.data.on_stream_error(new Error(o))}function x(){n.debug()&&console.log(l,"Streaming Ended"),this.readyState===c&&(this.readyState=r),this.status="Ended",this.disable(),"function"==typeof this.data.on_stream_ended&&this.data.on_stream_ended(event),this.mediaStream[this.id()]=!1,this.mediaStream=null,this.mediaPromise=null}function I(){return"boolean"!=typeof t&&(t=!0,void 0===y.navigator.mediaDevices&&(y.navigator.mediaDevices={}),y.navigator.mediaDevices.getUserMedia||(y.navigator.mediaDevices.getUserMedia=function(i){var o=y.navigator.webkitGetUserMedia||y.navigator.mozGetUserMedia;return o?new Promise(function(t,e){o.call(navigator,i,t,e)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))}),y.cancelAnimationFrame||(y.webkitCancelAnimationFrame?y.cancelAnimationFrame=y.webkitCancelAnimationFrame:y.mozCancelAnimationFrame?y.cancelAnimationFrame=y.mozCancelAnimationFrame:(t=!1,console.error(l,"The window.mozCancelAnimationFrame method is missing."))),y.requestAnimationFrame||(y.webkitRequestAnimationFrame?y.requestAnimationFrame=y.webkitRequestAnimationFrame:y.mozRequestAnimationFrame?y.requestAnimationFrame=y.mozRequestAnimationFrame:(t=!1,console.error(l,"The window.requestAnimationFrame method is missing."))),y.AudioContext||(y.webkitAudioContext?y.AudioContext=y.webkitAudioContext:(t=!1,console.error(l,"The window.AudioContext interface is missing."))),y.URL||(y.webkitURL?y.URL=y.webkitURL:(t=!1,console.warning(l,"The window.URL interface is missing."))),y.FileReader||(t=!1,console.warning(l,"The window.FileReader interface is missing.")),y.Uint8Array||(t=!1,console.warning(l,"The window.Uint8Array interface is missing."))),t}function W(t,e){!0===e&&(e=t instanceof Error?t.message:"string"==typeof t?t:audioPropertyL10n.captureFailed+" "+commonL10n.errorOccurred),t&&console.error(l,t),e&&y.alert(e)}function M(t){if(t.name)switch(t.name){case"DevicesNotFoundError":t.name="NotFoundError";break;case"TrackStartError":t.name="NotReadableError";break;case"ConstraintNotSatisfiedError":t.name="OverconstrainedError";break;case"PermissionDeniedError":t.name="NotAllowedError"}return t}function z(t,e,i,o,r,n){var a,s,l,c,d;for(i.clearRect(0,0,t,e),c=0;c<t;c++){for(s=-(l=1),d=0;d<o;d++)(a=n[c*o+d])<l&&(l=a),s<a&&(s=a);i.fillRect(c,(1+l)*r,1,Math.max(1,(s-l)*r))}}function R(t){if("number"!=typeof t)return"--:--";if(0===t)return"00:00";var e=0|Math.floor(t/60);return t=Math.round(t)%60|0,q(e)+":"+q(t)}function q(t){return(t<10?"0":"")+t}function D(t){return.001*(Date.now()-t)}T.EVENT_NAMESPACE=e,((T.prototype=Object.create(n.Property.prototype)).constructor=T).prototype.parent=n.Property.prototype,T.prototype.init=function(){var t,e,i,o,r,n,a=this.element();this.$hidden=s("#"+this.data.hidden_input_id).or('input[type="hidden"]',a),0===this.$hidden.length?console.error(l,"Missing hidden input to store captured audio"):(n=s(F,a),t=s(A,a),e=s(C,a),i=s(v,a),o=s(w,a),r=s(O,a),a=s(L,a),0===n.length?console.error(l,"Missing visualizer element to graph audio"):(this.canvasElement=n[0],this.canvasContext=this.canvasElement.getContext("2d"),this.recorder_elements={$visualizer:n,$recordButton:t,$playButton:e,$stopButton:i,$resetButton:o,$buttons:s([]).add(t).add(e).add(i).add(o),$elapsed:r,$duration:a},this.disable(),I()?this.boot():(W(n=audioPropertyL10n.unsupportedAPI,!0),"function"==typeof this.data.on_stream_error&&this.data.on_stream_error(new Error(n)))))},T.prototype.boot=function(){switch($){case!1:var t=audioPropertyL10n.missingRecorderPlugin;return W(t,!0),void("function"==typeof this.data.on_stream_error&&this.data.on_stream_error(new Error(t)));case!0:return n.debug()&&console.log(l,"Recorder Plugin Ready"),void this.get_user_media();case null:return void(this.data.recorder_plugin_url?((t=s.getCachedScript(this.data.recorder_plugin_url)).then(function(t,e,i){var o=s.Deferred();return"function"==typeof y.Recorder?o.resolveWith(this,arguments):o.rejectWith(this,[i,"error","Script Unavailable"])}.bind(this)).done(function(){n.debug()&&console.log(l,"Recorder Plugin Loaded");$=!0,this.get_user_media()}.bind(this)).catch(S.bind(this)),$=t):S.call(this,void 0,"error",audioPropertyL10n.missinRecorderUrl))}},T.prototype.get_user_media=function(t){return this.mediaPromise&&!0!==t||(t={audio:!0,video:!1},"object"==typeof this.data.stream_constraints&&(t.audio=this.data.stream_constraints),(t=y.navigator.mediaDevices.getUserMedia(t)).then(function(t){this.mediaStream=t,n.debug()&&console.log(l,"Streaming Started");this.readyState===i&&(this.readyState=r,this.bind_element_events());this.readyState===r&&(this.readyState=c,this.status="OK",this.bind_stream_events(),this.setup_stream());this.toggle_transport_toolbar(),"function"==typeof this.data.on_stream_ready&&this.data.on_stream_ready(t)}.bind(this)).catch(function(t){n.debug()&&console.log(l,"Streaming Failed");this.readyState===c&&(this.readyState=r);t=M(t),this.status=t.name||"Error",this.disable(),W(t,!0),"function"==typeof this.data.on_stream_error&&this.data.on_stream_error(t)}.bind(this)),this.mediaPromise=t),this.mediaPromise},T.prototype.stop_user_media=function(){this.mediaStream&&(n.debug()&&console.log(l,"Stopping Stream"),this.mediaStream.getTracks().forEach(function(t){t.stop()}),"boolean"!=typeof this.mediaStream[this.id()]&&x.call(this))},T.prototype.get_player=function(t){if(!this.audioPlayer||!0===t)try{this.audioPlayer=this.create_player()}catch(t){return W(t,!0),null}return this.audioPlayer},T.prototype.create_player=function(t){var e=function(t){var t=t.target;n.debug()&&console.log(l,"[Playback]","Audio Failed"),t=t.error,this.mediaMode=o,this.mediaState=h,this.toggle_transport_toolbar(),this.update_time(),this.update_duration(),W(t,!0)}.bind(this),i=function(t){t=t.target;n.debug()&&console.log(l,"[Playback]","Audio Ready"),0!==t.readyState&&(this.mediaMode===o&&(this.mediaMode=d,this.mediaState=h,this.toggle_transport_toolbar()),this.update_time(),this.update_duration())}.bind(this),e={properties:{type:this.data.mime_type},listeners:{error:e,ended:this.stop_playback.bind(this),loadedmetadata:i,timeupdate:this.update_time.bind(this)}};return Object.assign(e,t),new y.SimpleAudioElement(e)},T.prototype.get_recorder=function(t,e){if(!this.audioRecorder||t)try{this.audioRecorder=this.create_recorder(t,e)}catch(t){return W(t,!0),null}return this.audioRecorder},T.prototype.create_recorder=function(t,e){var i,o=new y.Recorder(t,e);if(o.worker instanceof y.Worker&&(t=function(t){n.debug()&&console.log(l,"Recorder Worker Failed",t),this.readyState===c&&(this.readyState=r),this.disable(),"function"==typeof this.data.on_stream_error&&this.data.on_stream_error(t)}.bind(this),o.worker.onerror=t,o.worker.onmessageerror=t),o.node){if("function"!=typeof o.node.onaudioprocess)throw new Error("Missing onaudioprocess handler on Recorder");i=o.node.onaudioprocess,o.node.onaudioprocess=function(t){o.recording&&(this.update_time(this.get_record_time()),i.call(o,t))}.bind(this)}return o},T.prototype.bind_element_events=function(){var t=this.element(),e=function(t){t.preventDefault(),this.toggle_capture()}.bind(this),i=function(t){t.preventDefault(),this.toggle_playback()}.bind(this),o=function(t){t.preventDefault(),this.stop()}.bind(this),r=function(t){t.preventDefault(),this.stop(!1),this.clear()}.bind(this);t.on(a.CLICK,A,e),t.on(a.CLICK,C,i),t.on(a.CLICK,v,o),t.on(a.CLICK,w,r)},T.prototype.bind_stream_events=function(){if(!(this.mediaStream instanceof MediaStream))throw new Error("Invalid or missing media stream");var t=0,e=function(){1===++t&&x.call(this)}.bind(this),i=function(t){t.track&&t.track.addEventListener("ended",e)}.bind(this);this.mediaStream.getTracks().forEach(function(t){t.addEventListener("ended",e)}),this.mediaStream.addEventListener("addtrack",i),this.mediaStream[this.id()]=!0},T.prototype.setup_stream=function(){if(!(this.mediaStream instanceof MediaStream))throw new Error("Invalid or missing media stream");var t,e;this.audioContext=new y.AudioContext,t=this.audioContext.createGain(),this.audioContext.createMediaStreamSource(this.mediaStream).connect(t),this.analyserNode=this.audioContext.createAnalyser(),this.analyserNode.fftSize=2048,t.connect(this.analyserNode),this.get_recorder(t),(e=this.audioContext.createGain()).gain.value=0,t.connect(e),e.connect(this.audioContext.destination),this.visualize(b)},T.prototype.stop=function(t){switch(n.debug()&&console.group(l,"Stop"),this.mediaMode){case d:this.stop_playback();break;case p:this.stop_capture(t)}n.debug()&&console.groupEnd()},T.prototype.clear=function(){n.debug()&&console.group(l,"Clear"),this.mediaMode!==o||this.mediaState!==h?n.debug()&&(console.log("Bail:","Bad Mode or State"),console.groupEnd()):(this.mediaMode=o,this.mediaState=u,this.mediaVisual=f,this.toggle_transport_toolbar(),this.update_time(null),this.update_duration(null),this.clear_visualization(),this.clear_playback(),this.clear_capture(),this.$hidden.val(void 0),this.mediaState=h,this.visualize(b),this.toggle_transport_toolbar(),n.debug()&&console.groupEnd())},T.prototype.has_recording=function(){var t=this.get_player();if(t.getElement&&"string"==typeof(t=t.getElement()).src)return 0<t.src.length;throw new Error("Missing audio player. Can not detect recording.")},T.prototype.is_capturing=function(t){return this.mediaMode===p&&this.is_busy(t)},T.prototype.is_playing=function(t){return this.mediaMode===d&&this.is_busy(t)},T.prototype.is_busy=function(t){return!0===t?this.mediaState===_:this.mediaState!==h},T.prototype.toggle_capture=function(){this.mediaMode===d&&this.stop_playback(),this.has_recording()?(n.debug()&&console.log(l,"[Capture]","Restart Recording"),this.clear()):n.debug()&&console.log(l,"[Capture]",this.recordingStartDate?"Resume Recording":"New Recording"),this.mediaMode=p,this.mediaState===_?this.pause_capture():this.start_capture()},T.prototype.start_capture=function(){if(n.debug()&&console.group(l,"[Capture]","Start"),this.mediaMode===p){this.mediaState=_,this.visualize(b),this.toggle_transport_toolbar();var t=this.get_recorder();if(t.record)return t.recording||(this.recordingStartDate=Date.now()),t.record(),void(n.debug()&&console.groupEnd());throw n.debug()&&console.groupEnd(),new Error("Missing audio recorder. Can not capture audio.")}n.debug()&&(console.log("Bail:","Bad Mode"),console.groupEnd())},T.prototype.pause_capture=function(){if(n.debug()&&console.group(l,"[Capture]","Pause"),this.mediaMode===p&&this.mediaState===_){this.mediaState=m,this.toggle_transport_toolbar();var t=this.get_recorder();if(t.stop)return t.recording&&this.recordingStartDate&&(this.recordingDuration+=D(this.recordingStartDate)),t.stop(),void(n.debug()&&console.groupEnd());throw n.debug()&&console.groupEnd(),new Error("Missing audio recorder. Can not pause audio capture.")}n.debug()&&(console.log("Bail:","Bad Mode or Idle"),console.groupEnd())},T.prototype.stop_capture=function(t){if(t=!1!==t,n.debug()&&console.group(l,"[Capture]","Stop",t),this.mediaMode===p){this.mediaMode=o,this.mediaState=u,this.toggle_transport_toolbar();var e=this.get_recorder();if(e.stop)return e.recording&&this.recordingStartDate&&(this.recordingDuration+=D(this.recordingStartDate),this.recordingStartDate=null,n.debug()&&console.log("Recorded Time: ",this.recordingDuration)),e.stop(),t?(e.getBuffer(this.render_recorded_audio.bind(this)),e.exportWAV(this.export_recorded_audio.bind(this)),t=function(){n.debug()&&console.error(l,"[Capture]","Web Worker Timeout"),this.readyState===c&&(this.readyState=r),this.status="Timeout",this.disable(),W(audioPropertyL10n.captureFailed+" "+commonL10n.workerTimedout,!0),"function"==typeof this.data.on_stream_error&&this.data.on_stream_error(new Error(commonL10n.workerTimedout))}.bind(this),this.workerPostMessageTimeoutID=y.setTimeout(t,this.data.worker_timeout)):(this.mediaState=h,this.visualize(b),this.toggle_transport_toolbar(),this.update_time(0)),void(n.debug()&&console.groupEnd());throw n.debug()&&console.groupEnd(),new Error("Missing audio recorder. Can not stop audio capture.")}n.debug()&&(console.log("Bail:","Bad Mode"),console.groupEnd())},T.prototype.clear_capture=function(){n.debug()&&console.group(l,"[Capture]","Clear");var t=this.get_recorder();if(t.clear)return this.recordingDuration=0,this.recordingStartDate=null,t.clear(),void(n.debug()&&console.groupEnd());throw n.debug()&&console.groupEnd(),new Error("Missing audio recorder. Can not discard recorded audio.")},T.prototype.render_recorded_audio=function(t){if(!(Array.isArray(t)&&0<t.length))throw new Error("Invalid or empty audio buffer");var e,i,o,r;n.debug()&&console.log(l,"[Capture]","Illustrating Recording"),e=this.canvasElement,i=this.canvasContext,t=t[0],o=Math.ceil(t.length/e.width),r=e.height/2,i.lineCap=E,i.fillStyle=j,this.clear_visualization(),this.mediaVisual=g,z(e.width,e.height,i,o,r,t)},T.prototype.export_recorded_audio=function(t){if(!(t instanceof y.Blob&&0<t.size))throw new Error("Invalid or empty audio blob");var e,i,o;n.debug()&&console.log(l,"[Capture]","Exporting Recording"),this.workerPostMessageTimeoutID&&(y.clearTimeout(this.workerPostMessageTimeoutID),this.workerPostMessageTimeoutID=null),e=new y.FileReader,i=function(t){e.result?(n.debug()&&console.log(l,"[Capture]","Export Completed"),this.dispatch_recorded_audio(e.result)):o(t)}.bind(this),o=function(t){n.debug()&&console.log(l,"[Capture]","Export Failed"),W(t,!0)}.bind(this),e.addEventListener("loadend",i),e.addEventListener("error",o),e.readAsDataURL(t)},T.prototype.dispatch_recorded_audio=function(t){if(n.debug()&&console.group(l,"[Capture]","Dispatch Recording"),!t)throw n.debug()&&console.groupEnd(),new Error("Invalid or empty audio data");this.$hidden.val(t);var e=this.get_player();if(e.src)return e.src(t),e.load(),void(n.debug()&&console.groupEnd());throw n.debug()&&console.groupEnd(),new Error("Missing audio player. Can not load recorded audio.")},T.prototype.toggle_playback=function(){this.mediaMode===p&&this.stop_capture(),this.mediaMode=d,this.mediaState===_?this.pause_playback():this.start_playback()},T.prototype.start_playback=function(){if(n.debug()&&console.group(l,"[Playback]","Start"),this.mediaMode!==d)n.debug()&&(console.log("Bail:","Bad Mode"),console.groupEnd());else{if(this.has_recording()){this.mediaState=_,this.visualize(g),this.toggle_transport_toolbar();var t,e=this.get_player();if(e.play)return(e=e.play())instanceof Promise&&(n.debug()&&console.log("Playing"),t=function(t){n.debug()&&console.error(l,"[Playback]","Play/Resume Failed"),W(t=M(t),!0)}.bind(this),e.catch(t)),void(n.debug()&&console.groupEnd());throw n.debug()&&console.groupEnd(),new Error("Missing audio player. Can not play recorded audio.")}n.debug()&&(console.log("Bail:","Missing Recording"),console.groupEnd())}},T.prototype.pause_playback=function(){if(n.debug()&&console.group(l,"[Playback]","Pause"),this.mediaMode===d&&this.mediaState===_){this.mediaState=m,this.toggle_transport_toolbar();var t=this.get_player();if(t.pause)return t.pause(),void(n.debug()&&console.groupEnd());throw n.debug()&&console.groupEnd(),new Error("Missing audio player. Can not pause recorded audio.")}n.debug()&&(console.log("Bail:","Bad Mode or Idle"),console.groupEnd())},T.prototype.stop_playback=function(){if(n.debug()&&console.group(l,"[Playback]","Stop"),this.mediaMode===d){this.mediaMode=o,this.mediaState=h,this.toggle_transport_toolbar();var t=this.get_player();if(t.stop)return t.stop(),void(n.debug()&&console.groupEnd());throw n.debug()&&console.groupEnd(),new Error("Missing audio player. Can not stop recorded audio.")}n.debug()&&(console.log("Bail:","Bad Mode"),console.groupEnd())},T.prototype.clear_playback=function(){n.debug()&&console.group(l,"[Playback]","Clear"),this.audioPlayer=null,n.debug()&&console.groupEnd()},T.prototype.visualize=function(t){if(this.readyState===c&&this.mediaVisual!==t){switch(t){case f:return this.clear_visualization(),void(this.mediaVisual=t);case g:return this.create_waveform_visualization(),void(this.mediaVisual=t);case b:return this.create_frequency_visualization(),void(this.mediaVisual=t)}throw new TypeError("Invalid visualization mode")}},T.prototype.create_waveform_visualization=function(){var e,i,o,r,n,a,t,s;this.pause_visualization(),i=this.canvasElement,o=this.canvasContext,t=(r=this.analyserNode).fftSize,s=new y.Uint8Array(t),n=Math.ceil(s.length/i.width),a=i.height/2,(e=function(){this.drawVisualizationFrameID=y.requestAnimationFrame(e.bind(this)),r.getByteFrequencyData(s);var t=this.is_playing(!0)?P:j;o.lineCap=E,o.fillStyle=t,z(i.width,i.height,o,n,a,s)}).call(this)},T.prototype.create_frequency_visualization=function(){var d,p,h,u,_,m,t,f;this.pause_visualization(),p=this.canvasElement,h=this.canvasContext,u=this.analyserNode,m=Math.round(p.width/k),t=u.frequencyBinCount,_=t/m,f=new y.Uint8Array(t),(d=function(){this.drawVisualizationFrameID=y.requestAnimationFrame(d.bind(this)),u.getByteFrequencyData(f);var t,e,i,o,r=this.is_capturing(!0)?P:j,r=(h.lineCap=E,h.fillStyle=r,p.width),n=p.height,a=h,s=_,l=m,c=f;for(a.clearRect(0,0,r,n),i=1;i<=l;++i){for(t=0,e=Math.floor(i*s),o=0;o<s;o++)t+=c[e+o];t/=s,a.fillRect(i*k,n,N,-t)}}).call(this)},T.prototype.clear_visualization=function(){this.pause_visualization();var t=this.canvasElement;this.canvasContext.clearRect(0,0,t.width,t.height)},T.prototype.pause_visualization=function(){this.drawVisualizationFrameID&&(y.cancelAnimationFrame(this.drawVisualizationFrameID),this.drawVisualizationFrameID=null)},T.prototype.get_record_time=function(){return this.recordingStartDate?this.recordingDuration+D(this.recordingStartDate):this.recordingDuration},T.prototype.get_current_time=function(){switch(this.mediaMode){case o:return 0;case d:return this.get_player().getElement().currentTime;case p:return this.get_record_time()}return null},T.prototype.get_duration=function(){switch(this.mediaMode){case o:case d:var t=this.get_player().getElement();return this.fix_duration(Number(t.duration));case p:return this.get_record_time()}return null},T.prototype.fix_duration=function(t){if(0<this.recordingDuration&&1e3<Math.abs(t-this.recordingDuration))return Math.min(t,this.recordingDuration);return t},T.prototype.update_time=function(e){var t=function(){var t;"number"!=typeof e&&(e=this.get_current_time()),t=R(this.playbackCurrentTime=e),this.recorder_elements.$elapsed.text(t)}.bind(this);y.setTimeout(t)},T.prototype.update_duration=function(e){var t=function(){var t;"number"!=typeof e&&(e=this.get_duration()),t=R(this.playbackDuration=e),this.recorder_elements.$duration.text(t)}.bind(this);y.setTimeout(t,this.isFirefox?100:10)},T.prototype.disable_transport_toolbar=function(){this.recorder_elements.$buttons.disable()},T.prototype.toggle_transport_toolbar=function(t,e){var i,o,r;switch(void 0===t&&(t=this.mediaState),void 0===e&&(e=this.mediaMode),i=this.element(),o=this.recorder_elements,r=this.has_recording(),o.$buttons.disable(),i.removeClass("is-recording is-playing is-paused"),t){case u:return;case h:return o.$recordButton.enable(),void(r&&(o.$playButton.enable(),o.$resetButton.enable()));case _:case m:return t===m&&i.addClass("is-paused"),void(e===d?(i.addClass("is-playing"),o.$playButton.enable(),o.$stopButton.enable(),o.$resetButton.enable()):e===p&&(i.addClass("is-recording"),o.$recordButton.enable(),o.$stopButton.enable(),o.$resetButton.enable()))}throw new TypeError("Invalid toolbar state")},T.prototype.enable=function(){I()&&this.boot()},T.prototype.disable=function(){this.disable_transport_toolbar(),this.clear_visualization(),this.stop_user_media()},T.prototype.destroy=function(){this.disable(),this.element().off(this.EVENT_NAMESPACE)},T.is_recorder_available=function(){return"boolean"==typeof $&&$},T.is_audio_supported=I,n.Property_Input_Audio_Recorder=T}(jQuery,Charcoal.Admin,window,document),Charcoal.Admin.Property_Input_Audio_Widget=function(t){this.EVENT_NAMESPACE=Charcoal.Admin.Property_Input_Audio_Widget.EVENT_NAMESPACE,Charcoal.Admin.Property.call(this,t),this.data=t.data,this.data.id=t.id,this.init()},Charcoal.Admin.Property_Input_Audio_Widget.EVENT_NAMESPACE=".charcoal.property.audio.widget",Charcoal.Admin.Property_Input_Audio_Widget.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Audio_Widget.prototype.constructor=Charcoal.Admin.Property_Input_Audio_Widget,Charcoal.Admin.Property_Input_Audio_Widget.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Audio_Widget.prototype.init=function(){var t=this.element();this.text_component={enabled:!1,property:null,property_type:"charcoal/admin/property/input/textarea",property_class:null},this.capture_component={enabled:!1,property:null,property_type:"charcoal/admin/property/input/audio-recorder",property_class:Charcoal.Admin.Property_Input_Audio_Recorder},this.upload_component={enabled:!1,property:null,property_type:"charcoal/admin/property/input/audio",property_class:Charcoal.Admin.Property_Input_Audio},this.active_pane=this.data.active_pane||"text",this.$input_text=$("#"+this.data.text_input_id).or(".js-text-voice-message",t),this.$input_file=$("#"+this.data.upload_input_id).or(".js-file-input",t),this.$input_hidden=$("#"+this.data.hidden_input_id).or(".js-file-input-hidden",t),0===this.$input_hidden.length&&console.error("Missing hidden input to store audio"),this.bind_events(),this.active_pane&&(this.init_pane($("#"+this.data.id+"_"+this.active_pane+"_tab")),$("#"+this.data.id+"_"+this.active_pane+"_tab").tab("show"))},Charcoal.Admin.Property_Input_Audio_Widget.prototype.bind_events=function(){var e=this;return this.element().on("shown.bs.tab",'[data-toggle="tab"]',function(t){e.init_pane(t.target,!1)}),this},Charcoal.Admin.Property_Input_Audio_Widget.prototype.init_pane=function(t){return(t="string"!=typeof t?$(t).attr("data-pane"):t)&&(this.active_pane=t,"function"==typeof this[t="init_"+t]&&this[t]()),this},Charcoal.Admin.Property_Input_Audio_Widget.prototype.init_text=function(){var t=this.text_component;t.enabled||t.property||(t.enabled=!0,t.property_class&&(this.data.text_input_id?t.property=new t.property_class({id:this.data.text_input_id,type:t.property_type}):console.error("[Property_Input_Audio_Widget]","Missing text-to-speech input")))},Charcoal.Admin.Property_Input_Audio_Widget.prototype.init_upload=function(){var t=this.upload_component;t.enabled||t.property||(t.enabled=!0,t.property_class&&(this.data.upload_input_id&&this.data.hidden_input_id?t.property=new t.property_class({id:this.data.upload_input_id,type:t.property_type,data:{hidden_input_id:this.data.hidden_input_id,input_name:this.data.input_name,dialog_title:this.data.dialog_title,elfinder_url:this.data.elfinder_url}}):console.error("[Property_Input_Audio_Widget]","Missing file or hidden input")))},Charcoal.Admin.Property_Input_Audio_Widget.prototype.init_capture=function(){var t,e,i,o=this.capture_component;o.enabled||(o.property?o.property_class.is_audio_supported()&&(console.info("[Property_Input_Audio_Widget]","New request for user permission to use media input"),o.property.get_user_media(!0)):o.property_class&&(o.property_class.is_recorder_available()||this.data.recorder_plugin_url?this.data.hidden_input_id?(t=function(){o.enabled=!0}.bind(this),e=function(){o.enabled=!1}.bind(this),i=function(t){t.preventDefault(),"capture"===this.active_pane&&this.init_capture()}.bind(this),o.property=new o.property_class({id:this.data.capture_input_id,type:o.property_type,data:{recorder_plugin_url:this.data.recorder_plugin_url,hidden_input_id:this.data.hidden_input_id,on_stream_ready:t,on_stream_ended:e,on_stream_error:e}}),this.element().on("click."+this.EVENT_NAMESPACE,'[data-pane="capture"]',i)):console.error("[Property_Input_Audio_Widget]","Missing hidden input"):console.error("[Property_Input_Audio_Widget]","Missing recorder library")))},Charcoal.Admin.Property_Input_Audio_Widget.prototype.destroy=function(){this.element().off(this.EVENT_NAMESPACE),this.text_component.property&&this.text_component.property.destroy(),this.upload_component.property&&this.upload_component.property.destroy(),this.capture_component.property&&this.capture_component.property.destroy()},Charcoal.Admin.Property_Input_Audio=function(t){this.EVENT_NAMESPACE=Charcoal.Admin.Property_Input_Audio.EVENT_NAMESPACE,this.input_type="charcoal/admin/property/input/audio",Charcoal.Admin.Property.call(this,t),this.data=t.data,this.dialog=null,this.set_input_id(t.id).init()},Charcoal.Admin.Property_Input_Audio.EVENT_NAMESPACE=".charcoal.property.audio",Charcoal.Admin.Property_Input_Audio.prototype=Object.create(Charcoal.Admin.Property_Input_File.prototype),Charcoal.Admin.Property_Input_Audio.prototype.constructor=Charcoal.Admin.Property_Input_Audio,Charcoal.Admin.Property_Input_Audio.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Audio.prototype.change_file=function(t){var e,i;this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none"),this.$previewText.empty(),this.$previewFile.empty(),t.target&&t.target.files&&t.target.files[0]&&(e=t.target.files[0],(i=new FileReader).addEventListener("loadend",function(){var t=new Audio;console.log("[Property_Input_Audio.change_file]",e),t.innerHTML=audioPropertyL10n.unsupportedElement,t.style="max-width: 100%",t.controls=!0,t.title=e.name,t.src=i.result,t.load(),this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$previewFile.append(t),this.$previewText.html(e.name)}.bind(this),!1),i.readAsDataURL(e))},Charcoal.Admin.Property_Input_Audio.prototype.elfinder_callback=function(t){var e,i;this.dialog&&this.dialog.close(),this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none"),this.$previewText.empty(),this.$previewFile.empty(),t&&t.url&&(e=decodeURI(t.url).replace(Charcoal.Admin.base_url(),""),i=$('<audio controls src="'+t.url+'" class="js-file-audio" style="max-width: 100%">'+audioPropertyL10n.unsupportedElement+"</audio>"),console.log("[Property_Input_Audio.elfinder_callback]",t),this.$hidden.val(e),this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$previewText.html(t.name),this.$previewFile.append(i))},Charcoal.Admin.Property_Input_ColorPicker=function(t){this.input_type="charcoal/admin/property/input/colorpicker",Charcoal.Admin.Property.call(this,t),this.input_id=null,this.colorpicker_selector=null,this.colorpicker_options=null,this.set_properties(t).create_colorpicker()},Charcoal.Admin.Property_Input_ColorPicker.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_ColorPicker.prototype.constructor=Charcoal.Admin.Property_Input_ColorPicker,Charcoal.Admin.Property_Input_ColorPicker.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_ColorPicker.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.colorpicker_selector=t.data.colorpicker_selector||this.colorpicker_selector,this.colorpicker_options=t.data.colorpicker_options||this.colorpicker_options;return this.colorpicker_options=$.extend({},{},this.colorpicker_options),this},Charcoal.Admin.Property_Input_ColorPicker.prototype.create_colorpicker=function(){return $(this.colorpicker_selector).minicolors(this.colorpicker_options),this},Charcoal.Admin.Property_Input_DateTimePicker=function(t){this.input_type="charcoal/admin/property/input/datetimepicker",Charcoal.Admin.Property.call(this,t),this.input_id=null,this.datetimepicker_selector=null,this.datetimepicker_options=null,this.set_properties(t).create_datetimepicker()},Charcoal.Admin.Property_Input_DateTimePicker.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_DateTimePicker.prototype.constructor=Charcoal.Admin.Property_Input_DateTimePicker,Charcoal.Admin.Property_Input_DateTimePicker.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_DateTimePicker.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.datetimepicker_selector=t.data.datetimepicker_selector||this.datetimepicker_selector,this.datetimepicker_options=t.data.datetimepicker_options||this.datetimepicker_options;return this.datetimepicker_options=$.extend({},{},this.datetimepicker_options),this},Charcoal.Admin.Property_Input_DateTimePicker.prototype.create_datetimepicker=function(){return $(this.datetimepicker_selector).datetimepicker(this.datetimepicker_options),this},Charcoal.Admin.Property_Input_DualSelect=function(t){this.input_type="charcoal/admin/property/input/dualselect",Charcoal.Admin.Property.call(this,t),this.input_id=null,this.dualselect_selector=null,this.dualselect_options={},this._dualselect=null,this.set_properties(t).init()},Charcoal.Admin.Property_Input_DualSelect.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_DualSelect.prototype.constructor=Charcoal.Admin.Property_Input_DualSelect,Charcoal.Admin.Property_Input_DualSelect.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_DualSelect.prototype.init=function(){this.create_dualselect()},Charcoal.Admin.Property_Input_DualSelect.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.dualselect_selector=t.dualselect_selector||t.data.dualselect_selector||this.dualselect_selector,this.dualselect_options=t.dualselect_options||t.data.dualselect_options||this.dualselect_options;return t.data.dualselect_options.searchable&&(this.dualselect_options.search={left:this.dualselect_selector+"_searchLeft",right:this.dualselect_selector+"_searchRight"}),this.dualselect_options=$.extend({},{keepRenderingSort:!1},this.dualselect_options),this},Charcoal.Admin.Property_Input_DualSelect.prototype.create_dualselect=function(){return $(this.dualselect_selector).multiselect(this.dualselect_options),this},Charcoal.Admin.Property_Input_DualSelect.prototype.set_dualselect=function(t){return this._dualselect=t,this},Charcoal.Admin.Property_Input_DualSelect.prototype.dualselect=function(){return this._dualselect},Charcoal.Admin.Property_Input_DualSelect.prototype.destroy=function(){var t=this.dualselect();t&&t.remove()},Charcoal.Admin.Property_Input_Geometry_Widget=function(t){t.input_type="charcoal/admin/property/input/geometry-widget",Charcoal.Admin.Property.call(this,t);var e=this;this._controller=void 0,this._object_inc=0,this._startGeometry=!1,this._map_options=t.data.map_options,this._map_options.multiple=!1;var i={GOOGLE_MAP_LOADED:"google-map-loaded"+Charcoal.Admin.Property_Input_Geometry_Widget.EVENT_NAMESPACE};"undefined"==typeof google&&(!0!==window._geolocation_tmp_google&&(window._geolocation_tmp_google=!0,$.getScript("https://maps.googleapis.com/maps/api/js?sensor=false&callback=_geolocation_tmp_google_onload_function&key="+this._map_options.api_key,function(){}),window._geolocation_tmp_google_onload_function=function(){document.dispatchEvent(new Event(i.GOOGLE_MAP_LOADED))}),document.addEventListener(i.GOOGLE_MAP_LOADED,function(){e.init()},{once:!0}))},Charcoal.Admin.Property_Input_Geometry_Widget.EVENT_NAMESPACE=".geolocation",Charcoal.Admin.Property_Input_Geometry_Widget.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Geometry_Widget.prototype.constructor=Charcoal.Admin.Property_Input_Geometry_Widget,Charcoal.Admin.Property_Input_Geometry_Widget.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Geometry_Widget.prototype.init=function(){if(void 0!==window._tmp_google_onload_function&&delete window._tmp_google_onload_function,"undefined"==typeof BB||"undefined"==typeof google)return console.error("Plugins not loaded"),!1;void 0===this.opts().id&&console.error("Missing ID");var t=this.default_styles(),e=this.default_map_options(),e=$.extend(!0,e,this._map_options),i=this.element().find("input[type=hidden]").val();if(i){var o,r={object1:{ident:"object1",paths:this.reverse_translate_coords(i),editable:!0,draggable:!0,type:e.geometry_type,styles:t}},n={},a=0;for(o in r)a++,n[o]=r[o],n[o].styles=$.extend(r[o].styles,t);n&&(e.places=n),a&&(this._object_inc=a)}this.$map_maker=this.element().find(".js-map-maker"),this._controller=new window.BB.gmap.controller(this.element().find(".js-map-maker-map").get(0),e),this.controller().init().ready(function(t){t.fit_bounds(),t.remove_focus()}),this.controller().set_styles([{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]}]),this.controller().remove_focus(),this.link_related_property();for(var s=this,l=e.geometry_type,c=(s.hide_marker_toolbar(),"object"+s.object_index());s.controller().get_place(c);)c="object"+s.object_index();this.element().on("click",function(){var t=s.controller().export();if(t&&0!==Object.keys(t.places).length)return!1;if(!s._startGeometry)switch(s._startGeometry=!0,l){case"marker":case"line":case"polygon":s.controller().create_new(l,c)}}),this.element().on("click",".js-reset",function(t){s._startGeometry=!1,t.preventDefault(),s.controller().reset()})},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.link_related_property=function(){var t,e=this.opts().data.related_property;if(!e)return!1;for(t in e)"charcoal/admin/object/geometry-blueprint"===e[t].obj_type&&this.related_object_geometry(t)},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.related_object_geometry=function(t){var e=this.opts().data.related_property[t].obj_type;if(!e)return!1;var r=[],n=!1,a=this;$.ajax({url:Charcoal.Admin.admin_url()+"object/load",data:{obj_type:e},type:"GET",error:function(){},success:function(t){n=!0,r=t.collection}}),this.element().parents("fieldset").on("change",'[name="'+t+'"]',function(t){if(!n)return!1;for(var e in a.controller().reset(),r){var i,o;r[e].id===$(t.currentTarget).val()&&(e=r[e].geometry,i=a.default_styles(),o=a.default_map_options(),o=$.extend(!0,o,a._map_options),e={paths:a.reverse_translate_coords(e),editable:!0,draggable:!0,type:o.geometry_type,styles:i},a.controller().add_place("object1",e),a.controller().fit_bounds())}})},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.controller=function(){return this._controller},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.object_index=function(){return++this._object_inc},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.default_styles=function(){return{strokeColor:"#000000",strokeOpacity:.8,strokeWeight:3,fillColor:"#ffffff",fillOpacity:.35,hover:{strokeColor:"#000000",strokeOpacity:1,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.5},focused:{fillOpacity:.8}}},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.default_map_options=function(){return{default_styles:this.default_styles(),use_clusterer:!1,map:{center:{x:45.3712923,y:-73.9820994},zoom:14,mapType:"roadmap",coordsType:"inpage",map_mode:"default"}}},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.display_marker_toolbar=function(){this.$map_maker.addClass("is-header-open")},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.hide_marker_toolbar=function(){this.$map_maker.removeClass("is-header-open")},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.translate_coords=function(t){for(var e=0,i=t.length,o=[];e<i;e++)o.push(t[e].join(" "));return i&&o.push(t[0].join(" ")),o.join(",")},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.reverse_translate_coords=function(t){for(var e=t.split(","),i=0,o=e.length;i<o;i++)e[i]=e[i].split(" ");return e.pop(),e},Charcoal.Admin.Property_Input_Geometry_Widget.prototype.save=function(){if(!this.controller())return this;var t=this.controller().export(),t="object"==typeof t.places?t.places:{},t=Object.keys(t).length?this.translate_coords(t[Object.keys(t)[0]].paths):"";return this.element().find("input[type=hidden]").val(JSON.stringify(t)),!0},Charcoal.Admin.Property_Input_Image=function(t){this.EVENT_NAMESPACE=Charcoal.Admin.Property_Input_Image.EVENT_NAMESPACE,this.input_type="charcoal/admin/property/input/image",Charcoal.Admin.Property.call(this,t),this.data=t.data,this.dialog=null,this.set_input_id(t.id).init()},Charcoal.Admin.Property_Input_Image.EVENT_NAMESPACE=".charcoal.property.image",Charcoal.Admin.Property_Input_Image.prototype=Object.create(Charcoal.Admin.Property_Input_File.prototype),Charcoal.Admin.Property_Input_Image.prototype.constructor=Charcoal.Admin.Property_Input_Image,Charcoal.Admin.Property_Input_Image.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Image.prototype.change_file=function(t){var e,i;this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none"),this.$previewText.empty(),this.$previewFile.empty(),t.target&&t.target.files&&t.target.files[0]&&(e=t.target.files[0],(i=new FileReader).addEventListener("loadend",function(){var t=new Image;console.log("[Property_Input_Image.change_file]",e),t.style="max-width: 100%",t.title=e.name,t.src=i.result,t.load(),this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$previewFile.append(t),this.$previewText.html(e.name)}.bind(this),!1),i.readAsDataURL(e))},Charcoal.Admin.Property_Input_Image.prototype.elfinder_callback=function(t){var e,i;this.dialog&&this.dialog.close(),this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none"),this.$previewText.empty(),this.$previewFile.empty(),t&&t.url&&(e=decodeURI(t.url).replace(Charcoal.Admin.base_url(),""),i=$('<img src="'+t.url+'" style="max-width: 100%">'),console.log("[Property_Input_Image.elfinder_callback]",t),this.$hidden.val(e),this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$previewText.html(t.name),this.$previewFile.append(i))},Charcoal.Admin.Property_Input_Map_Widget=function(t){t.input_type="charcoal/admin/property/input/map-widget",Charcoal.Admin.Property.call(this,t);var e=this;this._controller=void 0,this._object_inc=0,"undefined"==typeof google?(window._tmp_google_onload_function=function(){e.init()},$.getScript("https://maps.googleapis.com/maps/api/js?sensor=false&callback=_tmp_google_onload_function&key="+t.data.api_key,function(){})):e.init()},Charcoal.Admin.Property_Input_Map_Widget.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Map_Widget.prototype.constructor=Charcoal.Admin.Property_Input_Map_Widget,Charcoal.Admin.Property_Input_Map_Widget.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Map_Widget.prototype.init=function(){if(void 0!==window._tmp_google_onload_function&&delete window._tmp_google_onload_function,"undefined"==typeof BB||"undefined"==typeof google)return console.error("Plugins not loaded"),!1;var t=this.opts(),e=(void 0===t.id&&console.error("Missing ID"),{strokeColor:"#000000",strokeOpacity:.8,strokeWeight:3,fillColor:"#ffffff",fillOpacity:.35,hover:{strokeColor:"#000000",strokeOpacity:1,strokeWeight:2,fillColor:"#ffffff",fillOpacity:.5},focused:{fillOpacity:.8}}),i={default_styles:e,use_clusterer:!1,map:{center:{x:45.3712923,y:-73.9820994},zoom:14,mapType:"roadmap",coordsType:"inpage",map_mode:"default"}},i=$.extend(!0,i,t.data),t=this.element().find("input[type=hidden]").val();if(t){var o,r=JSON.parse(t),n={},a=0;for(o in r)a++,n[o]=r[o],n[o].styles=$.extend(r[o].styles,e);n&&(i.places=n),a&&(this._object_inc=a)}this.$map_maker=this.element().find(".js-map-maker"),this._controller=new window.BB.gmap.controller(this.element().find(".js-map-maker-map").get(0),i),this.controller().init().ready(function(t){t.fit_bounds(),t.remove_focus()}),this.controller().set_styles([{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]}]),this.controller().remove_focus();var s=this,l="object";this.element().on("change",'[name="'+this.opts("controls_name")+'"]',function(t){var e=$(t.currentTarget).val();switch(e){case"display_marker_toolbar":s.display_marker_toolbar();break;case"add_line":case"add_polygon":s.hide_marker_toolbar();for(var i=l+s.object_index();s.controller().get_place(i);)i=l+s.object_index();s.controller().create_new(e.replace("add_",""),i)}}),this.element().on("click",".js-add-marker",function(t){t.preventDefault();for(var e=l+s.object_index();s.controller().get_place(e);)e=l+s.object_index();s.controller().create_new("marker",e)}),this.element().on("click",".js-add_place_by_address",function(t){t.preventDefault();t=s.element().find(".js-address").text();if(!t)return!1;s.controller().add_place_by_address("object"+s.object_index(),t,{type:"marker",draggable:!0,editable:!0,loaded_callback:function(t){s.controller().map().setCenter(t.object().getPosition())}})}),this.element().on("click",".js-reset",function(t){t.preventDefault(),s.controller().reset()})},Charcoal.Admin.Property_Input_Map_Widget.prototype.controller=function(){return this._controller},Charcoal.Admin.Property_Input_Map_Widget.prototype.object_index=function(){return++this._object_inc},Charcoal.Admin.Property_Input_Map_Widget.prototype.display_marker_toolbar=function(){this.$map_maker.addClass("is-header-open")},Charcoal.Admin.Property_Input_Map_Widget.prototype.hide_marker_toolbar=function(){this.$map_maker.removeClass("is-header-open")},Charcoal.Admin.Property_Input_Map_Widget.prototype.save=function(){var t=this.controller().export(),t="object"==typeof t.places?t.places:{};return this.element().find("input[type=hidden]").val(JSON.stringify(t)),!0},Charcoal.Admin.Property_Input_Range=function(t){this.EVENT_NAMESPACE=Charcoal.Admin.Property_Input_Range.EVENT_NAMESPACE,Charcoal.Admin.Property.call(this,t),this.input_type="charcoal/admin/property/input/range",this.data=t.data,this.data.id=t.id,this.$output=null,this.$input=null,this.init()},Charcoal.Admin.Property_Input_Range.EVENT_NAMESPACE=".charcoal.property.range",Charcoal.Admin.Property_Input_Range.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Range.prototype.constructor=Charcoal.Admin.Property_Input_Range,Charcoal.Admin.Property_Input_Range.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Range.prototype.init=function(){if(!0===this.data.show_range_value&&"string"==typeof this.data.range_value_location){var t,e=this.id(),i=this.data.range_value_location;switch(i){case"prefix":this.$output=$("#"+e+"_prefix_text");break;case"suffix":this.$output=$("#"+e+"_suffix_text");break;default:"#"===i[0]||"."===i[0]?this.$output=$(i):this.$output=$("#"+e+"_"+i)}this.$output.addClass("js-show-range-value"),this.$input=$("#"+e),this.$input.exists()&&this.$output.exists()&&(this.on_change(this.$input,this.$output),t="oninput"in this.$input[0]?"input":"change",this.$input.on(t+this.EVENT_NAMESPACE,this.on_change.bind(this,this.$input,this.$output)))}},Charcoal.Admin.Property_Input_Range.prototype.on_change=function(t,e){e.text(e.text().replace(/[\d\.]+/,t.val()))},Charcoal.Admin.Property_Input_Range.prototype.destroy=function(){this.element().off(this.EVENT_NAMESPACE),this.$input&&this.$input.off(this.EVENT_NAMESPACE)},Charcoal.Admin.Property_Input_SelectPicker=function(t){Charcoal.Admin.Property.call(this,t),this.input_type="charcoal/admin/property/input/select",this.input_id=null,this.select_selector=null,this.select_options=null,this.set_properties(t).create_select()},Charcoal.Admin.Property_Input_SelectPicker.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_SelectPicker.prototype.constructor=Charcoal.Admin.Property_Input_SelectPicker,Charcoal.Admin.Property_Input_SelectPicker.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_SelectPicker.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.select_selector=t.data.select_selector||this.select_selector,this.select_options=t.data.select_options||this.select_options;return this.select_options=$.extend({},{},this.select_options),this},Charcoal.Admin.Property_Input_SelectPicker.prototype.create_select=function(){return $(this.select_selector).selectpicker(this.select_options),this},function(){function t(t){Charcoal.Admin.Property.call(this,t),this.input_type="charcoal/admin/property/input/selectize",this.input_id=null,this.obj_type=null,this.remote_source=null,this.copy_items=!1,this.title=null,this.translations=null,this.pattern=null,this.multiple=!1,this.separator=",",this.selectize=null,this.selectize_selector=null,this.form_data={},this.form_ident=null,this.selectize_options={},this.choice_obj_map={},this.selectize_property_ident=null,this.selectize_property=null,this.selectize_obj_type=null,this.selectize_templates={},this.clipboard=null,this.allow_update=null,this.set_properties(t).init(),this.selectize_init()}t.prototype=Object.create(Charcoal.Admin.Property.prototype),t.constructor=Charcoal.Admin.Property_Input_Selectize,t.parent=Charcoal.Admin.Property.prototype,t.prototype.init=function(){},t.prototype.selectize_init=function(){this.init_selectize(),this.init_clipboard(),this.init_allow_update(),this.init_allow_create();var e=this;this.selectize.on("update_item",function(t){e.create_item(null,t.callback,{id:t.value,step:0})})},t.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.obj_type=t.data.obj_type||this.obj_type,this.remote_source=t.data.remote_source||this.remote_source,this.copy_items=t.data.copy_items||this.copy_items,this.allow_update=t.data.allow_update||this.allow_update,this.allow_create=t.data.allow_create||this.allow_create,this.title=t.data.title||this.title,this.translations=t.data.translations||this.translations,this.pattern=t.data.pattern||this.pattern,this.multiple=t.data.multiple||this.multiple,this.separator=t.data.multiple_separator||this.multiple_separator||",",this.form_data=t.data.form_data||this.form_data,this.form_ident=t.data.form_ident||this.form_ident,this.selectize_selector=t.data.selectize_selector||this.selectize_selector,this.selectize_options=t.data.selectize_options||this.selectize_options,this.choice_obj_map=t.data.choice_obj_map||this.choice_obj_map,this.selectize_property_ident=t.data.selectize_property_ident||this.selectize_property_ident,this.selectize_property=t.data.selectize_property||this.selectize_property,this.selectize_obj_type=t.data.selectize_obj_type||this.selectize_obj_type,this.selectize_templates=t.data.selectize_templates||this.selectize_templates,this.$input=$(this.selectize_selector||"#"+this.input_id),t=this.multiple?{drag_drop:{},charcoal_item:{}}:{charcoal_item:{}};var e=this.obj_type,i=this.remote_source,o={plugins:t,formData:{},delimiter:this.separator,persist:!0,preload:"focus",openOnFocus:!0,labelField:"label",searchField:["value","label"],dropdownParent:this.$input.closest(".form-field"),render:{},onItemRemove:function(t){this.refreshOption(t)},createFilter:function(t){for(var e in this.options)if((e=this.options[e]).label===t)return!1;return!0},onInitialize:function(){var e=this;e.sifter.iterator(this.items,function(t){e.refreshItem(t,e.getItem(t))}),e.sifter.iterator(this.options,function(t){e.refreshOption(t.value)})}};if(this.selectize_templates.item&&(o.render.item=function(t,e){return t.item_render?'<div class="item">'+t.item_render+"</div>":'<div class="item">'+e(t[o.labelField])+"</div>"}),this.selectize_templates.option&&(o.render.option=function(t,e){return t.option_render?'<div class="option">'+t.option_render+"</div>":'<div class="option">'+e(t[o.labelField])+"</div>"}),i?(o.create=function(t){return{value:t,label:t}},o.load=this.load_from_remote.bind(this)):e?(o.create=this.create_item.bind(this),o.load=this.load_items.bind(this)):(o.plugins.create_on_enter={},o.create=function(t){return{value:t,label:t}}),this.selectize_options.splitOn){var r=this.selectize_options.splitOn;if("array"===$.type(r)){for(var n=r.length-1;0<=n;n--)switch(r[n]){case"comma":r[n]="\\s*,\\s*";break;case"tab":r[n]="\\t+";break;default:r[n]=r[n].replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}r=r.join("|")}this.selectize_options.splitOn=new RegExp(r)}return this.selectize_options=$.extend(!0,{},o,this.selectize_options),this},t.prototype.create_item=function(i,o,t){var r=this.form_data||{},n=this,e=this.obj_type,a=this.title,s=this.translations,l=this.selectize_options,c=(t=t||{}).step||0,d=this.form_ident,p=null,h=t.id||null,u=this.selectize_property,_=this.selectize_property_ident,m=this.selectize_obj_type,t=(d&&"object"==typeof d&&(!h&&d.create?(d=d.create,a+=" - "+s.statusTemplate.replaceMap({"[[ current ]]":1,"[[ total ]]":2}),c=1,p="Next"):h&&d.update?(d=d.update,2===c&&(a+=" - "+s.statusTemplate.replaceMap({"[[ current ]]":2,"[[ total ]]":2}),p="Finish")):d=null),$.isEmptyObject(l.formData)?(i&&(r[this.choice_obj_map.label]=i),r.form_ident=d,r.submit_label=p):i&&(r=$.extend({},l.formData),$.each(r,function(t,e){":input"===e&&(r[t]=i)})),{title:a,size:BootstrapDialog.SIZE_WIDE,cssClass:"-quick-form",dialog_options:{onhide:function(){void 0!==n.widget_id&&Charcoal.Admin.manager().destroy_component("widgets",n.widget_id),o({return:!1})}},widget_type:"charcoal/admin/widget/quick-form",with_data:!0,widget_options:{obj_type:e,obj_id:h,form_data:r}}),f=(0<c&&(t.type=BootstrapDialog.TYPE_PRIMARY),this.dialog(t,function(t){if(t.success){if(!t.widget_id)return!1;n.widget_id=t.widget_id,Charcoal.Admin.manager().add_widget({id:t.widget_id,type:"charcoal/admin/widget/quick-form",data:t.widget_data,obj_id:h,extra_form_data:{selectize_obj_type:m,selectize_prop_ident:_,selectize_property:u},save_action:"selectize/save",update_action:"selectize/update",suppress_feedback:1===c,save_callback:function(t){var e={class:"new"},t=t.selectize[0];t&&$.extend(!0,e,t),o(e),f.close(),1===c&&n.create_item(i,o,{id:t.value,step:2})}}),Charcoal.Admin.manager().render()}}))},t.prototype.load_from_remote=function(t,e){if(!t.length)return e();var i=this,o={selectize_obj_type:this.selectize_obj_type,selectize_prop_ident:this.selectize_property_ident,selectize_property:this.selectize_property};$.ajax({url:this.remote_source+encodeURIComponent(t),type:"GET",data:o,error:function(){e()},success:function(t){null!==t.optgroups&&$.each(t.optgroups,function(t,e){i.selectize.registerOptionGroup(e)}),null!==t.options?e(t.options):e(t)}})},t.prototype.load_items=function(t,r){if(!t.length&&!1===this.selectize_options.preload)return r();var e=this.obj_type,i=this.selectize_property_ident,e={obj_type:e,selectize_obj_type:this.selectize_obj_type,selectize_prop_ident:i,selectize_property:this.selectize_property},i=Charcoal.Admin.admin_url()+"selectize/load";t&&(i+="/"+encodeURIComponent(t)),$.ajax({url:i,data:e,type:"GET",error:function(){r()},success:function(t){var e,i=[],o=t.selectize;for(e in o)o.hasOwnProperty(e)&&(e=o[e],i.push(e));r(i)}})},t.prototype.dialog=Charcoal.Admin.Widget.prototype.dialog,t.prototype.init_selectize=function(){var t=this.$input.selectize(this.selectize_options);this.selectize=t[0].selectize},t.prototype.init_allow_create=function(){var e,t,i;this.allow_create&&(e=this.selectize,t=$(this.selectize_selector+"_create"),i=this,t.on("click",function(){i.create_item(null,function(t){t&&t.value&&(e.addOption(t),e.addItem(t.value))})}))},t.prototype.init_allow_update=function(){switch(this.selectize.settings.mode){case"single":this.allow_update_single();break;case"multiple":this.allow_update_multiple()}},t.prototype.allow_update_single=function(){var e,t,i;this.allow_update&&(e=this.selectize,t=$(this.selectize_selector+"_update"),i=this,t.on("click",function(){var t=e.items;t&&i.create_item(null,function(t){t&&t.value&&(e.updateOption(t.value,t),e.refreshOption(t.value),e.refreshItem(t.value,e.getItem(t.value)))},{id:t[0],step:0})}))},t.prototype.allow_update_multiple=function(){var e,i,o,t;this.allow_update&&(e=this.selectize,i=$(this.selectize_selector+"_update"),o=null,t=this,i[0].disabled=!0,i.on("click",function(){o&&t.create_item(null,function(t){t&&t.value&&(e.updateOption(o,t),e.refreshOption(o),e.refreshItem(o,e.getItem(t)))},{id:o,step:0})}),e.on("blur",function(){setTimeout(function(){i[0].disabled=!0},500)}),e.$control.on("mousedown","*:not(input)",function(t){o=$(t.target).eq(0).data("value"),e.$control.find(".active:not(input)")&&(i[0].disabled=!1)}))},t.prototype.init_clipboard=function(){var t;this.copy_items&&(t=this.selectize,this.clipboard=new ClipboardJS(this.selectize_selector+"_copy",{text:function(){return t.$input.val()}}))},Charcoal.Admin.Property_Input_Selectize=t}((jQuery,document)),Selectize.define("btn_remove",function(t){t=$.extend({label:'<span class="fa fa-trash-o"></span>',title:"Remove",className:"selectize-button-remove",append:!0},t),this.require("buttons");var e,i;"single"!==this.settings.mode&&(t=t,(i=e=this).addButton(e,t,function(t){t.preventDefault(),i.isLocked||(t=$(t.currentTarget).parent(),i.setActiveItem(t),i.deleteSelection()&&i.setCaret(i.items.length))}))}),Selectize.define("btn_update",function(t){t=$.extend({label:'<span class="fa fa-pencil"></span>',title:"Update",className:"selectize-button-update",append:!0},t),this.require("buttons");var e,i;"single"!==this.settings.mode&&(t=t,(i=e=this).addButton(e,t,function(t){t.preventDefault(),i.isLocked||(t=$(t.currentTarget).parent(),i.setActiveItem(t),i.trigger("update_item",{item:t,value:t.eq(0).data("value"),callback:function(t){t&&t.value&&(i.updateOption(t.value,t),i.refreshOption(t.value,t),i.refreshItem(t.value,i.getItem(t.value)))}}))}))}),Selectize.define("buttons",function(){this.buttonOffset=40,this.currentButtonOffset=0,this.addButton=function(r,t,e){var i,n=r,a='<button type="button" class="selectize-button '+t.className+'" tabindex="-1" title="'+(t.title+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")+'" style="right:'+n.currentButtonOffset+'px">'+t.label+"</a>";n.currentButtonOffset+=n.buttonOffset;r.setup=(i=n.setup,function(){var o;t.append&&(o=n.settings.render.item,n.settings.render.item=function(){return t=o.apply(r,arguments),e=n.currentButtonOffset,i=$(t),e=i.hasClass("item")?(i.css("padding-right",e+8+"px"),i[0]):t,i=a,(t=$(e)).hasClass("item")?(t.append($(i)),t[0]):e;var t,e,i}),i.apply(r,arguments),r.$control.on("mousedown","."+t.className,function(t){t.preventDefault(),n.$control.data("ui-sortable")&&(n.$control.sortable("disable"),$(document).on("mouseup.sortable",function(){$(document).off("mouseup.sortable"),n.$control.sortable("enable")}))}),r.$control.on("click","."+t.className,function(t){"function"==typeof e&&e(t)})})}}),Selectize.define("create_on_blur",function(){var t,e;"multi"===this.settings.mode&&((t=this).onBlur=(e=t.onBlur,function(){return""!==this.$control_input.val().trim()&&t.createItem(this.$control_input.val()),e.apply(this,arguments)}))}),Selectize.define("create_on_enter",function(){var e,i;"multi"===this.settings.mode&&((e=this).onKeyUp=(i=e.onKeyUp,function(t){return 13===t.keyCode&&""!==this.$control_input.val().trim()&&e.createItem(this.$control_input.val()),i.apply(this,arguments)}))}),Selectize.define("charcoal_item",function(o){o=$.extend({classField:"class",colorField:"color"},o);var r=this,n=null;this.refreshItem=function(t,e){var i=r.options[t];if(i.hasOwnProperty(o.colorField)&&i[o.colorField]&&(e.addClass("has-color"),e.css("border-left-color",i[o.colorField])),i.hasOwnProperty(o.classField)&&e.addClass(i[o.classField]),n)return n.apply(this,arguments)},this.refreshOption=function(t){var e=r.options[t],i=(r.refreshOptions(!1),r.getElementWithValue(t,r.$dropdown_content.find(".option")));if(e.hasOwnProperty(o.colorField)&&e[o.colorField]&&(i.addClass("has-color"),i.css("border-left-color",e[o.colorField])),n)return n.apply(this,arguments)},this.settings.onOptionAdd=(n=null,r.settings.hasOwnProperty("onOptionAdd")&&(n=r.settings.onOptionAdd),r.refreshOption),this.settings.onItemAdd=(n=null,r.settings.hasOwnProperty("onItemAdd")&&(n=r.settings.onItemAdd),r.refreshItem)}),function(){function t(t){this.input_type="charcoal/admin/property/input/selectize/list",this.input_id=null,this.obj_type=null,this.copy_items=!1,this.title=null,this.translations=null,this.pattern=null,this.multiple=!1,this.separator=",",this.selectize=null,this.selectize_selector=null,this.form_ident=null,this.selectize_options={},this.clipboard=null,this.allow_update=!1,this.set_properties(t).init()}t.prototype=Object.create(Charcoal.Admin.Property_Input_Selectize.prototype),t.constructor=Charcoal.Admin.Property_Input_Selectize,t.parent=Charcoal.Admin.Property_Input_Selectize.prototype,t.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.obj_type=t.data.obj_type||this.obj_type,this.copy_items=t.data.copy_items||this.copy_items,this.allow_update=t.data.allow_update||this.allow_update,this.title=t.data.title||this.title,this.translations=t.data.translations||this.translations,this.pattern=t.data.pattern||this.pattern,this.multiple=t.data.multiple||this.multiple,this.separator=t.data.multiple_separator||this.multiple_separator||",",this.form_ident=t.data.form_ident||this.form_ident,this.selectize_selector=t.data.selectize_selector||this.selectize_selector,this.selectize_options=t.data.selectize_options||this.selectize_options,this.$input=$(this.selectize_selector||"#"+this.input_id),t=this.multiple?{drag_drop:{},charcoal_item:{}}:{charcoal_item:{}};var e=this.obj_type,t={plugins:t,formData:{},delimiter:this.separator,persist:!0,preload:"focus",openOnFocus:!0,searchField:["value","label"],dropdownParent:this.$input.closest(".form-field"),createFilter:function(t){for(var e in this.options)if((e=this.options[e]).label===t)return!1;return!0},onInitialize:function(){var i=this;i.sifter.iterator(this.items,function(t){var e=i.options[t],t=i.getItem(t);e.color&&t.css("background-color",e.color)})}};if(e?(t.create=this.create_item.bind(this),t.load=this.load_items.bind(this)):(t.plugins.create_on_enter={},t.create=function(t){return{value:t,label:t}}),this.selectize_options.splitOn){var i=this.selectize_options.splitOn;if("array"===$.type(i)){for(var o=i.length-1;0<=o;o--)switch(i[o]){case"comma":i[o]="\\s*,\\s*";break;case"tab":i[o]="\\t+";break;default:i[o]=i[o].replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}i=i.join("|")}this.selectize_options.splitOn=new RegExp(i)}return this.selectize_options=$.extend(!0,{},t,this.selectize_options),this},Charcoal.Admin.Property_Input_Selectize_List=t}((jQuery,document)),Charcoal.Admin.Property_Input_Selectize_Tags=function(t){this.input_type="charcoal/admin/property/input/selectize/tags",this.input_id=null,this.obj_type=null,this.copy_items=!1,this.title=null,this.multiple=!1,this.separator=",",this._tags=null,this.selectize=null,this.selectize_selector=null,this.selectize_options={},this.clipboard=null,this.set_properties(t).init()},Charcoal.Admin.Property_Input_Selectize_Tags.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Selectize_Tags.prototype.constructor=Charcoal.Admin.Property_Input_Selectize_Tags,Charcoal.Admin.Property_Input_Selectize_Tags.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Selectize_Tags.prototype.init=function(){if("function"!=typeof $.fn.sortable)return Charcoal.Admin.loadScript("https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js",this.init.bind(this)),this;this.init_selectize(),this.init_clipboard()},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.set_properties=function(t){this.input_id=t.id||this.input_id,this.obj_type=t.data.obj_type||this.obj_type,this.copy_items=t.data.copy_items||this.copy_items,this.title=t.data.title||this.title,this.multiple=t.data.multiple||this.multiple,this.separator=t.data.multiple_separator||this.multiple_separator||",",this.selectize_selector=t.data.selectize_selector||this.selectize_selector,this.selectize_options=t.data.selectize_options||this.selectize_options,this.$input=$(this.selectize_selector||"#"+this.input_id),t=this.multiple?["remove_button","drag_drop","charcoal_item"]:["charcoal_item"];var e=this.obj_type,t={plugins:t,formData:{},delimiter:this.separator,persist:!1,preload:!0,openOnFocus:!0,dropdownParent:this.$input.closest(".form-field"),createFilter:function(t){for(var e in this.options)if((e=this.options[e]).text===t)return!1;return!0},onInitialize:function(){var i=this;i.sifter.iterator(this.items,function(t){var e=i.options[t],t=i.getItem(t);e.color&&t.css("background-color",e.color)})}};if(e?(t.create=this.create_tag.bind(this),t.load=this.load_tags.bind(this)):(t.plugins.push("create_on_enter"),t.create=function(t){return{value:t,text:t}}),this.selectize_options=$.extend({},t,this.selectize_options),this.selectize_options.splitOn){var i=this.selectize_options.splitOn;if("array"===$.type(i)){for(var o=i.length-1;0<=o;o--)switch(i[o]){case"comma":i[o]="\\s*,\\s*";break;case"tab":i[o]="\\t+";break;default:i[o]=i[o].replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}i=i.join("|")}this.selectize_options.splitOn=new RegExp(i)}return this},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.create_tag=function(i,o){var e=this.obj_type,r=this.id,t=this.title,n=this.selectize_options,a={},n=($.isEmptyObject(n.formData)?a={name:i}:(a=$.extend({},n.formData),$.each(a,function(t,e){":input"===e&&(a[t]=i)})),{title:t,size:BootstrapDialog.SIZE_WIDE,cssClass:"-quick-form",dialog_options:{onhide:function(){o({return:!1})}},widget_type:"charcoal/admin/widget/quick-form",widget_options:{obj_type:e,obj_id:r,form_data:a}}),s=this.dialog(n,function(t){if(t.success){if(!t.widget_id)return!1;Charcoal.Admin.manager().add_widget({id:t.widget_id,type:"charcoal/admin/widget/quick-form",data:{obj_type:e},obj_id:r,save_callback:function(t){var e=t.obj.id;"name"in t.obj&&t.obj.name&&(e=t.obj.name[Charcoal.Admin.lang()]||t.obj.name),o({value:t.obj.id,text:e,color:t.obj.color,class:"new"}),s.close()}})}})},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.load_tags=function(t,r){var e=this.obj_type;if(!t.length)return r();$.ajax({url:Charcoal.Admin.admin_url()+"object/load",data:{obj_type:e},type:"GET",error:function(){r()},success:function(t){var e=[];for(i in t.collection){var i,o=(i=t.collection[i]).id;"name"in i&&i.name&&(o=i.name[Charcoal.Admin.lang()]||i.name),e.push({value:i.id,text:o,color:i.color})}r(e)}})},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.dialog=Charcoal.Admin.Widget.prototype.dialog,Charcoal.Admin.Property_Input_Selectize_Tags.prototype.onKeyDown=function(t){var e=this,i=!1,o=/Mac/.test(navigator.userAgent);if(e.isLocked&&9!==t.keyCode&&t.preventDefault(),"undefined"===$.type(e.isCmdDown)&&(i=!0,e.isCmdDown=t[o?"metaKey":"ctrlKey"]),e.isCmdDown&&67===t.keyCode){if(i&&(e.isCmdDown=void 0),e.$activeItems.length)for(var r=[],n=0,a=e.$activeItems.length;n<a;n++)r.push($(e.$activeItems[n]).attr("data-value")),document.execCommand("copy")}else!e.isFull()&&!e.isInputHidden||(o?t.metaKey:t.ctrlKey)||t.preventDefault()},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.init_selectize=function(){var t=this.$input.selectize(this.selectize_options);this.selectize=t[0].selectize},Charcoal.Admin.Property_Input_Selectize_Tags.prototype.init_clipboard=function(){var t;this.copy_items&&(t=this.selectize,this.clipboard=new ClipboardJS(this.selectize_selector+"_copy",{text:function(){return t.$input.val()}}))},Charcoal.Admin.Property_Input_Text=function(t){return Charcoal.Admin.Property.call(this,t),this.input_type="charcoal/admin/property/input/text",this.data=t.data,this.set_input_id(t.id),this.set_data(this.data),this.multiple_initialized=!1,this.initialisation=!0,this.init(),this.initialisation=!1,this},Charcoal.Admin.Property_Input_Text.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Text.prototype.constructor=Charcoal.Admin.Property_Input_Text,Charcoal.Admin.Property_Input_Text.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Text.prototype.set_data=function(t){this.set_input_name(t.input_name),this.set_input_val(t.input_val),this.set_readonly(t.readonly),this.set_required(t.required),this.set_min_length(t.min_length),this.set_max_length(t.max_length),this.set_size(t.size),this.set_multiple(t.multiple),this.set_multiple_separator(t.multiple_separator);var e=t.multiple_options?t.multiple_options.min:0,i=t.multiple_options?t.multiple_options.max:0,e=(this.set_multiple_min(e),this.set_multiple_max(i),t.multiple_options?t.multiple_options.split_on:null);return this.set_split_on(e),this},Charcoal.Admin.Property_Input_Text.prototype.init=function(){if(!this.input_id)return this;this.$input=$("#"+this.input_id),this.multiple&&!this.multiple_initialized&&this.init_multiple()},Charcoal.Admin.Property_Input_Text.prototype.init_multiple=function(){if(this.multiple_initialized=!0,this.chars_new=[13],this.chars_remove=[8,46],this.char_next=[40],this.char_prev=[38],this.currentValAmount=1,this.$container=this.$input.parent("div"),this.bind_keyboard_events(this.$input),this.split_val(this.$input),this.multiple_min)for(var t=this.multiple_min-this.currentValAmount;0<t;t--)this.add_item();return this},Charcoal.Admin.Property_Input_Text.prototype.split_val=function(t){var e,i=this.split_on||this.multiple_separator,o=(t=t||this.$input).val().split(i),r=0,n=o.length;if(1===n)return!1;for(;r<n;r++)0===r?t.val(o[r]):this.initialisation||!this.multiple_max||this.currentValAmount<this.multiple_max?t=this.insert_item(t,o[r]):(e=t.next("input")).length&&!e.innerHTML&&(this.remove_item(e),t=this.insert_item(t,o[r]));return t},Charcoal.Admin.Property_Input_Text.prototype.bind_keyboard_events=function(t){var i=this,o=this.chars_new,r=this.chars_remove,n=this.char_next,a=this.char_prev;t.on("keydown",function(t){var e=t.keyCode;-1<o.indexOf(e)&&(!i.multiple_max||i.currentValAmount<i.multiple_max)&&(t.preventDefault(),i.insert_item($(this)).focus()),-1<r.indexOf(e)&&(!i.multiple_min||i.currentValAmount>i.multiple_min)&&""===$(this).val()&&(t.preventDefault(),i.remove_item($(this))),-1<a.indexOf(e)&&(t.preventDefault(),$(this).prev("input").focus()),-1<n.indexOf(e)&&(t.preventDefault(),$(this).next("input").focus())}),t.on("keyup",function(){var t=i.split_val($(this));t&&t.focus()})},Charcoal.Admin.Property_Input_Text.prototype.insert_item=function(t,e){e=this.input_clone(e);return e.insertAfter(t),this.bind_keyboard_events(e),this.currentValAmount++,e},Charcoal.Admin.Property_Input_Text.prototype.add_item=function(t){t=this.input_clone(t);return this.$container.append(t),this.bind_keyboard_events(t),this.currentValAmount++,t},Charcoal.Admin.Property_Input_Text.prototype.remove_item=function(t){var e=t.prev("input"),i=t.next("input");return!(!e.length&&!i.length)&&(e.length?e.focus():i.length&&i.focus(),this.remove_item_listeners(t),t.remove(),this.currentValAmount--,this)},Charcoal.Admin.Property_Input_Text.prototype.remove_item_listeners=function(t){return t.off("keydown"),t.off("keyup"),this},Charcoal.Admin.Property_Input_Text.prototype.input_clone=function(t){var e=this.$input,i=e.attr("class"),e=e.attr("type"),o=this.min_length,r=this.max_length,n=this.required,a=this.readonly,s=this.input_name,l=$("<input />");return e&&l.attr("type",e),i&&l.attr("class",i),o&&l.attr("minlength",o),r&&l.attr("maxlength",r),n&&l.attr("required","required"),a&&l.attr("readonly","readonly"),t&&l.val(t),l.attr("name",s),l},Charcoal.Admin.Property_Input_Text.prototype.set_input_id=function(t){return this.input_id=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_input_name=function(t){return this.input_name=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_input_val=function(t){return this.input_val=t,this},Charcoal.Admin.Property_Input_Text.prototype.set_readonly=function(t){return this.readonly=t=t||!1,this},Charcoal.Admin.Property_Input_Text.prototype.set_required=function(t){return this.required=t=t||!1,this},Charcoal.Admin.Property_Input_Text.prototype.set_min_length=function(t){return this.min_length=t=t||0,this},Charcoal.Admin.Property_Input_Text.prototype.set_max_length=function(t){return this.max_length=t=t||0,this},Charcoal.Admin.Property_Input_Text.prototype.set_size=function(t){return this.size=t=t||0,this},Charcoal.Admin.Property_Input_Text.prototype.set_multiple=function(t){return this.multiple=t=t||!1,this},Charcoal.Admin.Property_Input_Text.prototype.set_multiple_min=function(t){return this.multiple_min=t=t||!1,this},Charcoal.Admin.Property_Input_Text.prototype.set_multiple_max=function(t){return this.multiple_max=t=t||!1,this},Charcoal.Admin.Property_Input_Text.prototype.set_multiple_separator=function(t){return this.multiple_separator=t=t||",",this},Charcoal.Admin.Property_Input_Text.prototype.set_split_on=function(t){if(t){if("array"===$.type(t)){for(var e=t.length-1;0<=e;e--)switch(t[e]){case"comma":t[e]="\\s*,\\s*";break;case"tab":t[e]="\\t+";break;case"newline":t[e]="[\\n\\r]+";break;default:t[e]=t[e].replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}t=t.join("|")}t=new RegExp(t)}else t=this.multiple_separator;return this.split_on=t,this},Charcoal.Admin.Property_Input_Text.prototype.destroy=function(){},$(document).on("focusin",function(t){$(t.target).closest(".tox-tinymce-aux, .moxman-window, .tam-assetmanager-root").length&&t.stopImmediatePropagation()}),Charcoal.Admin.Property_Input_Tinymce=function(t){Charcoal.Admin.Property.call(this,t),this.input_type="charcoal/admin/property/input/tinymce",this.input_id=null,this.data=t.data,this.editor_options=null,this._editor=null,window.elFinderCallback||(window.elFinderCallback={}),this.set_properties(t),this.init()},Charcoal.Admin.Property_Input_Tinymce.prototype=Object.create(Charcoal.Admin.Property.prototype),Charcoal.Admin.Property_Input_Tinymce.prototype.constructor=Charcoal.Admin.Property_Input_Tinymce,Charcoal.Admin.Property_Input_Tinymce.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Tinymce.prototype.init=function(){this.create_tinymce()},Charcoal.Admin.Property_Input_Tinymce.prototype.base_url=function(){return Charcoal.Admin.base_url()+"assets/admin/tinymce"},Charcoal.Admin.Property_Input_Tinymce.prototype.set_properties=function(t){this.input_id=t.input_id||this.input_id,this.editor_options=t.editor_options||t.data.editor_options||this.editor_options,window.elFinderCallback[this.input_id]=this.elfinder_callback.bind(this);var t=Charcoal.Admin.locale().match(/([a-zA-Z]{2})(_|-)([a-zA-Z]{2})/)[0]||"en",r={language:t=(t=t.replace("-","_")).match(/en_/)?"en":t,plugins:["advlist","autolink","autoresize","charcoal","charmap","code","fullscreen","hr","image","link","lists","media","nonbreaking","noneditable","paste","placeholder","quickbars","searchreplace","tabfocus","table","visualblocks","visualchars","wordcount"],toolbar:["undo redo","styleselect","bold italic","alignleft aligncenter alignright alignjustify","bullist numlist","outdent indent","link image"].join(" | "),contextmenu:["link linkchecker image imagetools table"].join(" | "),browser_spellcheck:!0,end_container_on_empty_block:!0,entity_encoding:"raw",allow_conditional_comments:!0,forced_root_block:"p",allow_script_urls:!1,document_base_url:Charcoal.Admin.base_url(),relative_urls:!0,remove_script_host:!1,min_height:"150px",max_height:"400px",file_picker_callback:$.proxy(this.elfinder_browser,null,this),image_advtab:!0,importcss_append:!0,media_alt_source:!1,nonbreaking_force_tab:!1,paste_data_images:!0,paste_as_text:!0,paste_merge_formats:!0,root_lang_attr:$("#"+this.input_id).closest("[data-lang]").data("lang"),table_grid:!0,table_tab_navigation:!0,visualblocks_default_state:!1,automatic_uploads:!0,images_upload_url:"tinymce/upload/image"};return"plugins"in r&&"plugins"in this.editor_options&&("string"===$.type(this.editor_options.plugins)&&(this.editor_options.plugins=this.editor_options.plugins.split(" ")),$.each(this.editor_options.plugins,function(t,e){var i,o=0===e.indexOf("!");if(o&&(e=e.slice(1)),o)for(;-1<(i=r.plugins.indexOf(e));)delete r.plugins[i];else-1===r.plugins.indexOf(e)&&r.plugins.push(e)}),delete this.editor_options.plugins),this.editor_options=$.extend({},r,this.editor_options),this.editor_options.selector="#"+this.input_id,this.editor_options.setup=function(t){t.on("change",function(){window.tinymce.triggerSave()})},this},Charcoal.Admin.Property_Input_Tinymce.prototype.create_tinymce=function(){var t,e=this;if("object"!=typeof window.tinyMCE)return t=this.base_url()+"/tinymce.min.js",Charcoal.Admin.loadScript(t,this.create_tinymce.bind(this)),this;window.tinyMCE.dom.Event.domLoaded=!0,window.tinyMCE.baseURI=new window.tinyMCE.util.URI(this.base_url()),window.tinyMCE.baseURL=this.base_url(),window.tinyMCE.suffix=".min",window.tinyMCE.PluginManager.get(this.input_id)||(window.tinyMCE.PluginManager.add(this.input_id,function(t){e.set_editor(t)}),"array"!==$.type(this.editor_options.plugins)&&(this.editor_options.plugins=[]),this.editor_options.plugins.push(this.input_id)),window.tinyMCE.init(this.editor_options)},Charcoal.Admin.Property_Input_Tinymce.prototype.elfinder_callback=function(t,e){this.elfinder_dialog?(this.elfinder_dialog.onInsert(t,e),this.elfinder_dialog.close()):(window.parent.alert("Something went wrong. Could not insert file."),window.parent.postMessage({mceAction:"close"}))},Charcoal.Admin.Property_Input_Tinymce.prototype.elfinder_browser=function(t,n,e,a){var s=this;return t.elfinder_dialog=window.tinyMCE.activeEditor.windowManager.openUrl({url:t.data.elfinder_url+"&"+$.param(a),title:t.data.dialog_title||"",width:900,height:450}),t.elfinder_dialog.onInsert=function(t,e){for(var i,o=t.url,r=/\/[^/]+?\/\.\.\//;o.match(r);)o=o.replace(r,"/");0===(i=s.selection.getContent()).length&&"A"===s.selection.getNode().nodeName&&(i=s.selection.getNode().textContent),e=t.name+" ("+e.formatSize(t.size)+")","file"===a.filetype&&n(o,{text:i||e,title:e}),"image"===a.filetype&&n(o,{alt:e}),"media"===a.filetype&&n(o)},console.log("Dialog:",t.elfinder_dialog),console.groupEnd(),!1},Charcoal.Admin.Property_Input_Tinymce.prototype.set_editor=function(t){return this._editor=t,this},Charcoal.Admin.Property_Input_Tinymce.prototype.editor=function(){return this._editor},Charcoal.Admin.Property_Input_Tinymce.prototype.destroy=function(){var t=this.editor();t&&t.remove()},Charcoal.Admin.Property_Input_Video=function(t){this.EVENT_NAMESPACE=Charcoal.Admin.Property_Input_Video.EVENT_NAMESPACE,this.input_type="charcoal/admin/property/input/video",Charcoal.Admin.Property.call(this,t),this.data=t.data,this.dialog=null,this.set_input_id(t.id).init()},Charcoal.Admin.Property_Input_Video.EVENT_NAMESPACE=".charcoal.property.video",Charcoal.Admin.Property_Input_Video.prototype=Object.create(Charcoal.Admin.Property_Input_File.prototype),Charcoal.Admin.Property_Input_Video.prototype.constructor=Charcoal.Admin.Property_Input_Video,Charcoal.Admin.Property_Input_Video.prototype.parent=Charcoal.Admin.Property.prototype,Charcoal.Admin.Property_Input_Video.prototype.change_file=function(t){var e,i;this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none"),this.$previewText.empty(),this.$previewFile.empty(),t.target&&t.target.files&&t.target.files[0]&&(e=t.target.files[0],(i=new FileReader).addEventListener("loadend",function(){var t=document.createElement("video");console.log("[Property_Input_Video.change_file]",e),t.innerHTML=videoPropertyL10n.unsupportedElement,t.style="max-width: 100%",t.controls=!0,t.title=e.name,t.src=i.result,t.load(),this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$previewFile.append(t),this.$previewText.html(e.name)}.bind(this),!1),i.readAsDataURL(e))},Charcoal.Admin.Property_Input_Video.prototype.elfinder_callback=function(t){var e,i;this.dialog&&this.dialog.close(),this.$input.find(".hide-if-no-file").addClass("d-none"),this.$input.find(".show-if-no-file").removeClass("d-none"),this.$previewText.empty(),this.$previewFile.empty(),t&&t.url&&(e=decodeURI(t.url).replace(Charcoal.Admin.base_url(),""),i=$('<video controls src="'+t.url+'" class="js-file-video" style="max-width: 100%">'+videoPropertyL10n.unsupportedElement+"</video>"),console.log("[Property_Input_Video.elfinder_callback]",t),this.$hidden.val(e),this.$input.find(".hide-if-no-file").removeClass("d-none"),this.$input.find(".show-if-no-file").addClass("d-none"),this.$previewText.html(t.name),this.$previewFile.append(i))},Charcoal.Admin.Template=function(t){return Charcoal.Admin.Component.call(this,t),this},Charcoal.Admin.Template.prototype=Object.create(Charcoal.Admin.Component.prototype),Charcoal.Admin.Template.prototype.constructor=Charcoal.Admin.Template,Charcoal.Admin.Template.prototype.parent=Charcoal.Admin.Component.prototype,Charcoal.Admin.Template_Login=function(t){this.template_type="charcoal/admin/template/login",this.init(t)},Charcoal.Admin.Template_Login.prototype=Object.create(Charcoal.Admin.Template.prototype),Charcoal.Admin.Template_Login.prototype.constructor=Charcoal.Admin.Template_Login,Charcoal.Admin.Template_Login.prototype.parent=Charcoal.Admin.Template.prototype,Charcoal.Admin.Template_Login.prototype.init=function(){this.bind_events()},Charcoal.Admin.Template_Login.prototype.bind_events=function(){var t=$("#login-form");t.on("submit.charcoal.login",$.proxy(this.onSubmit,this)),window.CharcoalCaptchaLoginCallback=this.submitForm.bind(this,t)},Charcoal.Admin.Template_Login.prototype.onSubmit=function(t){t.preventDefault();var t=$(t.currentTarget),e=Charcoal.Admin.recaptcha();e.hasInvisibleWidget(t,"#g-recaptcha-challenge")?e.getApi().execute():this.submitForm.call(this,t)},Charcoal.Admin.Template_Login.prototype.submitForm=function(t){var r=this,e=t.prop("action")||window.location.href,t=t.serialize(),i=Charcoal.Admin.queryParams();"redirect_to"in i&&(t=t.concat("&next_url="+encodeURIComponent(i.redirect_to))),$.post(e,t,Charcoal.Admin.resolveJqXhrFalsePositive.bind(this),"json").done(function(t){function e(){window.location.href=i}var i=t.next_url||Charcoal.Admin.admin_url(),t=r.parseFeedbackAsHtml(t)||authL10n.authSuccess;t+="<p>"+authL10n.postLoginRedirect+" "+authL10n.postLoginFallback.replace("[[ url ]]",i)+"</p>",BootstrapDialog.show({title:authL10n.loginTitle,message:t,type:BootstrapDialog.TYPE_SUCCESS,onhidden:e}),setTimeout(e,300)}).fail(function(t,e,i){var t=Charcoal.Admin.parseJqXhrResponse(t,e,i),e=r.parseFeedbackAsHtml(t)||authL10n.authFailed,o=Charcoal.Admin.recaptcha(),i=null;o.hasApi()&&(i=function(){o.getApi().reset()}),BootstrapDialog.show({title:authL10n.loginTitle,message:e,type:BootstrapDialog.TYPE_DANGER,onhidden:i})})},Charcoal.Admin.Template_Login.prototype.parseFeedbackAsHtml=function(t){if(t.feedbacks&&(t=t.feedbacks),!1===Array.isArray(t)||0===t.length)return null;if(0===t.length)return null;var e,t=Charcoal.Admin.feedback(t),i=t.getMessagesMap(),o="<p>";for(e in i)o+=i[e].join("</p><p>");return o+="</p>",t.empty(),"<p></p>"===o?null:o},Charcoal.Admin.Template_MenuHeader=function(){$(".js-toggle-class").click(function(t){t.preventDefault();var t=$(this),e=t.data("class"),t=t.data("target");$(t).toggleClass(e)}),$(document).on("click",".js-accordion-header",function(t){t.preventDefault(),$(this).toggleClass("is-open").siblings(".js-accordion-content").stop().slideToggle()})},Charcoal.Admin.Template_Account_LostPassword=function(t){this.template_type="charcoal/admin/template/account/lost-password",this.init(t)},Charcoal.Admin.Template_Account_LostPassword.prototype=Object.create(Charcoal.Admin.Template.prototype),Charcoal.Admin.Template_Account_LostPassword.prototype.constructor=Charcoal.Admin.Template_Account_LostPassword,Charcoal.Admin.Template_Account_LostPassword.prototype.parent=Charcoal.Admin.Template.prototype,Charcoal.Admin.Template_Account_LostPassword.prototype.init=function(t){window.console.debug(t),this.bind_events()},Charcoal.Admin.Template_Account_LostPassword.prototype.bind_events=function(){var t=$("#lost-password-form");t.on("submit.charcoal.password",$.proxy(this.onSubmit,this)),window.CharcoalCaptchaResetPassCallback=this.submitForm.bind(this,t)},Charcoal.Admin.Template_Account_LostPassword.prototype.onSubmit=Charcoal.Admin.Template_Login.prototype.onSubmit,Charcoal.Admin.Template_Account_LostPassword.prototype.parseFeedbackAsHtml=Charcoal.Admin.Template_Login.prototype.parseFeedbackAsHtml,Charcoal.Admin.Template_Account_LostPassword.prototype.submitForm=function(t){var r=this,e=t.prop("action")||window.location.href,t=t.serialize();$.post(e,t,Charcoal.Admin.resolveJqXhrFalsePositive.bind(this),"json").done(function(t){var e=r.parseFeedbackAsHtml(t)||authL10n.lostPassSuccess;BootstrapDialog.show({title:authL10n.lostPassword,message:e,type:BootstrapDialog.TYPE_SUCCESS,onhidden:function(){window.location.href=t.next_url||Charcoal.Admin.admin_url("login?notice=resetpass")}})}).fail(function(t,e,i){var t=Charcoal.Admin.parseJqXhrResponse(t,e,i),e=r.parseFeedbackAsHtml(t)||authL10n.lostPassFailed,o=Charcoal.Admin.recaptcha(),i=null;o.hasApi()&&(i=function(){o.getApi().reset()}),BootstrapDialog.show({title:authL10n.lostPassword,message:e,type:BootstrapDialog.TYPE_DANGER,onhidden:i})})},Charcoal.Admin.Template_Account_ResetPassword=function(t){this.template_type="charcoal/admin/template/account/reset-password",this.init(t)},Charcoal.Admin.Template_Account_ResetPassword.prototype=Object.create(Charcoal.Admin.Template.prototype),Charcoal.Admin.Template_Account_ResetPassword.prototype.constructor=Charcoal.Admin.Template_Account_ResetPassword,Charcoal.Admin.Template_Account_ResetPassword.prototype.parent=Charcoal.Admin.Template.prototype,Charcoal.Admin.Template_Account_ResetPassword.prototype.init=function(t){window.console.debug(t),this.bind_events()},Charcoal.Admin.Template_Account_ResetPassword.prototype.bind_events=function(){var t=$("#reset-password-form");t.on("submit.charcoal.password",$.proxy(this.onSubmit,this)),window.CharcoalCaptchaChangePassCallback=this.submitForm.bind(this,t)},Charcoal.Admin.Template_Account_ResetPassword.prototype.onSubmit=Charcoal.Admin.Template_Login.prototype.onSubmit,Charcoal.Admin.Template_Account_ResetPassword.prototype.parseFeedbackAsHtml=Charcoal.Admin.Template_Login.prototype.parseFeedbackAsHtml,Charcoal.Admin.Template_Account_ResetPassword.prototype.submitForm=function(t){var r=this,e=t.prop("action")||window.location.href,t=t.serialize();$.post(e,t,Charcoal.Admin.resolveJqXhrFalsePositive.bind(this),"json").done(function(t){var e=r.parseFeedbackAsHtml(t)||authL10n.resetPassSuccess;BootstrapDialog.show({title:authL10n.passwordReset,message:e,type:BootstrapDialog.TYPE_SUCCESS,onhidden:function(){window.location.href=t.next_url||Charcoal.Admin.admin_url("login?notice=newpass")}})}).fail(function(t,e,i){var t=Charcoal.Admin.parseJqXhrResponse(t,e,i),e=r.parseFeedbackAsHtml(t)||authL10n.resetPassFailed,o=Charcoal.Admin.recaptcha(),i=null;o.hasApi()&&(i=function(){o.getApi().reset()}),BootstrapDialog.show({title:authL10n.passwordReset,message:e,type:BootstrapDialog.TYPE_DANGER,onhidden:i})})};